{"meta":{"title":"NBMA","subtitle":"学习 记录 分享","description":"重建了很多次的blog","author":"Mansur","url":"http://nbma.info","root":"/"},"pages":[{"title":"about","date":"un44fin44","updated":"un66fin66","comments":false,"path":"about/index.html","permalink":"http://nbma.info/about/index.html","excerpt":"","text":""},{"title":"categories","date":"un44fin44","updated":"un66fin66","comments":false,"path":"categories/index.html","permalink":"http://nbma.info/categories/index.html","excerpt":"","text":""},{"title":"2018-target","date":"un66fin66","updated":"un66fin66","comments":true,"path":"2018-target/index.html","permalink":"http://nbma.info/2018-target/index.html","excerpt":"","text":"二层:STP/RSTP/MSTP802.1X链路聚合 三层:静态路由PBRECMPOSPFISISBGP VPN:PPTPL2TPGRESSL VPNIPSec VPN ip Service:QoSHSRP/VRRPNQABFDdhcp、snooping、arp检测 网络监控:snmpnetflowZabbix+Grafana 无线：802.11a/b/g/n/ac wava2协议802.11原理和调优EAP/PEAP/TSL认证原理EAP+TSL企业级wifi证书部署原理mac认证/portal认证/802.1X认证radius 传输：SDHMSTPPTNOTNWDM 售前：企业级多协议多出口多业务设计规划部署负载均衡出口自动切换流量调度 光：单模多模波分传输，线路开通 DC：leaf-spine架构VxlanSDNNFV 其他：RouterOSF5/A10等LBAnsibleDNS服务器IPv6了解厂商特点，对标产品 协议：httpstcp"},{"title":"","date":"un22fin22","updated":"un55fin55","comments":true,"path":"js/post_date.js","permalink":"http://nbma.info/js/post_date.js","excerpt":"","text":"(function() { var times = document.getElementsByTagName('time'); if (times.length === 0) { return; } var posts = document.getElementsByClassName('post-content'); if (posts.length === 0) { return; } var pubTime = new Date(times[0].dateTime); /* 文章发布时间戳 */ var now = Date.now() /* 当前时间戳 */ var interval = parseInt(now - pubTime) /* 发布时间超过指定时间（毫秒） */ if (interval > 3600*24*30*1000){ var days = parseInt(interval / 86400000) posts[0].innerHTML = '' + '文章时效性提示这是一篇发布于 ' + days + ' 天前的文章，部分信息可能已发生改变，请注意甄别。' + '' + posts[0].innerHTML; } })();"},{"title":"tags","date":"un66fin66","updated":"un66fin66","comments":false,"path":"tags/index.html","permalink":"http://nbma.info/tags/index.html","excerpt":"","text":""}],"posts":[{"title":"收集来的一些公司的IP范围","slug":"ip-range-of-some-corp","date":"un22fin22","updated":"un22fin22","comments":true,"path":"ip-range-of-some-corp/","link":"","permalink":"http://nbma.info/ip-range-of-some-corp/","excerpt":"作用未知，纯粹好玩","text":"作用未知，纯粹好玩 Google早期google并没有公开自己对外提供服务的ip，前段时间看应该是更新了，可以直接通过下面这个url获取： https://www.gstatic.com/ipranges/goog.json 亚马逊AWS作为最大的云计算公司，亚马逊还是很给力的，他的IP范围在上面的网址中也有，另外它官方也公布了每个region的ip段： https://ip-ranges.amazonaws.com/ip-ranges.json 微软Azura同样微软也公开了自己的数据中心的IP范围，官网可以下载：https://www.microsoft.com/en-us/download/details.aspx?id=41653 另外Azura中国区是世纪互联运营，不含在全球版里的ip： https://www.microsoft.com/en-us/download/details.aspx?id=42064 line基于业务需求，公司需要访问line，所以找了下这个公司的IP范围，然后发现了两个很有意思的网址 https://host.io/linecorp.com host.io可以查询域名所在的公司，已经对应的AS https://ipinfo.io/AS38631 ipinfo.io可以查询AS对应的公司和包含的IPv4/IPv6范围 其他公司参照Google，我是从这个网站拿到的IP子网的范围。格式例如这样的，写了子网的第一个地址和最后一个地址，但是没写掩码： 12364.18.0.0 64.18.15.255207.126.144.0 207.126.159.255104.132.0.0 104.132.27.255 先拿excel简单处理下原数据，排序之后，然后拿python简单处理下得到网络号和掩码，人肉过滤下重复的子网。 python的netaddr和ipaddr可以直接处理IP，我这里用是python3内置的ipaddresss。summarize_address_range(ip1,ip2)会输出包含ip1起始到ip2这个范围内的所有子网。 12345678910from ipaddress import *if __name__ == &#x27;__main__&#x27;: with open(&#x27;ipi&#x27;, &#x27;r&#x27;) as f: for line in f.readlines(): ip_list = line.split(&#x27;\\n&#x27;)[0].split(&#x27; &#x27;) ip1 = IPv4Address(ip_list[0]) ip2 = IPv4Address(ip_list[1]) for x in summarize_address_range(ip1,ip2): print(x) 最终结果不一定就完全准确，但是覆盖80%的业务应该可以吧。。 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021038.6.48.0&#x2F;218.8.4.0&#x2F;248.8.8.0&#x2F;248.15.202.0&#x2F;248.34.208.0&#x2F;208.35.192.0&#x2F;2012.216.80.0&#x2F;2423.228.128.0&#x2F;1823.236.48.0&#x2F;2023.251.128.0&#x2F;1923.255.128.0&#x2F;1734.64.0.0&#x2F;1035.184.0.0&#x2F;1335.192.0.0&#x2F;1135.224.0.0&#x2F;1235.240.0.0&#x2F;1335.206.0.0&#x2F;1535.208.0.0&#x2F;1238.97.108.0&#x2F;2445.121.228.0&#x2F;2245.56.0.0&#x2F;1863.243.168.0&#x2F;2264.15.112.0&#x2F;2064.18.0.0&#x2F;2064.233.160.0&#x2F;1964.79.152.0&#x2F;2364.9.224.0&#x2F;1966.102.0.0&#x2F;2066.249.64.0&#x2F;1970.32.128.0&#x2F;1972.14.192.0&#x2F;1874.114.24.0&#x2F;2174.125.0.0&#x2F;1689.207.224.0&#x2F;2199.198.128.0&#x2F;17103.62.64.0&#x2F;22103.86.148.0&#x2F;24104.132.0.0&#x2F;14104.154.0.0&#x2F;15104.196.0.0&#x2F;14104.237.161.0&#x2F;24104.237.162.0&#x2F;23104.237.164.0&#x2F;23104.237.172.0&#x2F;24104.237.174.0&#x2F;23104.237.188.0&#x2F;22107.167.160.0&#x2F;19107.178.192.0&#x2F;18107.188.128.0&#x2F;17108.170.192.0&#x2F;18108.177.0.0&#x2F;17108.59.80.0&#x2F;20113.197.104.0&#x2F;22130.211.0.0&#x2F;16136.112.0.0&#x2F;12136.22.0.0&#x2F;23136.22.129.0&#x2F;24136.22.159.0&#x2F;24136.22.64.0&#x2F;18136.32.0.0&#x2F;11142.250.0.0&#x2F;15146.148.0.0&#x2F;17159.192.27.0&#x2F;24162.216.148.0&#x2F;22162.222.176.0&#x2F;21165.193.245.0&#x2F;24172.102.8.0&#x2F;21172.110.32.0&#x2F;21172.217.0.0&#x2F;16172.253.0.0&#x2F;16173.194.0.0&#x2F;16173.255.112.0&#x2F;20185.150.148.0&#x2F;22185.25.28.0&#x2F;22192.104.160.0&#x2F;23192.119.16.0&#x2F;20192.158.28.0&#x2F;22192.178.0.0&#x2F;15192.200.224.0&#x2F;19199.192.112.0&#x2F;22199.223.232.0&#x2F;21199.36.152.0&#x2F;21199.91.151.0&#x2F;24203.190.122.0&#x2F;24207.126.144.0&#x2F;20207.223.160.0&#x2F;20207.251.96.0&#x2F;24208.117.224.0&#x2F;19208.211.225.0&#x2F;24208.65.152.0&#x2F;22208.68.108.0&#x2F;22208.81.188.0&#x2F;22209.107.176.0&#x2F;20209.210.68.0&#x2F;23209.62.176.0&#x2F;20209.63.122.0&#x2F;23209.63.62.0&#x2F;23209.85.128.0&#x2F;17216.21.160.0&#x2F;20216.239.32.0&#x2F;19216.252.220.0&#x2F;22216.58.192.0&#x2F;19216.73.80.0&#x2F;20","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"ip","slug":"ip","permalink":"http://nbma.info/tags/ip/"}]},{"title":"一些有意思的项目","slug":"some-interesting-projects","date":"un66fin66","updated":"un22fin22","comments":true,"path":"some-interesting-projects/","link":"","permalink":"http://nbma.info/some-interesting-projects/","excerpt":"收藏到浏览器书签时间长就忘了，star多了也懒得翻，还是记这吧。","text":"收藏到浏览器书签时间长就忘了，star多了也懒得翻，还是记这吧。 目前最好用的网络资源管理系统netbox-community/netbox 目前最好用的网络配置备份工具ytti/oxidized 一个正在快速迭代的自动化网管系统afourmy/eNMS 结合了napalm和testfsm的api工具tbotnz / netpalm 一个网络监控的小工具(支持NetFlow IPFIX sFlow libpcap BGP BMP RPKI IGP Streaming Telemetry)pmacct / pmacct 一个纯python的自动化框架（好像类似ansible，思科有篇博客介绍nornir-automation/nornir 基于nornir实现的的自动化网管系统，可以对接netbox、oxidizedSUNET/cnaas-nms 一个纯python实现的网络配置备份系统,似乎数据源依赖nornirrackerlabs/stockpiler bgp监控程序osrg/gobgp flask实现的bgp路由监控(仿照gobgp)rhicks/bgp-dashboard 基于yaml格式的文本上传svg格式的拓扑文件drawthe.netcidrblock/drawthe.net python和shell实现的网线流量分析系统、可以抓取pcap文件和分析zeek日志idaholab/Malcolm 网络流量回溯系统，可以查看导出pcap文件aol/moloch python实现并更新的smokping20c/vaping 雅虎的udpingyahoo/UDPing","categories":[{"name":"收藏分享","slug":"收藏分享","permalink":"http://nbma.info/categories/%E6%94%B6%E8%97%8F%E5%88%86%E4%BA%AB/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"}]},{"title":"优化MacOS的Anyconnect安装包","slug":"redeploy-anyconnect-for-macos","date":"un22fin22","updated":"un22fin22","comments":true,"path":"redeploy-anyconnect-for-macos/","link":"","permalink":"http://nbma.info/redeploy-anyconnect-for-macos/","excerpt":"Mac系统的Anyconnect Predeploy安装包中集成了VPN、Web Security、Diagnostics and Reporting Tool、AMP Enabler、Posture、ISE Posture、Network Visibility、Umbrella Roaming Security组件，在正常的安装过程中，这些组件都是默认勾选安装的。","text":"Mac系统的Anyconnect Predeploy安装包中集成了VPN、Web Security、Diagnostics and Reporting Tool、AMP Enabler、Posture、ISE Posture、Network Visibility、Umbrella Roaming Security组件，在正常的安装过程中，这些组件都是默认勾选安装的。 虽然安装过程很简单，但是难免有傻X用户看都不看直接下一步，所以我决定优化一下客户端。 最开始的思路是先从官方找，除了Predeploy版本外，官方还提供了Web deploy版本，这两个版本的区别在于Web deploy用于上传到ASA内部，用户从web端访问VPN的时候自动部署anyconnect软件；Pre Deploy是用于预先部署的单独安装包。 官方的anyconnect手册中写了如何通过ASDM定制安装包，但是经过测试ASDM仅支持windows版的定制，手册也没有提供macOS版的相关参数。不过在手册的#Disable the Customer Experience Feedback Module章节发现了一段描述可以把dmg文件从只读转换为可读写。 Convert the dmg package from read-only to read-write using Disk Utility or hdiutil. For example: hdiutil convert anyconnect-macosx-i386-ver-k9.dmg -format UDRW -o anyconnect-macosx-i386-ver-k9-rw.dmg 那么新的思路就是修改dmg文件包的内容，再重新打包。首先是打开anyconnect-macos-4.7.01076-predeploy-k9.dmg，把Anyconnect.pkg复制出来。使用pkgutil工具解压，目录结构如下： 1234567891011121314$ pkgutil --expand AnyConnect.pkg anyconnect$ tree -L 1 anyconnectanyconnect├── Distribution├── Resources├── dart_module.pkg├── fireamp_module.pkg├── iseposture_module.pkg├── nvm_module.pkg├── posture_module.pkg├── umbrella_module.pkg├── vpn_module.pkg└── websecurity_module.pkg Distribution是安装过程中的配置文件Resources是安装过程中的字体、license服务协议、背景图片等资源其他的pkg就是各个组件了。 优化的办法就删掉其他pkg，只保留vpn_module.pkg。然后在修改Distribution，注释或者删掉其他组件的调用： 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; standalone=&quot;yes&quot;?&gt;&lt;installer-gui-script minSpecVersion=&quot;1&quot;&gt; &lt;title&gt;AnyConnect Secure Mobility Client&lt;/title&gt; &lt;background file=&quot;pkg_background.png&quot; scaling=&quot;proportional&quot; alignment=&quot;bottomleft&quot;/&gt; &lt;license file=&quot;License.rtf&quot;/&gt; &lt;options customize=&quot;always&quot; rootVolumeOnly=&quot;true&quot; hostArchitectures=&quot;i386&quot;/&gt; &lt;choices-outline&gt; &lt;line choice=&quot;choice_vpn&quot;/&gt;&lt;!-- &lt;line choice=&quot;choice_websecurity&quot;/&gt; &lt;line choice=&quot;choice_fireamp&quot;/&gt; &lt;line choice=&quot;choice_dart&quot;/&gt; &lt;line choice=&quot;choice_posture&quot;/&gt; &lt;line choice=&quot;choice_iseposture&quot;/&gt; &lt;line choice=&quot;choice_nvm&quot;/&gt; &lt;line choice=&quot;choice_umbrella&quot;/&gt; --&gt; &lt;/choices-outline&gt; &lt;choice id=&quot;choice_vpn&quot; start_enabled=&quot;enable_module()&quot; enabled=&quot;choice_vpn_enabled()&quot; start_selected=&quot;check_upgrade()&quot; selected=&quot;choice_vpn_selected()&quot; title=&quot;VPN&quot; description=&quot;Installs the module that enables VPN capabilities.&quot;&gt; &lt;pkg-ref id=&quot;com.cisco.pkg.anyconnect.vpn&quot;/&gt; &lt;/choice&gt;&lt;!-- &lt;choice id=&quot;choice_websecurity&quot; start_selected=&quot;check_upgrade()&quot; start_enabled=&quot;enable_module()&quot; title=&quot;Web Security&quot; description=&quot;Installs the WebSecurity module that enables cloud scanning of web content to protect against malware and enforce acceptable use policies via the ScanSafe cloud proxies.&quot;&gt; &lt;pkg-ref id=&quot;com.cisco.pkg.anyconnect.websecurity_v2&quot;/&gt; &lt;/choice&gt; &lt;choice id=&quot;choice_dart&quot; start_selected=&quot;check_upgrade()&quot; start_enabled=&quot;enable_module()&quot; title=&quot;Diagnostics and Reporting Tool&quot; description=&quot;Installs the diagnostics module that collects AnyConnect Secure Mobility Client troubleshooting information.&quot;&gt; &lt;pkg-ref id=&quot;com.cisco.pkg.anyconnect.dart&quot;/&gt; &lt;/choice&gt; &lt;choice id=&quot;choice_fireamp&quot; start_selected=&quot;check_upgrade()&quot; start_enabled=&quot;enable_module()&quot; title=&quot;AMP Enabler&quot; description=&quot;Installs the AMP Enabler module that downloads and deploys AMP for Endpoints, as configured by the administrator.&quot;&gt; &lt;pkg-ref id=&quot;com.cisco.pkg.anyconnect.fireamp&quot;/&gt; &lt;/choice&gt; &lt;choice id=&quot;choice_posture&quot; start_selected=&quot;check_upgrade()&quot; start_enabled=&quot;enable_module()&quot; title=&quot;Posture&quot; description=&quot;Installs the module that provides the AnyConnect Secure Mobility Client with the ability to identify the operating system, antivirus, antispyware, and firewall software installed on the host prior to creating a remote access connection to the secure gateway.&quot;&gt; &lt;pkg-ref id=&quot;com.cisco.pkg.anyconnect.posture&quot;/&gt; &lt;/choice&gt; &lt;choice id=&quot;choice_iseposture&quot; start_selected=&quot;check_upgrade()&quot; start_enabled=&quot;enable_module()&quot; title=&quot;ISE Posture&quot; description=&quot;Installs the module that provides the AnyConnect Secure Mobility Client with the functionality needed to authenticate to wired or wireless networks controlled by the Identity Services Engine, including examination and any needed remediation of the connecting host environment.&quot;&gt; &lt;pkg-ref id=&quot;com.cisco.pkg.anyconnect.iseposture&quot;/&gt; &lt;/choice&gt; &lt;choice id=&quot;choice_nvm&quot; start_selected=&quot;check_upgrade()&quot; start_enabled=&quot;enable_module()&quot; title=&quot;Network Visibility&quot; description=&quot;Installs the Network Visibility Module which collects application telemetry data.&quot;&gt; &lt;pkg-ref id=&quot;com.cisco.pkg.anyconnect.nvm_v2&quot;/&gt; &lt;/choice&gt; &lt;choice id=&quot;choice_umbrella&quot; start_selected=&quot;check_upgrade()&quot; start_enabled=&quot;enable_module()&quot; title=&quot;Umbrella Roaming Security&quot; description=&quot;Installs the module that enables Umbrella Roaming Security.&quot;&gt; &lt;pkg-ref id=&quot;com.cisco.pkg.anyconnect.umbrella&quot;/&gt; &lt;/choice&gt; --&gt; &lt;pkg-ref id=&quot;com.cisco.pkg.anyconnect.vpn&quot; version=&quot;4.7.01076&quot; installKBytes=&quot;22150&quot;&gt;#vpn_module.pkg&lt;/pkg-ref&gt;&lt;!-- &lt;pkg-ref id=&quot;com.cisco.pkg.anyconnect.dart&quot; version=&quot;4.7.01076&quot; installKBytes=&quot;4608&quot;&gt;#dart_module.pkg&lt;/pkg-ref&gt; &lt;pkg-ref id=&quot;com.cisco.pkg.anyconnect.websecurity_v2&quot; version=&quot;4.7.01076&quot; installKBytes=&quot;3052&quot;&gt;#websecurity_module.pkg&lt;/pkg-ref&gt; &lt;pkg-ref id=&quot;com.cisco.pkg.anyconnect.fireamp&quot; version=&quot;4.7.01076&quot; installKBytes=&quot;786&quot;&gt;#fireamp_module.pkg&lt;/pkg-ref&gt; &lt;pkg-ref id=&quot;com.cisco.pkg.anyconnect.posture&quot; version=&quot;4.7.01076&quot; installKBytes=&quot;51264&quot;&gt;#posture_module.pkg&lt;/pkg-ref&gt; &lt;pkg-ref id=&quot;com.cisco.pkg.anyconnect.iseposture&quot; version=&quot;4.7.01076&quot; installKBytes=&quot;3010&quot;&gt;#iseposture_module.pkg&lt;/pkg-ref&gt; &lt;pkg-ref id=&quot;com.cisco.pkg.anyconnect.nvm_v2&quot; version=&quot;4.7.01076&quot; installKBytes=&quot;1485&quot;&gt;#nvm_module.pkg&lt;/pkg-ref&gt; &lt;pkg-ref id=&quot;com.cisco.pkg.anyconnect.umbrella&quot; version=&quot;4.7.01076&quot; installKBytes=&quot;3645&quot;&gt;#umbrella_module.pkg&lt;/pkg-ref&gt; --&gt; &lt;installation-check script=&quot;InstallationCheck()&quot;/&gt; &lt;volume-check script=&quot;VolumeCheck()&quot;/&gt; &lt;script&gt; var gUpgradeModules = []; function check_upgrade() &#123; var modulePkgInfo = my.choice.packages[0]; var moduleReceipt = my.target.receiptForIdentifier(modulePkgInfo.identifier); if (moduleReceipt) &#123; var comparison = system.compareVersions(moduleReceipt.version, modulePkgInfo.version); if (comparison == 0) &#123; system.log(&quot;Found an existing installed version: &quot; + my.choice.title); return false; &#125; &#125; gUpgradeModules.push(my.choice.id); return true; &#125; function enable_module() &#123; var moduleID = my.choice.id; return (gUpgradeModules.indexOf(moduleID) &amp;gt; -1); &#125; function InstallationCheck() &#123; if(!(system.compareVersions(system.version.ProductVersion, &#x27;10.9&#x27;) &amp;gt;= 0)) &#123; my.result.title = &#x27;Cisco AnyConnect Secure Mobility Client&#x27;; my.result.message = &#x27;This software requires Mac OS X version 10.9 or later.&#x27;; my.result.type = &#x27;Fatal&#x27;; return false; &#125; return true; &#125; function VolumeCheck() &#123; // version of VPN being installed has to be higher than the version already installed var vpnReceipt = my.target.receiptForIdentifier(&quot;com.cisco.pkg.anyconnect.vpn&quot;); var vpnPackage = choices.choice_vpn.packages[0]; // if the receipt is not there assume no VPN installed or pre-3.1.1 version so it is OK to install if (vpnReceipt) &#123; // there is a 3.1.1+ version of VPN already installed // check to see if version in this package is newer var comparison = system.compareVersions(vpnReceipt.version, vpnPackage.version); if (comparison &amp;gt; 0) &#123; // installed version is newer my.result.message = &#x27;Newer version &#x27; + vpnReceipt.version + &#x27; of the Cisco AnyConnect Secure Mobility Client is already installed.&#x27;; my.result.type = &#x27;Fatal&#x27;; return false; &#125; &#125; return true; &#125; function choice_vpn_enabled() &#123; if (!enable_module()) &#123; return false; &#125; return (!choices.choice_websecurity.selected &amp;amp;&amp;amp; !choices.choice_posture.selected &amp;amp;&amp;amp; !choices.choice_iseposture.selected &amp;amp;&amp;amp; !choices.choice_fireamp.selected &amp;amp;&amp;amp; !choices.choice_nvm.selected &amp;amp;&amp;amp; !choices.choice_umbrella.selected); &#125; function choice_vpn_selected() &#123; if (!enable_module()) &#123; return false; &#125; var tSelected; tSelected=((choices.choice_websecurity.selected || choices.choice_posture.selected || choices.choice_iseposture.selected || choices.choice_fireamp.selected || choices.choice_nvm.selected || choices.choice_umbrella.selected) || (!choices.choice_websecurity.selected &amp;amp;&amp;amp; !choices.choice_posture.selected &amp;amp;&amp;amp; !choices.choice_iseposture.selected &amp;amp;&amp;amp; !choices.choice_fireamp.selected &amp;amp;&amp;amp; !choices.choice_nvm.selected &amp;amp;&amp;amp; !choices.choice_umbrella.selected)); if (choice_vpn_enabled()==false) &#123; return tSelected; &#125; return (tSelected &amp;amp;&amp;amp; my.choice.selected); &#125; &lt;/script&gt; &lt;pkg-ref id=&quot;com.cisco.pkg.anyconnect.vpn&quot;&gt; &lt;bundle-version&gt; &lt;bundle CFBundleShortVersionString=&quot;4.7.01076&quot; CFBundleVersion=&quot;4.7.01076&quot; id=&quot;com.cisco.Cisco-AnyConnect-Secure-Mobility-Client&quot; path=&quot;Applications/Cisco/Cisco AnyConnect Secure Mobility Client.app&quot;/&gt; &lt;bundle CFBundleVersion=&quot;4.7.01076&quot; id=&quot;com.cisco.vpndownloader&quot; path=&quot;opt/cisco/anyconnect/bin/vpndownloader.app&quot;/&gt; &lt;bundle CFBundleShortVersionString=&quot;4.5.03023&quot; CFBundleVersion=&quot;4.5.03023&quot; id=&quot;com.cisco.Cisco-AnyConnect-Secure-Mobility-Client-Notification&quot; path=&quot;opt/cisco/anyconnect/bin/Cisco AnyConnect Secure Mobility Client Notification.app&quot;/&gt; &lt;bundle CFBundleShortVersionString=&quot;4.7.01076&quot; CFBundleVersion=&quot;4.7.01076&quot; id=&quot;com.cisco.uninstaller&quot; path=&quot;Applications/Cisco/Uninstall AnyConnect.app&quot;/&gt; &lt;/bundle-version&gt; &lt;/pkg-ref&gt;&lt;!-- &lt;pkg-ref id=&quot;com.cisco.pkg.anyconnect.websecurity_v2&quot;&gt; &lt;bundle-version/&gt; &lt;/pkg-ref&gt; &lt;pkg-ref id=&quot;com.cisco.pkg.anyconnect.fireamp&quot;&gt; &lt;bundle-version/&gt; &lt;/pkg-ref&gt; &lt;pkg-ref id=&quot;com.cisco.pkg.anyconnect.dart&quot;&gt; &lt;bundle-version&gt; &lt;bundle CFBundleShortVersionString=&quot;4.7.01076&quot; id=&quot;com.cisco.pkg.anyconnect.dart&quot; path=&quot;Applications/Cisco/Cisco AnyConnect DART.app&quot;/&gt; &lt;bundle CFBundleShortVersionString=&quot;4.7.01076&quot; CFBundleVersion=&quot;4.7.01076&quot; id=&quot;com.cisco.dartuninstaller&quot; path=&quot;Applications/Cisco/Uninstall AnyConnect DART.app&quot;/&gt; &lt;/bundle-version&gt; &lt;/pkg-ref&gt; &lt;pkg-ref id=&quot;com.cisco.pkg.anyconnect.posture&quot;&gt; &lt;bundle-version/&gt; &lt;/pkg-ref&gt; &lt;pkg-ref id=&quot;com.cisco.pkg.anyconnect.iseposture&quot;&gt; &lt;bundle-version/&gt; &lt;/pkg-ref&gt; &lt;pkg-ref id=&quot;com.cisco.pkg.anyconnect.nvm_v2&quot;&gt; &lt;bundle-version/&gt; &lt;/pkg-ref&gt; &lt;pkg-ref id=&quot;com.cisco.pkg.anyconnect.umbrella&quot;&gt; &lt;bundle-version&gt; &lt;bundle CFBundleVersion=&quot;1.5.5&quot; id=&quot;com.opendns.OpenDNS-Diagnostic&quot; path=&quot;opt/cisco/anyconnect/bin/UmbrellaDiagnostic.app&quot;/&gt; &lt;/bundle-version&gt; &lt;/pkg-ref&gt; --&gt;&lt;/installer-gui-script&gt; 简单看了下里面的判断逻辑，还需要吧&lt;choice id=&quot;choice_vpn&quot; start_enabled=&quot;enable_module()&quot;修改为&lt;choice id=&quot;choice_vpn&quot; start_enabled=&quot;1&quot;即可。 使用pkgutil重新打包 1$pkgutil --flatten anyconnect Anyconnect-New.pkg 重新挂载之前改为可读写的dmg，然后替换新的pkg文件。移除挂载后，再用macOS磁盘工具重新调整dmg的大小，调整后改为只读： 在 Mac 上使用“磁盘工具”调整磁盘映像大小 1$hdiutil convert anyconnect-macos-4.7.01076-predeploy-k9-rw.dmg -format UDRO -o anyconnect-macos-4.7.01076-VPN.dmg 参考资料：Cisco AnyConnect Secure Mobility Client Administrator Guide, Release 4.7","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"},{"name":"SSLVPN","slug":"SSLVPN","permalink":"http://nbma.info/tags/SSLVPN/"},{"name":"cisco","slug":"cisco","permalink":"http://nbma.info/tags/cisco/"}]},{"title":"zabbix添加企业微信告警","slug":"zabbix-wechat-alter","date":"un44fin44","updated":"un55fin55","comments":true,"path":"zabbix-wechat-alter/","link":"","permalink":"http://nbma.info/zabbix-wechat-alter/","excerpt":"一直没做过微信告警集成到zabbix，试了下，还挺简单的，记录一下","text":"一直没做过微信告警集成到zabbix，试了下，还挺简单的，记录一下 首先是需要有一个企业微信，在其中创建一个自建应用 设置好可见部门，记录AgentId和Secret 然后再“通讯录”记下需要接受告警信息的部门ID，在“我的企业”-“企业信息”里记录企业ID 本着 不重复造轮子的原则，我找了这个脚本X-Mars/Zabbix-Alert-WeChat这个也是zabbix官方推荐的脚本。 将上面记下的四个ID填入脚本指定字段。然后上传到/usr/local/share/zabbix/alertscripts或者 AlertScriptsPath 指定的其它位置.设置好执行权限和属组 然后再zabbix web中 “管理”-“报警媒介类型”-“创建” 脚本名称wechat.py添加三个参数&#123;ALERT.SENDTO&#125; &#123;ALERT.SUBJECT&#125; &#123;ALERT.MESSAGE&#125; 然后是在“配置”-“动作”-“操作”中 添加触发器的触发介质，把刚才创建的报警媒介wechat加上 最后是在“管理”-“用户”-“报警媒介”中，启用报警媒介wechat","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"centos","slug":"centos","permalink":"http://nbma.info/tags/centos/"},{"name":"monitor","slug":"monitor","permalink":"http://nbma.info/tags/monitor/"},{"name":"zabbix","slug":"zabbix","permalink":"http://nbma.info/tags/zabbix/"}]},{"title":"ansible批量配置思科路由器","slug":"ansible-manage-router","date":"un55fin55","updated":"un55fin55","comments":true,"path":"ansible-manage-router/","link":"","permalink":"http://nbma.info/ansible-manage-router/","excerpt":"ansible是一个python开发的基于ssh的配置管理工具，多用于devops生态。同时，一些网络厂商也为ansible开发了响应的模块用于批量管理网络设备。","text":"ansible是一个python开发的基于ssh的配置管理工具，多用于devops生态。同时，一些网络厂商也为ansible开发了响应的模块用于批量管理网络设备。 相对自己拿pyhton的netmiko自己写一些脚本，ansible现成的模块更加高效。 安装以centos7为例，直接yum安装即可 1234yum -y install ansibleansible --version#查看ansible版本 配置ansible中有以下几个概念 inventory: 仓库，需要被管理的主机列表和基本信息 playbook: 剧本，由多个task组成 modules: 模块，实现具体的功能 inventory中可以有多个group，执行时需要指定inventory文件，或者特定的group；ansible默认读取的是/etc/ansible/hosts文件，也可以用-i参数来指定inventory所在的位置，下面是一个配置示例 12345678910[ios]10.211.55.2710.211.55.2610.211.55.2410.211.55.25[ios:vars]ansible_ssh_user=ciscoansible_ssh_pass=ciscoansible_connection=local 在介绍playbook之前，先看下拓扑： 这里要实现的是对，配置NTP,SNMP,接口IP以及启用ospf： 12345678910111213141516171819202122232425262728---- hosts: ios gather_facts: false connection: local vars_files: - interface.yml tasks:# 配置 ntp server - name: configure ntp server ios_config: lines: ntp server 10.1.1.1# 配置 snmp - name: configure snmp ios_config: lines: snmp-server community network-read RO - name: configure ip address and ospf ios_config: lines: - no shutdown - ip address &#123;&#123; item.ip &#125;&#125; &#123;&#123; item.mask &#125;&#125; - ip ospf 1 area 0 parents: interface &#123;&#123; item.port &#125;&#125; with_items: &quot;&#123;&#123; interfaces &#125;&#125;&quot; when: (item.router == inventory_hostname)... 前面显示指定了需要配置的设备组，然后引入了一个变量文件interface.yml，内容是设备接口对应的ip地址： 1234567891011interfaces: - &#123;router: 10.211.55.27, port: e0/0, ip: 12.1.1.1, mask: 255.255.255.0&#125; - &#123;router: 10.211.55.27, port: e0/1, ip: 13.1.1.1, mask: 255.255.255.0&#125; - &#123;router: 10.211.55.26, port: e0/0, ip: 12.1.1.2, mask: 255.255.255.0&#125; - &#123;router: 10.211.55.26, port: e0/1, ip: 23.1.1.2, mask: 255.255.255.0&#125; - &#123;router: 10.211.55.26, port: e0/2, ip: 24.1.1.2, mask: 255.255.255.0&#125; - &#123;router: 10.211.55.25, port: e0/0, ip: 24.1.1.4, mask: 255.255.255.0&#125; - &#123;router: 10.211.55.25, port: e0/1, ip: 34.1.1.4, mask: 255.255.255.0&#125; - &#123;router: 10.211.55.24, port: e0/0, ip: 13.1.1.3, mask: 255.255.255.0&#125; - &#123;router: 10.211.55.24, port: e0/1, ip: 23.1.1.3, mask: 255.255.255.0&#125; - &#123;router: 10.211.55.24, port: e0/2, ip: 34.1.1.3, mask: 255.255.255.0&#125; with_items是循环，读取interface这个列表，一次作为item，当符合when的条件时就执行，不符合就跳过。 执行playbook: modules配置上面playbook中的ios_config就是ansible的一个模块。它能在思科ios系统的config模式下执行各种命令。其他各种模块可以查看官网的介绍 参考文档：ansible 网络自动化管理","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"},{"name":"centos","slug":"centos","permalink":"http://nbma.info/tags/centos/"},{"name":"ansible","slug":"ansible","permalink":"http://nbma.info/tags/ansible/"}]},{"title":"单出口设备的多WAN接入的冗余设置","slug":"ip-sla-pbr-track","date":"un66fin66","updated":"un55fin55","comments":true,"path":"ip-sla-pbr-track/","link":"","permalink":"http://nbma.info/ip-sla-pbr-track/","excerpt":"目前的网络情况，无论是LAN还是WAN，冗余越来越多，SLA也变的越来越重要。自己不熟悉的部分就一点一点消灭掉。 以思科设备为例，多WAN冗余接入最佳实践方案：使用策略路由PBR，将内部不同网段出向流量的下一跳修改成不同的WAN出口，使用SLA和track配合PBR进行链路检测和冗余切换。","text":"目前的网络情况，无论是LAN还是WAN，冗余越来越多，SLA也变的越来越重要。自己不熟悉的部分就一点一点消灭掉。 以思科设备为例，多WAN冗余接入最佳实践方案：使用策略路由PBR，将内部不同网段出向流量的下一跳修改成不同的WAN出口，使用SLA和track配合PBR进行链路检测和冗余切换。 策略路由，Policy-based Routing，当一个流量到达路由器设备时，会优先被策略路由处理，然后才是查询路由表。基于此来实现多出口冗余。 以这个拓扑为例： 路由器Border作为出口，连接了ISP1和ISP2两个ISP的WAN出口；R1内部有终端PC用户（192.168.1.x）和一些Server集群(10.0.0.x)，使用策略路由实现PC通过ISP1访问互联网，Server通过ISP2访问互联网。基本ip配置，内网路由，外网路由等基本配置略 SLA配置首先在Border路由器上配置SLA检测到ISP1,ISP2链路的可达性。 12345678910111213141516171819ip sla 1 icmp-echo 1.1.1.2 source-ip 1.1.1.1 threshold 100 timeout 100 frequency 3ip sla schedule 1 life forever start-time now#track 100检测ISP1的可达性track 100 ip sla 1 reachabilityip sla 2 icmp-echo 2.2.2.2 source-interface Ethernet0/1 threshold 100 timeout 100 frequency 3ip sla schedule 2 life forever start-time now#track 200检测ISP2的可达性track 200 ip sla 2 reachability 路由器将没隔3秒发送一次icmp的ping来来检测目标ip的可达性，超时时间是100ms。 PBR配置然后配置策略路由，先用acl匹配流量，然后route-map设置策略，再接口下调用 123456789101112131415161718#抓取流量access-list 100 permit ip 192.168.1.0 0.0.0.255 anyaccess-list 199 permit ip 10.1.1.0 0.0.0.255 any#设置route-maproute-map PBR permit 10 match ip address 100 set ip next-hop verify-availability 1.1.1.2 1 track 100 set ip next-hop verify-availability 2.2.2.2 2 track 200route-map PBR permit 20 match ip address 199 set ip next-hop verify-availability 2.2.2.2 1 track 200 set ip next-hop verify-availability 1.1.1.2 2 track 100#接口下调用interface Ethernet0/2 ip policy route-map PBR 说明：track100状态up的时候，默认pc使用1.1.1.2这个下一跳。track变为down时，这一行设置自动失效，将使用next-hop序号2的作为下一跳。track200同理。 PAT配置原有的ip nat inside source list xx只能为一个outside出口做地址转换，所以要同时修改源nat设置：把源地址列表nat改为根据出接口nat。在Border路由器上使用route-map匹配出接口： 123456789route-map ISP2 permit 10 match interface Ethernet0/1route-map ISP1 permit 10 match interface Ethernet0/0#出接口为e0/0的内部流量，转换为1.1.1.1出去#出接口为e0/1的内部流量，转换为2.2.2.1出去ip nat inside source route-map ISP1 interface Ethernet0/0 overloadip nat inside source route-map ISP2 interface Ethernet0/1 overload 测试12345678910111213141516171819PC#traceroute 8.8.8.8 numeric Type escape sequence to abort.Tracing the route to 8.8.8.8VRF info: (vrf in name&#x2F;id, vrf out name&#x2F;id) 1 192.168.1.1 0 msec 1 msec 0 msec 2 172.16.1.2 1 msec 0 msec 1 msec 3 1.1.1.2 5 msec 1 msec 1 msec 4 100.100.100.101 1 msec * 2 msecPC#Server#traceroute 8.8.8.8 numeric Type escape sequence to abort.Tracing the route to 8.8.8.8VRF info: (vrf in name&#x2F;id, vrf out name&#x2F;id) 1 10.1.1.1 0 msec 1 msec 0 msec 2 172.16.1.2 1 msec 0 msec 1 msec 3 2.2.2.2 1 msec 1 msec 0 msec 4 200.200.200.202 1 msec * 2 msecServer# 在Border或者ISP1上模拟故障 Border上弹出log*Dec 15 07:26:06.798: %TRACK-6-STATE: 100 ip sla 1 reachability Up -&gt; Down PC已经切换冗余: 123456789PC#traceroute 8.8.8.8 numeric Type escape sequence to abort.Tracing the route to 8.8.8.8VRF info: (vrf in name/id, vrf out name/id) 1 192.168.1.1 0 msec 0 msec 0 msec 2 172.16.1.2 1 msec 1 msec 0 msec 3 2.2.2.2 1 msec 1 msec 1 msec 4 200.200.200.202 1 msec * 2 msecPC# * 默认路由问题首先内到外的流量，由于PBR优于路由表，所以不走路由表。为了外部发起的流量到路由器能够正确的回包，设置默认路由加track，只有当track时up的时候，这条路由才被加入路由表。 12ip route 0.0.0.0 0.0.0.0 1.1.1.1 track 100ip route 0.0.0.0 0.0.0.0 2.2.2.2 track 200 参考文档：PBR+双出口NAT_CCNP学习资料Configuring Static Route Tracking using IP SLA (Basic)","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"},{"name":"nat","slug":"nat","permalink":"http://nbma.info/tags/nat/"},{"name":"SLA","slug":"SLA","permalink":"http://nbma.info/tags/SLA/"}]},{"title":"QoS学习笔记","slug":"qos-base","date":"un55fin55","updated":"un55fin55","comments":true,"path":"qos-base/","link":"","permalink":"http://nbma.info/qos-base/","excerpt":"年底了，是时候整理下笔记了","text":"年底了，是时候整理下笔记了 QoS的机制分类，标记，拥塞管理，拥塞避免，管制整形，链路效率 分类：将数据分成不同的类别 标记：标记成不同的优先级 拥塞管理：网络产生拥塞时，规定数据以什么样的先后顺序传输 拥塞避免：当网络（队列）即将产生拥塞时，如何丢弃数据包，避免产生拥塞 管制整形：当用于超出额定带宽是，超出部分不能被传输，采用其他方式处理。 链路效率：通过头部压缩或者链路分段，来提高带宽效率 分类和标记是实现差分服务的前提和基础；流量监管、流量整形、接口限速、拥塞管理和拥塞避免从不同方面对网络流量及其分配的资源实施控制，是提供差分服务的具体体现.各种QoS技术在网络设备上的处理顺序如下图: 不同技术能应用的方向如下： QoS部署模式1）CLI：早期传统网络去部署 2）MQC：（重点）模块化QoS 定义流量—class-map 设置策略—policy-map 应用策略—service-policy 3）Auto-QoS：在设备，预先配置好了profile，只需要调用即可 VoIP Enterprise 用于QoS的头部字段二层报头没有专门预留的QOS位，在VLAN帧头和MPLS封装中有以下字段可以用于QOS：COS位：trunk技术，在802.1q报头中有一个3位的PRI ，分为0~7八个等级，5代表语音 MPLS的EXP位，3位，分为0~7八个等级 三层的ip包头部有一个8位的ToS位，有两种不同的方法来表示数据包的优先级：IPP和DSCP。 IP precedence使用TOS的高3位，0~7等级，后5位置0 DSCP区分服务代码点使用TOS的高6位，有0~63个等级，可以标记的种类更多，一般分为四种： Default，6bit全0 EF，加速转发，101110，特点：确保最小时延，保证带宽，管制带宽 AF，保证转发，aaadd0，’aaa’代表不同的分类1-4，‘dd’代表丢包的可能性1-3，特点：保证带宽，没有拥塞时允许使用额外带宽。每个AF拥有独立的转发机制和带宽保证，dd越大，丢弃可能性越高。AF1: af11, af12, af13AF2: af21, af22, af23AF3: af31, af32, af33AF4: af41, af42, af43 CS，兼容IPP，只用高三位，xxx000，cs0-cs7 在使用路由器模拟发包的时候，比如扩展ping，不能直接设置IPP或DSCP的值，只能设置TOS，对应的关系是TOS = IPP × 32 和 TOS = DSCP × 4 QoS机制分析 1，分类有两种方式：MQC和NBAR MQC 实现2~4层的匹配class-map中match可以用match调用一下内容： ACL IP precedence value DSCP value Qos group number MPLS Exp bit Protocol Another class-map嵌套 Frame Relay DE bit IEEE 802.1q/ISL COS Input Interface Source MAC address Destination MAC address RTP(UDP) port range Any packet NBAR:基于网络层的应用识别，用于4~7层匹配解决了C/S和基于web应用的分配识别.NBAR的功能： 识别4-7的应用和协议 协议发现 提供流量统计 NBAR可用于分类的应用程序： 静态的TCP/UDP端口号 非TCP/UDP协议 连接过程中动态协议书的端口 子端口类型：http分类 MIME 配置，需要先开启CEF然后接口下配置协议发现ip nbar protocol-discovery 2，标记数据包上可以设置以下标志： IP precedence value DSCP value Qos group number MPLS Exp bit Frame Relay DE bit IEEE 802.1q/ISL COS Class-map分类之后，在policy-map中调用，然后set一个标记，最后在接口调用 3，拥塞管理主要是队列技术，只能应用在out方向每个接口只有一个硬件队列，可以有多个软件队列硬件队列默认就是FIFO，软件队列有FIFO,PQ,WRR等 FIFO：先进先出，简单，拥塞时无法保证关键业务优先发送 PQ：优先级队列，需要设置每个软件队列的优先级，高优先级调度完才调度低优先级，且抢占，低优先级有饿死的风险 RR：轮询，解决PQ低优先的风险，每个队列平等的轮询，无法保证关键业务优先发送 WRR：权重轮询，能改善关键业务的有线情况，但是调度不精确：按包数量大小权重的话，包大小无法控制；如果按字节数，可能导致包被过度分片 DRR：赤字轮询，这次多调用，下次少调用，但是同样调度不精确，只能缓解WRR WFQ：加权公平队列，共享带宽，高优先级分配的带宽高，低优先级带宽低，但能保证每个优先级都有指定的带宽，但是不支持自定义对流量分类，默认接口速度低于2.08Mbps是WFQ队列，大于2.08是FIFO队列 CBFWQ：基于类的加权公平队列，先使用class-map分类，然后插入策略（每个队列拥塞避免），分配带宽（指定bandwith，百分比，剩余带宽的百分比） LLQ：PQ+CBWFQ 4，拥塞避免队列满了之后，默认使用尾丢弃。 会影响 TCP同步，导致重传，降低滑动窗口大小 TCP饿死 无差异的丢弃 RED，随机早期检测，在队列满之前随机丢弃数据包 放慢TCP会话 减小平均队列的消息 避免TCP会话同步 WRED，基于权重的随机早期检测，使用IPP或者DSCP的RED Profile进行丢弃，先丢弃优先级低的。 ECN，显示拥塞通知。利用ECN标记，来代替丢包，告知对方网络产生拥塞，需要降低滑动窗口大小，从而避免TCP会话因丢包而重传 5，管制和整形policing，丢弃超出的数据包；超出部分的数据支持重标记；outputshaping，缓存超出的数据包，直到缓存区满为止；input&amp;output 令牌桶：Bc：burst size 令牌桶的大小Tc：time interval 加令牌的时间，多久加一次令牌CIR：每秒往桶里加令牌的速率，决定了用户流量的大小，CIR = Bc / Tc Be：第二个令牌的大小PIR：向第二个令牌的添加令牌速率 单速单桶：单速单桶模式不允许流量突发，当用户的流量速率小于配置的CIR时，报文被认为是conform；当用户的流量大于CIR时直接被认为是exceed(思科exceed华为violate)。 (图中Tc代表桶里令牌的数量，CBS代表令牌桶的容量即Bc) 123456789#如果只配置CIR，不指定Bc，那么默认Bc等于1500bytes或者 CIR数值 / 32 class 100 police 8000 conform-action transmit exceed-action drop class 200 police cir 8000 conform-action transmit exceed-action drop class 300 police 8000 1500 conform-action transmit exceed-action drop class 400 police cir 8000 bc 1500 conform-action transmit exceed-action drop 单速双桶：支持突发流量，用户的流量会出现三种结果： 小于或等于CIR（也就是符合CIR） （conform） 大于CIR并小于或等于CIR与Be之和（也就是符合两个桶令牌之和）（exceed） 超过CIR与Be之和（也就是超过两个桶令牌之和）（violate） (图中Tc、Te代表桶里令牌的数量，CBS，EBS代表令牌桶的容量即Bc、Be) 1234567#如果只配置CIR、Bc，不指定Be，那么默认Be等于1500bytes或者CIR数值 / 32。 class 500 police 8000 1000 conform-action transmit exceed-action set-prec-transmit 1 violate-action drop class 600 police 8000 1000 1300 conform-action transmit exceed-action set-prec-transmit 1 violate-action drop class 700 police cir 8000 bc 1000 be 1300 conform-action transmit exceed-action set-prec-transmit 1 violate-action drop 双速双桶： (图中Tc、Tp代表桶里令牌的数量，CBS，PBS代表令牌桶的容量即Bc、Be) 12class 800 police cir 8000 bc 1000 pir 8000 be 1200 conform-action transmit exceed-action transmit violate-action drop 6，链路效率一般部署在低速广域网链路 压缩，二层payload压缩；包含二层header和有效payload压缩 header压缩，对三IP，TCP，RTP的头部进行压缩 链路分片和交互式发送。 QoS的测试验证最早学习的时候，所有人都说模拟器只能敲QoS命令，无法验证效果，最对就是show policy-map interface 看下配置结果。确实，模拟器没有真实的流量，也没有合适监控图表能实时显示流量。这次复习QoS，我想试试能不能测试，首先是拿docker启动一个zabbix容器，然后为了查看方便，虚机上还装了grafana，这些工具之前都介绍过. 关于路由器镜像，IOL镜像不支持snmp；dynamic镜像支持snmp，但是接口流量好像不是实时的，大概1分钟才更新一次，在这1分钟内取多少次都不变（注：SNMP的大部分数值都是自增的，实际结果要取差值）；vIOS由于本身不是模拟器，而是虚拟的IOS，所以完美支持snmp功能，可以用于各种测试和监控。 关于QOS测试，效果比较好的就是流量整形了，我是拿两台路由器通过ping size产生的流量，以shape average 500000为例，结果如下图: 然后，流量管制的效果不太理想，原因是我的流量太单一太少，数据包的大小都是固定的，这一秒令牌够的时候就转发，下一秒不够流量就是0，没能完美出图： 参考文档配置指南-QoSCCIE资料库→CCIE R&amp;S v4.0 理论→QOS思科QOS中的令牌桶算法qos令牌桶（Token Bucket）算法解析QOS-6 管制policing和整形shapingQoS基础及技术原理——2","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"},{"name":"QoS","slug":"QoS","permalink":"http://nbma.info/tags/QoS/"}]},{"title":"IS-IS路由协议","slug":"is-is-protocol","date":"un33fin33","updated":"un55fin55","comments":true,"path":"is-is-protocol/","link":"","permalink":"http://nbma.info/is-is-protocol/","excerpt":"前两天重新复习了ospf，说起链路状态协议，另一个is-is还没接触过，先了解下基本概念","text":"前两天重新复习了ospf，说起链路状态协议，另一个is-is还没接触过，先了解下基本概念 is-is, Intermediate System to Intermediate System 中间系统到中间系统。 ES, End System 终端系统，没有数据包转发能力的网络节点 IS, Intermediate System 中间系统，有数据包转发能力的网络节点，即路由器 Area, 区域，由一组连续的路由器、主机和连接他们的网络链路组成的实体。这里的区域是以路由器划分，而不是OSPF中的以接口划分。每台路由器只属于一个区域。 Domain, 域，理解成自治系统，由一组连续的Area组成。 IS-IS的角色 Level-1路由器，只负责区域内的路由，和其他具有L1功能的路由器构成L1区域，Level-1路由器必须通过Level-1-2路由器才能连接至其他区域。 Level-1/2路由器，同时具有L1和L2功能的路由器，类似OSPF的ABR设备，但他不向L1区域通告L2的路由 Level-2路由器，负责区域间的路由，路由域中Level-2级别的路由器必须是物理连续的，以保证骨干网的连续性。。只有Level-2级别的路由器才能直接与区域外的路由器交换数据报文或路由信息。 IS-IS的NET地址结构网络服务访问点NSAP（Network Service Access Point）是OSI协议中用于定位资源的地址。NSAP的地址结构如下图所示，它由IDP（Initial Domain Part）和DSP（Domain Specific Part）组成。IDP和DSP的长度都是可变的，NSAP总长最多是20个字节，最少8个字节。 在IS-IS路由选择过程中，没有使用NSAP地址中的NSEL，所以NSEL始终保持为00。当NSEL为00时，我们就称这个NSAP地址为NET（Network Entity Titile，网络实体名）地址，NET地址用来唯一地表示IS-IS路由选择域中的OSI主机。路由器使用NET地址来标识自己。路由器在发送的链路状态数据包（LSP）中用NET来标识自己，这类似于OSPF发送的LSA中的路由器ID（Router ID）。 具体字段就不解析了，其中的区域ID是可变长的，建议是用49开通的本地私有域；system ID建议全局唯一，NSEL在ip网络中没有使用，填0就行。 例子 1：net 49.0001.0000.0000.0001.00代表 area = 49.0001; systemID = 0000.0000.0001; NSEL = 00. 例子 2：net ab.cdef.1234.5678.90ab.cdef.00代表 area = ab.cdef.1234; systemID = 5678.90ab.cdef; NESL = 00. IS-IS的metric在思科路由器中，ISIS默认只使用default-metric 10来计算度量值，可以使用命令metric-style来引入Delay延时，Expense花销和Reliabilty可靠性来计算路由参考。也可以直接在接口下修改metric值来影响选路 IS-IS的配置示例这里用不同图标来表示不同角色的设备（R3,R5是level-2设备） 基本配置 12345678910router isis net 49.0001.0000.0000.0001.00 #net is-type level-1interface Ethernet0/0 ip address 16.1.1.1 255.255.255.0 ip router isis #接口下启用isis#接口下修改metricisis metric XXX &#123;level-1/level-2&#125; 常用的命令： show isis topology #查看到达本区域的每个NET的metric和下一跳 show isis nei #查看邻居状态和角色类型 参考文档：[1]. IS-IS路由协议中文教程v1[2]. ISIS基础知识[3]. IS-IS路由协议（一）","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"}]},{"title":"验证OSPF是不是一个纯链路状态协议","slug":"is-ospf-a-pure-link-status-protocol","date":"un11fin11","updated":"un55fin55","comments":true,"path":"is-ospf-a-pure-link-status-protocol/","link":"","permalink":"http://nbma.info/is-ospf-a-pure-link-status-protocol/","excerpt":"复习的时候突然想到去年的一个面试题，虽然当时事后也找人认真讨论了，但是没有深入的研究，更别提结论了","text":"复习的时候突然想到去年的一个面试题，虽然当时事后也找人认真讨论了，但是没有深入的研究，更别提结论了 要研究这个问题，先要明确链路状态协议的特点，距离矢量协议的特点是，路由器学习到的路由是由邻居传递过来的，路由器本身不了解全网拓扑，只知道去往目的网段的跳数（“道听途说”）。而链路状态协议的特点是，路由器彼此交互链路状态信息，每台路由器了解全网的邻接状态和链路状态，然后本地运行SPF算法计算得到最优路由。 而OSPF在同一区域内，确实符合链路状态协议的特点；但是在区域间并没有传递链路状态，只是传递了路由信息:网络号，掩码，metric。根据以上得出，OSPF在区域内是纯链路状态协议，而在区域间更像是距离矢量行为。 验证的办法有两种：1，区域间选路的“逐跳”行为2，一个区域的路有更新，传递到其他区域，其他区域的路由并不会运行SPF算法 使用这个拓扑进行验证，上面是area 0，下面是area 1，R1R4都有环回口宣告进各自区域 当路由收敛完毕后，查看R1的路由表，其中4.4.4.4/32这条显示的metric是31： 查看area 0内路由器的lsdb可以知道，R1从R2学习到的4.4.4.4/32的metric是11，从R3学习到的是101；而R1到达R2,R3的metric分别是10，20；所以R1选择的路径是R1-R3-R2-R4.但是，对数据包进行跟踪的话，实际的路径则是R1-R3-R4. 这是由于R3作为ABR，它从R4获得1类LSA，生成O表项的路由；从R2获得3类LSA，生成O IA表项的路由；优选O表项。不比较metric。 这种“逐条选路”的行为并不是链路状态协议的特点。 第二种方式的话，用一个命令就可以确认sh ip os statistics 在area 1的R4上添加一一个环回口，宣告进area 1，等路有更新完毕后，分别在R1R4上执行这条命令： 可以看到，只有area 1的路由器执行了一次SPF算法： 分析完了","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"},{"name":"ospf","slug":"ospf","permalink":"http://nbma.info/tags/ospf/"}]},{"title":"oxidized在部署使用中遇到的问题","slug":"oxidized-update","date":"un33fin33","updated":"un55fin55","comments":true,"path":"oxidized-update/","link":"","permalink":"http://nbma.info/oxidized-update/","excerpt":"在生产部署oxidized的时候还是遇到了不少问题，这里整理出来：","text":"在生产部署oxidized的时候还是遇到了不少问题，这里整理出来： 1. 时区问题默认页面上显示的是UTC时间，需要修改一个js文件。 1234#查找js所在目录find / -name oxidized.js/usr/local/rvm/gems/ruby-2.5.1/gems/oxidized-web-0.11.1/lib/oxidized/web/public/scripts/oxidized.js 编辑js，注释掉56行，删掉57行的timezone部分：然后重启oxidized，刷新页面即可 2. group问题默认没有设置的情况下，所有设备都在default组里。设置group需要同时修改config和source源： config部分，添加上group字段的映射： 123456789101112131415source: default: csv csv: file: &quot;/root/.config/oxidized/router.db&quot; delimiter: !ruby/regexp /:/ map: name: 0 ip: 1 group: 2 model: 3 username: 4 password: 5 vars_map: enable: 6 gpg: false 同一个group里的相同属性可以直接写在config里 source部分，分配对应的group 1234FW-5525X-017:192.168.1.1:Cisco:asa:admin:Admin@123:Enable@456AC-7205-02:192.168.1.2:Aruba:aosw:admin:Admin@123AS-5720-01:192.168.1.3:Huawei:vrp:admin:Admin@123AS-5130-POE-02:192.168.1.4:H3C:comware:admin:Admin@123 重启后效果如图： 配置完group之后建议在output里开启以下两个feature 1234output: git: single_repo: true type_as_directory: true 可以实现 将配置按照groups划分为文件夹。否则，oxidized将为每个group创建一个本地的git repo，从而导致push remote repo失败 3. 配置中的uptime问题有些设备的配置中存在uptime字段，会导致每次git commit都提示设备配置有改变。oxidized官方的脚本里仅支持了部分设备在commit之前忽略这部分。我这里遇到两个漏网的，分别是山石网科的stoneos 和华为USG防火墙的vrp系统。 山石设备需要忽略的show version的Uptime和show configration running中ipsec的pre-share，其中pre-share的key本身是加密的，但是经过测试，隔一段时间再show的时候密文居然变了。 设备输出是这样的： 123456789101112131415# show version(...) Built by buildmaster8 2017/04/28 18:22:25 Uptime is 323 days 4 hours 4 minutes 20 seconds System language is &quot;en&quot;(...)# show configration running(...)isakmp peer &quot;to XXX site&quot; isakmp-proposal &quot;P1&quot; pre-share &quot;ubKB5d7wZlMEWi5tyxsSfQl+G04BuQ&quot; peer 1.2.3.4(...) 根据以上格式，需要删除uptime所在行，以及替换加密的文本。修改ruby脚本如下（修改部分已添加注释）: 123456789101112131415# vim /usr/local/rvm/gems/ruby-2.5.1/gems/oxidized-0.24.0/lib/oxidized/model/stoneos.rb(...) cmd &#x27;show configuration running&#x27; do |cfg| # replace secret text cfg.gsub! /pre-share (.*)/, &#x27;pre-share &lt;secret hidden&gt;&#x27; cfg end cmd &#x27;show version&#x27; do |cfg| # avoid commits due to uptime / Uptime is 323 days 4 hours 4 minutes 20 seconds cfg = cfg.each_line.reject &#123; |line| line.match /(Uptime\\s+\\d+\\s+)|(.*seconds.*)/ &#125; cfg = cfg.join comment cfg end(...) 对于华为的USG防火墙，主要是每次运行display命令的时候，会先输出当前时间*2018-10-10 15:16:50.440 +08:00*，然后才是命令的内容；另外就是下面的Datebase Version的时间，防火墙的数据库更新也没必要触发配置变更： 12345678910&lt;BJ_IPSEC&gt;disp version 2018-10-10 15:16:50.440 +08:00Huawei Versatile Routing Platform SoftwareVRP (R) Software, Version 5.170 (USG6300 V50...(...)AV Signature Database Version : SA Signature Database Version : 2016070401 C&amp;C Domain Name Database Version : Location Database Version : 2015121515(...) 修改的话就就类似uptime，直接过滤掉这一行再存储，这里使用固定的时区08:00作为过滤行的关键字： 123456789# vim /usr/local/rvm/gems/ruby-2.5.1/gems/oxidized-0.24.0/lib/oxidized/model/vrp.rb(...) cmd &#x27;display version&#x27; do |cfg| cfg = cfg.each_line.reject &#123; |l| l.match /08:00/ &#125;.join cfg = cfg.each_line.reject &#123; |l| l.match /uptime/ &#125;.join # avoid commits due to Database auto update cfg.gsub! /Database Version(\\s+\\:) (\\d*)/, &#x27;Database Version\\1 &lt;date hidden&gt;&#x27; comment cfg end 上面的\\1指的将第一个括号匹配的部分填充到这个位置。 修改完成后，再获取配置就不会提示有变化了。 这部分解决方案参考自Github的issues以及其他OS的脚本. 4. git repo冲突问题默认情况下是不会出现冲突问题，但是如果在其他地方修改提交了remote repo，本地的oxidized repo没有变。这个如何再运行oxidized的push remote repo就回提示fail，解决办法也很简单：确认下config中output部分的git目录的路径，直接删除rm -rf这个目录即可。","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"},{"name":"centos","slug":"centos","permalink":"http://nbma.info/tags/centos/"},{"name":"oxidized","slug":"oxidized","permalink":"http://nbma.info/tags/oxidized/"}]},{"title":"docker学习笔记","slug":"docker-basic","date":"un11fin11","updated":"un55fin55","comments":true,"path":"docker-basic/","link":"","permalink":"http://nbma.info/docker-basic/","excerpt":"Docker 运行在 CentOS 7 上，要求系统为64位、系统内核版本为 3.10 以上。Docker 运行在 CentOS-6.5 或更高的版本的 CentOS 上，要求系统为64位、系统内核版本为 2.6.32-431 或者更高版本。","text":"Docker 运行在 CentOS 7 上，要求系统为64位、系统内核版本为 3.10 以上。Docker 运行在 CentOS-6.5 或更高的版本的 CentOS 上，要求系统为64位、系统内核版本为 2.6.32-431 或者更高版本。 从 2017 年 3 月开始 docker 在原来的基础上分为两个分支版本: Docker CE 和 Docker EE。 Docker CE 即社区免费版，Docker EE 即企业版，强调安全，但需付费使用。 本文介绍 Docker CE 的安装使用。 使用yum安装docker首先查看系统内核版本，来验证是否符合docker要求，通过uname -r命令： 12[root@bogon ~]# uname -r3.10.0-693.21.1.el7.x86_64 安装步骤123456789101112131415161718192021222324252627#移除旧版本yum remove docker \\ docker-client \\ docker-client-latest \\ docker-common \\ docker-latest \\ docker-latest-logrotate \\ docker-logrotate \\ docker-selinux \\ docker-engine-selinux \\ docker-engine#安装一些必要的系统工具yum install -y yum-utils device-mapper-persistent-data lvm2#添加阿里的yum源yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo#更新 yum 缓存：yum makecache fast#安装docker-ceyum -y install docker-ce#启动服务systemctl start docker 测试hello-world1docker run hello-world 使用docker ps可以查看当前正在运行的容器。 使用脚本安装docker1234567curl -fsSL https://get.docker.com -o get-docker.shsudo sh get-docker.shsystemctl start dockerdocker run hello-world 镜像加速由于某些原因，从官网拉取docker镜像十分缓慢，所以建议配置国内的镜像源。这里使用163的docker镜像源http://hub-mirror.c.163.com 新版的 Docker 使用 /etc/docker/daemon.json（Linux） 或者 %programdata%\\docker\\config\\daemon.json（Windows） 来配置 Daemon。 请在该配置文件中加入（没有该文件的话，请先建一个）： 1234# vim /etc/docker/daemon.json&#123; &quot;registry-mirrors&quot;: [&quot;http://hub-mirror.c.163.com&quot;]&#125; 删除docker-ce执行以下命令即可： 12yum remove docker-cerm -rf /var/lib/docker 常用命令参数1docker run ubuntu:15.10 /bin/echo &quot;Hello world&quot; run:运行一个容器。 ubuntu:15.10指定要运行的镜像，Docker首先从本地主机上查找镜像是否存在，如果不存在，Docker 就会从镜像仓库 Docker Hub 下载公共镜像。 /bin/echo &quot;Hello world&quot;: 在启动的容器里执行的命令 以上命令完整的意思可以解释为：Docker 以 ubuntu15.10 镜像创建一个新容器，然后在容器里执行 bin/echo “Hello world”，然后输出结果。 直接输入docker然后回车，可以看到docker支持的所有命令。比如run, build, images, pull等。具体到每条命令可以用docker COMMAND --help查看使用方法 常用的一些： 123456789101112131415161718192021docker ps 查看正在运行的容器 -a 查看所有容器，包含stop的docker iamges 查看本机存在的docker镜像docker search httpd 查找远端docker仓库中的httpd镜像docker pull httpd 拉取镜像到本地docker run httpd 启动一个容器 -d 后台运行 -t 启动一个伪终端 -i 允许你对容器内的标准输入 (stdin) 进行交互 -P 将容器内部使用的网络端口映射到外部主机上，默认外部端口32769 -p 5001:5000 将外部5001端口映射到容器的5000端口 --name mydocker 将容器命名为mydocker -v $PWD&#x2F;www:&#x2F;www 将主机中当前目录下的www挂载到容器的&#x2F;wwwdocker logs &lt;NAME&gt;|&lt;HASH&gt; 查看容器内的标准输出 -f 类似tail -f一样来输出内部的stdoutdocker stop &lt;NAME&gt;|&lt;HASH&gt; 停止容器docker port &lt;NAME&gt;|&lt;HASH&gt; 查看容器端口映射情况docker start &lt;NAME&gt;|&lt;HASH&gt; 启动已经停止的容器docker top &lt;NAME&gt;|&lt;HASH&gt; 查看容器内部运行的进程docker rm &lt;NAME&gt;|&lt;HASH&gt; 删除不需要的容器，必须是在stop状态docker inspect &lt;NAME&gt;|&lt;HASH&gt; 查看 Docker 的底层信息，返回一个 JSON 文件记录着 Docker 容器的配置和状态信息","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"centos","slug":"centos","permalink":"http://nbma.info/tags/centos/"},{"name":"docker","slug":"docker","permalink":"http://nbma.info/tags/docker/"}]},{"title":"可能是目前最好用的网络配置备份工具-oxidized","slug":"maybe-the-best-conf-backup-tool-oxidized","date":"un55fin55","updated":"un66fin66","comments":true,"path":"maybe-the-best-conf-backup-tool-oxidized/","link":"","permalink":"http://nbma.info/maybe-the-best-conf-backup-tool-oxidized/","excerpt":"说起配置管理，一直我面临的头疼问题——企业网的设备品牌太多太杂了。基本上很少有机会去使用厂商私有的配置管理工具。SolarWinds的KiWi CaTools是一个非常不错的商业解决方案，但是，应该没有多少公司会在信息化上投入太多成本吧。","text":"说起配置管理，一直我面临的头疼问题——企业网的设备品牌太多太杂了。基本上很少有机会去使用厂商私有的配置管理工具。SolarWinds的KiWi CaTools是一个非常不错的商业解决方案，但是，应该没有多少公司会在信息化上投入太多成本吧。 之前我是从网上找的和谐版CaTools，不过由于版本太旧，只能支持部分品牌的设备，将就了大半年。正要准备用python的netmiko自己写一个的时候，发现了这个工具——oxidized。简单测试了下，已经能覆盖我司的全部设备。 介绍oxidized是一个轻量、可扩展的网络设备配置工具，目前能支持90多种操作系统。 支持多线程 支持多种数据源（csv,db,http） 支持多种输出类型（file,git,http） 支持RESTful API Github项目地址：oxidized 安装oxidized可以直接通过ruby的gem进行安装，也可以从docker启动: 1. CentOS手动安装基于ruby，所以需要先把centos7上的ruby2.0升级到2.3版本，这里是有RVM来管理ruby版本。首先是更新依赖包 123yum install -y curl gcc-c++ patch readline readline-devel zlib zlib-develyum install -y libyaml-devel libffi-devel openssl-devel make cmakeyum install -y bzip2 autoconf automake libtool bison iconv-devel libssh2-devel libicu-devel 安装RVM前需要先导入gpg的公钥: 123gpg2 --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3#安装：curl -L get.rvm.io | bash -s stable 最新的rvm安装完成之后，还需手动把当前用户添加到rvm组才行： 12#把root用户加入到rvm groupusermod -a -G rvm root log out注销当前用户，然后再log in重新读取组信息，可以使用groups命令查看当前用户的数组，加入rvm组后可以执行rvm命令设置RVM环境并编译，然后安装Ruby 2.3.0并设置为默认值 123source /etc/profile.d/rvm.shrvm install 2.3.0rvm use --default 2.3.0 然后就可以通过Rubygems安装oxidized 123gem install oxidizedgem install oxidized-script oxidized-web# 如果不想安装oxidized-web，需要在启动前从config里删除rest部分的配置 安装完成后就可以进行初始配置了。 2. docker启动首先需要创建一个配置文件的目录在宿主机上： 1mkdir /etc/oxidized 然后第一次运行容器，来生成初始配置文件： 这一步仅用作生成config文件，如果已经有了，跳过这一步 1docker run --rm -v /etc/oxidized:/root/.config/oxidized -p 8888:8888/tcp -t oxidized/oxidized:latest oxidized 这个时候/etc/oxidized下应该已经有了一个config文件，把它编辑成你想要的样子; 同时，创建数据源/etc/oxidized/router.db（下文具体解析config文件的内容和数据源格式） 正式启动容器： 12345678docker run -v /etc/oxidized:/root/.config/oxidized -p 8888:8888/tcp -t oxidized/oxidized:latest# 成功启动后会看到如下信息：oxidized[1]: Oxidized starting, running as pid 1oxidized[1]: Loaded 1 nodesPuma 2.13.4 starting...* Min threads: 0, max threads: 16* Environment: development* Listening on tcp://0.0.0.0:8888 初始配置Oxidized的配置文件是用的yaml格式，文件默认读取目录是/etc/oxidized/config和~/.config/oxidized/config。初次运行的时候会自动生成默认的~/.config/oxidized/config config文件 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364---username: usernamepassword: passwordmodel: junosresolve_dns: falselog: /var/log/oxidized.loginterval: 3600use_syslog: falsedebug: falsethreads: 30timeout: 20retries: 3prompt: !ruby/regexp /^([\\w.@-]+[#&gt;]\\s?)$/rest: 127.0.0.1:8888next_adds_job: falsevars: &#123;&#125;groups: &#123;&#125;models: &#123;&#125;pid: &quot;/root/.config/oxidized/pid&quot;crash: directory: &quot;/root/.config/oxidized/crashes&quot; hostnames: falsestats: history_size: 10input: default: ssh, telnet debug: false ssh: secure: false ftp: passive: true utf8_encoded: trueoutput: default: git git: user: Mansur email: i@nbma.info repo: &quot;/root/.config/oxidized/backup_conf/devices.git&quot; file: directory: &quot;/root/.config/oxidized/configs&quot;hooks: push_to_remote: type: githubrepo events: [post_store] user: Mansur email: i@nbma.info remote_repo: git@nbma.info:mansur/test-oxidized.git publickey: /root/.ssh/id_rsa.pub privatekey: /root/.ssh/id_rsasource: default: csv csv: file: &quot;/root/.config/oxidized/router.db&quot; delimiter: !ruby/regexp /:/ map: name: 0 ip: 1 model: 2 username: 3 password: 4 gpg: falsemodel_map: cisco: ios juniper: junos 需要关注的内容不多：username, password, model这些无需修改，source文件里的相应字段会更优先;interval即是备份的周期；rest部分是oxidized-web生成的网页，可以直观的查看各个设备的备份状态，保持127.0.0.0，后面可以另外部署一个nginx用于代理和认证。下面是其他几个比较重要的配置： 1. source定义了数据源，map是解析的字段映射： 123more /root/.config/oxidized/router.dbS5720-05:192.168.1.2:vrp:admin:Admin@123C2960-01:192.168.1.3:ios:cisco:Cisco@123 2. output file 以文件方式输出 1234output: default: file file: directory: &quot;/root/.config/oxidized/configs&quot; git 以git方式输出 123456output: default: git git: user: Mansur email: i@nbma.info repo: &quot;/root/.config/oxidized/backup_conf/devices.git&quot; 3. hookhook需要先指定类型，然后通过监听事件event来执行相应的动作 push_to_remote 将配置保存到公司的gitlab是个不错的选择，可以方便直观的进行历史版本控制，以及进行配置对比。push_to_remote能够运行的前提是output是以git方式进行输出。先到gitlab上新建一个repo，然后上传key，修改oxidized的配置文件： 123456789hooks: push_to_remote: type: githubrepo events: [post_store] user: Mansur email: i@nbma.info remote_repo: git@nbma.info:mansur/test-oxidized.git publickey: /root/.ssh/id_rsa.pub privatekey: /root/.ssh/id_rsa 运行准备好配置文件之后，就可以运行了，默认直接在bash里已经安装了oxidized命令；使用oxidized &amp;来后台运行或者启动一个screen，或者启动oxidied.service查看日志，备份的file，或者git来确认备份进度 其他featurenginx的web验证nginx安装之前有写过账号密码的话，需要使用apache的httpd-tools来生成密码文件，或者不想安装的话，可以使用在线 htpasswd 生成器 手动生成的话使用以下命令 123htpasswd –c /home/htpasswd user1# 回车之后，连续输入两次密码即可。后续添加用户不需要-c参数htpasswd /home/htpasswd user2 然后，新建nginx配置文件： 1234567891011121314server &#123; listen 80; server_name 192.168.1.1; auth_basic &quot;oxidized web UI login&quot;; auth_basic_user_file /home/htpasswd; location / &#123; proxy_pass http://127.0.0.1:8888/; &#125; access_log /var/log/nginx/access_oxidized.log; error_log /var/log/nginx/error_oxidized.log;&#125; 重启nginx就可以了 设备group当网络设备足够多时，可以将设备分组，以实现对某些属性的批量管理。","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"},{"name":"centos","slug":"centos","permalink":"http://nbma.info/tags/centos/"},{"name":"oxidized","slug":"oxidized","permalink":"http://nbma.info/tags/oxidized/"}]},{"title":"一些不太好找的mib/oid","slug":"snmp-url","date":"un44fin44","updated":"un66fin66","comments":true,"path":"snmp-url/","link":"","permalink":"http://nbma.info/snmp-url/","excerpt":"不愿意花钱的公司，只能自力更生找开源方案一步一步的撸了。","text":"不愿意花钱的公司，只能自力更生找开源方案一步一步的撸了。 收集一些不太常见的mib和oid的地址 思科 cisco先是思科的ASA的温度，各大搜索引擎都没找到，最终在一个nagios的脚本里找到了如下内容： 1234567### SNMP OIDs################ Temperaturemy $S_temp = &quot;.1.3.6.1.2.1.99.1.1.1.4&quot;;# Memory# ...# 容易找的就直接略了 山石 hillstonePDF: StoneOS SNMP MIB Reference Guide 华为 huawei华三 H3C/HPHP Comware SNMP MIB for CPU, Memory and Temperature Aruba","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"},{"name":"monitor","slug":"monitor","permalink":"http://nbma.info/tags/monitor/"},{"name":"snmp","slug":"snmp","permalink":"http://nbma.info/tags/snmp/"}]},{"title":"elk收集分析ASA日志","slug":"elk-conf","date":"un44fin44","updated":"un55fin55","comments":true,"path":"elk-conf/","link":"","permalink":"http://nbma.info/elk-conf/","excerpt":"在上一篇ELK安装测试的时候有下面这句：input { stdin { } } output { stdout {codec =&gt;rubydebug} }通过stdin{}读取cli的输入，然后以rubydebug输出到cli","text":"在上一篇ELK安装测试的时候有下面这句：input { stdin { } } output { stdout {codec =&gt;rubydebug} }通过stdin{}读取cli的输入，然后以rubydebug输出到cli 上面就是一个简单的logstash配置文件。 下面以我收集ASA的日志为例，分析下配置文件的写法 首先是在ASA上配置syslog server ASA的syslog配置12345678logging enablelogging timestamplogging list VPN-USER message 302013logging list VPN-USER message 113039logging list VPN-USER message 113019logging trap VPN-USERlogging facility 22logging host inside x.x.x.x logging list定义了要传送给syslog server的日志列表，我找个几个有关SSLVPN的log message定义： message ID 内容 备注 113039 VPN user成功登陆 包含username，group-policy，remote-ip 113019 VPN user注销 同上 302013 VPN user发起一个TCP连接 包含username，src-ip，dst-ip等 302014 VPN user结束一个TCP连接 同上 302015 VPN user请求udp 同上 302016 VPN user接收udp 同上 302020 VPN user发起ICMP 同上 302021 VPN user接收ICMP 同上 更多ASA LOG message对应信息请查询思科官网文档 除了list以外，logging trap也可以根据不用的日志等级来过滤发送，常用的是logging trap informational 各个等级的大致描述如下 此外，还有一条logging facility 22facility用于区分不同类型的设备或进程产生的syslog，思科建议设置为21，22或23这个值用于计算syslog的优先级，Priority = Facility * 8 + Level logstash的配置logstash的配置文件包括三个部分：input, filter, output.详解如下： input：定义数据源123456input &#123; udp &#123; port =&gt; &quot;514&quot; type =&gt; &quot;cisco-fw&quot; &#125;&#125; udp是指数据源的类型，还可以是从文件读取的file等port =&gt; &quot;514&quot;代表运行时监听udp514(默认sysLog端口)，如果要指定tcp协议，将上面udp替换为tcp即可。type =&gt; &quot;cisco-fw&quot;区别于其他数据源，指定一个type，用于后面filter中的if匹配 filter：解析数据格式filter负责将日志解析为key-value的字段，其格式可以形容为伪代码吧，其中有一些特定的内置函数。我的filter中主要有grok，syslog_pri，geoip，mutate这4部分。(这里我解析了302013和113039的日志，其他日志只存储) 12345678910111213141516171819202122232425262728293031323334353637383940414243# more logstash_syslog.conffilter &#123; if [type] == &quot;cisco-fw&quot; &#123; grok &#123; match =&gt; [&quot;message&quot;, &quot;%&#123;CISCO_TAGGED_SYSLOG&#125; %&#123;GREEDYDATA:cisco_message&#125;&quot;] &#125; syslog_pri &#123; &#125;## Parse ASA-6-302013if [ciscotag] == &quot;ASA-6-302013&quot; &#123; grok &#123; match =&gt; [ &quot;cisco_message&quot;, &quot;%&#123;CISCOFW302013_302014_302015_302016&#125;&quot; ] &#125;&#125;## Parse ASA-6-113039if [ciscotag] == &quot;ASA-6-113039&quot; &#123; grok &#123; match =&gt; &#123; &quot;cisco_message&quot; =&gt; &quot;&lt;(?&lt;groupname&gt;[\\w\\-]+)&gt;\\sUser\\s&lt;(?&lt;usrename&gt;[\\w\\-\\./@\\\\]+)&gt;\\sIP\\s&lt;(?&lt;ipaddr&gt;[\\d\\.]+)&gt;\\sAnyConnect\\sparent&quot; &#125; &#125;if [ipaddr] != &quot;172.17.0.1&quot; &#123; geoip &#123; source =&gt; &quot;ipaddr&quot; target =&gt; &quot;geoip&quot; database =&gt; &quot;/opt/logstash/databases/GeoLite2-City/GeoLite2-City.mmdb&quot; add_field =&gt; [ &quot;[geoip][coordinates]&quot;, &quot;%&#123;[geoip][longitude]&#125;&quot; ] add_field =&gt; [ &quot;[geoip][coordinates]&quot;, &quot;%&#123;[geoip][latitude]&#125;&quot; ] &#125; mutate &#123; convert =&gt; [ &quot;[geoip][coordinates]&quot;, &quot;float&quot;] &#125;&#125;&#125; mutate &#123; remove_field =&gt; [ &quot;message&quot; ] &#125;&#125;&#125; 下面对结合例子对着5部分进行分析，以ASA-6-302013这条日志为例： 1&lt;182&gt;May 07 2018 13:26:42: %ASA-6-302014: Built inbound TCP connection 76009711 for inside:172.17.44.167&#x2F;54514 (172.17.44.167&#x2F;54514)(LOCAL\\\\xiaoming) to inside:192.168.115.37&#x2F;5061 (192.168.115.37&#x2F;5061) (xiaoming) GrokGrok使用特定的patterns（内置或者是自定义的正则）来匹配日志中的各种元素，并提取到指定字段里。上面第一个if内的CISCO_TAGGED_SYSLOG就是logstash中内置的一个patterns，它的作用是取得这条日志的优先级syslog_pri，时间戳timestamp，产生日志的主机sysloghost(可选)和日志类型ciscotag。对应匹配表达式是这样的： 1CISCO_TAGGED_SYSLOG ^&lt;%&#123;POSINT:syslog_pri&#125;&gt;%&#123;CISCOTIMESTAMP:timestamp&#125;( %&#123;SYSLOGHOST:sysloghost&#125;)? ?: %%&#123;CISCOTAG:ciscotag&#125;: 有关logstash内置的匹配patterns，可以在官方源码中查看：github链接 所以，上面的日志经过第一个Grok解析生成以下字段： 1234syslog_pri = 182timestamp = May 07 2015 13:26:42sysloghost =ciscotag = ASA-6-302013 剩余的部分*”Built inbound TCP… (xiaoming)”会作为cisco_message，用于后面%{CISCOFW302013_302014_302015_302016}*详细解析: 1234567891011121314151617181920212223242526272829&#123; &quot;dst_ip&quot;: &quot;192.168.115.37&quot;, &quot;syslog_pri&quot;: &quot;182&quot;, &quot;dst_mapped_port&quot;: &quot;5061&quot;, &quot;syslog_facility_code&quot;: 22, &quot;type&quot;: &quot;cisco-fw&quot;, &quot;ciscotag&quot;: &quot;ASA-6-302013&quot;, &quot;cisco_message&quot;: &quot;Built inbound TCP connection 76009711 for inside:172.17.44.167/54514 (172.17.44.167/54514)(LOCAL\\\\xiaoming) to inside:192.168.115.37/5061 (192.168.115.37/5061) (xiaoming)\\n&quot;, &quot;timestamp&quot;: &quot;May 07 2015 13:26:42&quot;, &quot;syslog_severity_code&quot;: 6, &quot;src_port&quot;: &quot;54514&quot;, &quot;syslog_severity&quot;: &quot;informational&quot;, &quot;src_mapped_port&quot;: &quot;54514&quot;, &quot;syslog_facility&quot;: &quot;local6&quot;, &quot;dst_port&quot;: &quot;5061&quot;, &quot;dst_mapped_ip&quot;: &quot;192.168.115.37&quot;, &quot;src_fwuser&quot;: &quot;LOCAL\\\\xiaoming&quot;, &quot;src_ip&quot;: &quot;172.17.44.167&quot;, &quot;host&quot;: &quot;172.17.0.17&quot;, &quot;@timestamp&quot;: &quot;2015-05-07T13:26:05.652Z&quot;, &quot;src_interface&quot;: &quot;inside&quot;, &quot;dst_interface&quot;: &quot;inside&quot;, &quot;src_mapped_ip&quot;: &quot;172.17.44.167&quot;, &quot;protocol&quot;: &quot;TCP&quot;, &quot;@version&quot;: &quot;1&quot;, &quot;action&quot;: &quot;Built&quot;, &quot;direction&quot;: &quot;inbound&quot;, &quot;connection_id&quot;: &quot;76009711&quot; &#125;, syslog_prisyslog_pri的作用是从syslog中解析PRI（优先级）字段，如果没有设置该优先级，默认为13.之前在ASA有配置logging facility 22，前面介绍过。就不多说了 根据公式，facility，level和Priority的对应关系如下： 12345678910111213141516171819202122232425 emergency alert critical error warning notice info debugkernel 0 1 2 3 4 5 6 7user 8 9 10 11 12 13 14 15mail 16 17 18 19 20 21 22 23system 24 25 26 27 28 29 30 31security 32 33 34 35 36 37 38 39syslog 40 41 42 43 44 45 46 47lpd 48 49 50 51 52 53 54 55nntp 56 57 58 59 60 61 62 63uucp 64 65 66 67 68 69 70 71time 72 73 74 75 76 77 78 79security 80 81 82 83 84 85 86 87ftpd 88 89 90 91 92 93 94 95ntpd 96 97 98 99 100 101 102 103logaudit 104 105 106 107 108 109 110 111logalert 112 113 114 115 116 117 118 119clock 120 121 122 123 124 125 126 127local0 128 129 130 131 132 133 134 135local1 136 137 138 139 140 141 142 143local2 144 145 146 147 148 149 150 151local3 152 153 154 155 156 157 158 159local4 160 161 162 163 164 165 166 167local5 168 169 170 171 172 173 174 175local6 176 177 178 179 180 181 182 183local7 184 185 186 187 188 189 190 191 mutate123mutate &#123; remove_field =&gt; [ &quot;message&quot; ]&#125; 如上所见，mutate可以增加和删除某个字段。支持remove_field, add_tag等移除多余的字段可以有效的减小日志的字节数，更高效的存储。 GeoIP用于获取ip地址的地理位置信息。 12345678910111213141516if [ciscotag] == &quot;ASA-6-113039&quot; &#123; grok &#123; match =&gt; &#123; &quot;cisco_message&quot; =&gt; &quot;&lt;(?&lt;groupname&gt;[\\w\\-]+)&gt;\\sUser\\s&lt;(?&lt;usrename&gt;[\\w\\-\\./@\\\\]+)&gt;\\sIP\\s&lt;(?&lt;ipaddr&gt;[\\d\\.]+)&gt;\\sAnyConnect\\sparent&quot; &#125; &#125; geoip &#123; source =&gt; &quot;ipaddr&quot; target =&gt; &quot;geoip&quot; database =&gt; &quot;/opt/logstash/databases/GeoLite2-City/GeoLite2-City.mmdb&quot; add_field =&gt; [ &quot;[geoip][coordinates]&quot;, &quot;%&#123;[geoip][longitude]&#125;&quot; ] add_field =&gt; [ &quot;[geoip][coordinates]&quot;, &quot;%&#123;[geoip][latitude]&#125;&quot; ] &#125; mutate &#123; convert =&gt; [ &quot;[geoip][coordinates]&quot;, &quot;float&quot;] &#125;&#125; 这里主要对113039中的remote-ip进行解析。logstash内置的表达式中没有对ASA-6-113039日志的匹配。 一条ASA-6-113039的日志经过上面的grok解析之后，cisco_message内容如下： 1Group &lt;ssl-policy&gt; User &lt;xiaoming&gt; IP &lt;116.87.87.164&gt; AnyConnect parent session started. 分别是用户所在安全组，用户名，用户拨入VPN时的源IP地址，使用正则表达式提取到这三部分内容。这里推荐使用kibana内置的dev tools调试表达式，直接预览最终效果 拿到用户拨入VPN时的remote-ip地址ipaddr，传给geoip的source，解析出对应的geo信息： 123456789101112131415161718192021&quot;geoip&quot;: &#123; &quot;country_code3&quot;: &quot;SG&quot;, &quot;country_name&quot;: &quot;Singapore&quot;, &quot;region_code&quot;: &quot;01&quot;, &quot;continent_code&quot;: &quot;AS&quot;, &quot;timezone&quot;: &quot;Asia/Singapore&quot;, &quot;country_code2&quot;: &quot;SG&quot;, &quot;region_name&quot;: &quot;Central Singapore Community Development Council&quot;, &quot;city_name&quot;: &quot;Singapore&quot;, &quot;longitude&quot;: 103.8558, &quot;ip&quot;: &quot;116.87.87.164&quot;, &quot;latitude&quot;: 1.2931, &quot;coordinates&quot;: [ 103.8558, 1.2931 ], &quot;location&quot;: &#123; &quot;lat&quot;: 1.2931, &quot;lon&quot;: 103.8558 &#125; &#125;, 坑： 需要注意的是，如果想在kibana的map中显示，那么location的字段类型不能是string，需要转换为geo_point类型。实际上，logstash默认的模板中已经支持了对geoip中location类型的转换，只需要在logstash output中输出到es的索引名字是logstash-*详细请看elk官方博客分析 * Date当产生日志的host设备时间不准确时可以也考虑添加date，使用接收日志时的logstash server时间作为日志时间戳。 12345678date &#123; match =&gt; [&quot;timestamp&quot;, &quot;MMM dd HH:mm:ss&quot;, &quot;MMM d HH:mm:ss&quot;, &quot;MMM dd yyyy HH:mm:ss&quot;, &quot;MMM d yyyy HH:mm:ss&quot; ]&#125; Date是从第一个grok过滤器获取时间戳值，并将其设置为放入elasticsearch时的timestamp。es默认使用接收到log的时间作为event发生的时间，而设置了date之后，可以用log中timestamp作为记录依据。所以，在ASA上配置ntp十分有必要。 output：输出123456output &#123; elasticsearch &#123; hosts =&gt; [&quot;172.17.40.52:9200&quot;] index =&gt; &quot;logstash-asa-%&#123;+YYYY.MM.dd&#125;&quot; &#125;&#125; 没什么好说的了，host是指定es的地址，index指定索引名，坑已踩。 sysLog日志的收集部分就是这样了，分析的话，等我再研究下看看有没有什么好分享的。 参考文档：[1] Send Cisco ASA Syslogs to Elasticsearch Using Logstash[2] Using Logstash, Elasticsearch and Kibana for Cisco ASA Syslog Message Analysis.[3] 关于geoip的配置 - ELK全家桶[4] ELK利用GeoIP进行地理定位[5] Visualize Geo location of log using Elasticsearch + Logstash + Kibana[6] What are Syslog Facilities and Levels?[7] Cisco ASA 5510 VPN login history","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"centos","slug":"centos","permalink":"http://nbma.info/tags/centos/"},{"name":"monitor","slug":"monitor","permalink":"http://nbma.info/tags/monitor/"},{"name":"asa","slug":"asa","permalink":"http://nbma.info/tags/asa/"},{"name":"SSLVPN","slug":"SSLVPN","permalink":"http://nbma.info/tags/SSLVPN/"},{"name":"elk","slug":"elk","permalink":"http://nbma.info/tags/elk/"}]},{"title":"elk部署","slug":"elk-setup","date":"un22fin22","updated":"un66fin66","comments":true,"path":"elk-setup/","link":"","permalink":"http://nbma.info/elk-setup/","excerpt":"在centos7上安装elk6.x版本Logstash是一个用于收集，解析和存储日志以供将来使用的开源工具。Kibana是一个Web界面，可用于搜索和查看Logstash索引的日志。这两个工具都基于Elasticsearch，用于存储日志。","text":"在centos7上安装elk6.x版本Logstash是一个用于收集，解析和存储日志以供将来使用的开源工具。Kibana是一个Web界面，可用于搜索和查看Logstash索引的日志。这两个工具都基于Elasticsearch，用于存储日志。 Logstash可以用于收集所有类型的日志，但我们将本教程的范围限制为syslog收集于Elasticsearch可以多节点集群存储。本文只有一台设备同时部署三个组件。 环境准备先安装java yum -y install java-1.8.0-openjdk* 修改LIMIT参数：vim /etc/security/limits.conf增加： 1234* soft nproc 65535* hard nproc 65535* soft nofile 65535* hard nofile 65535 添加虚拟内存 vim /etc/sysctl.conf 1vm.max_map_count=262144 通过sysctl -p 查看虚拟内存 安装ES，及插件基本环境准备好之后开始安装elasticsearch 首先导入key:rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch 配置repo: vim /etc/yum.repos.d/elasticsearch.repo 12345678[elasticsearch-6.x] name=Elasticsearch repository for 6.x packages baseurl=https://artifacts.elastic.co/packages/6.x/yum gpgcheck=1 gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch enabled=1 autorefresh=1 type=rpm-md 直接yum安装yum -y install elasticsearch 等待完成之后进行初始配置创建数据存放目录：mkdir -p /data/es-data修正文件夹权限：chown -R elasticsearch:elasticsearch /data/es-datachown -R elasticsearch:elasticsearch /var/log/elasticsearch/ 修改ES配置文件vim /etc/elasticsearch/elasticsearch.yml 123456789101112# grep ^[a-zA-Z].* /etc/elasticsearch/elasticsearch.yml# 集群名cluster.name: SPE-Net-ELK# 节点名node.name: node-1path.data: /data/es-datapath.logs: /var/log/elasticsearchnetwork.host: 0.0.0.0http.port: 9200# cors配置是为了后面的elasticsearch-head插件http.cors.enabled: truehttp.cors.allow-origin: &quot;*&quot; 启动服务： 1234sudo systemctl daemon-reloadsudo systemctl enable elasticsearch.servicesudo systemctl start elasticsearch.service 启动之后访问http://localhost:9200/ 显示以下类似的json确认ES正常 1234567891011121314151617&#123; &quot;name&quot; : &quot;node-1&quot;, &quot;cluster_name&quot; : &quot;SPE-Net-ELK&quot;, &quot;cluster_uuid&quot; : &quot;Ks1EF807Qn2ZZhvFLPdQTg&quot;, &quot;version&quot; : &#123; &quot;number&quot; : &quot;6.3.2&quot;, &quot;build_flavor&quot; : &quot;default&quot;, &quot;build_type&quot; : &quot;rpm&quot;, &quot;build_hash&quot; : &quot;053779d&quot;, &quot;build_date&quot; : &quot;2018-07-20T05:20:23.451332Z&quot;, &quot;build_snapshot&quot; : false, &quot;lucene_version&quot; : &quot;7.3.1&quot;, &quot;minimum_wire_compatibility_version&quot; : &quot;5.6.0&quot;, &quot;minimum_index_compatibility_version&quot; : &quot;5.0.0&quot; &#125;, &quot;tagline&quot; : &quot;You Know, for Search&quot;&#125; 安装es head插件（可选）安装git和node.js 12345678yum -y install gitwget https://nodejs.org/dist/v0.10.30/node-v0.10.30-linux-x64.tar.gztar --strip-components 1 -zxvf node-v* -C /usr/localnode --versiongit clone git://github.com/mobz/elasticsearch-head.gitcd elasticsearch-headnpm install Head插件phantomjs解压问题:解决办法,系统提供的lib解压有问题,安装bzip2即可: yum -y install bzip2 Head插件phantomjs权限问题:解决办法: npm install -g 运行，npm run startopen http://localhost:9100/可以查看到es集群的节点信息 安装logstash直接yum -y install logstash 的话由于是从海外aws下载速度较慢，建议自行下载rpm包（https://www.elastic.co/downloads/logstash ） 123456# 下载wget https://artifacts.elastic.co/downloads/logstash/logstash-6.3.2.rpm# 安装rpm -ivh logstash-6.3.2.rpm # 启动输入输出测试/usr/share/logstash/bin/logstash -e &#x27;input &#123; stdin &#123; &#125; &#125; output &#123; stdout &#123;codec =&gt;rubydebug&#125; &#125;&#x27; 后面真正需要运行的时候，需要配合配置文件启动，这些下次再写 /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/syslog-asa.conf &amp; 安装kibana同样，提前下载包官网（https://www.elastic.co/downloads/kibana ） 1234wget https://artifacts.elastic.co/downloads/kibana/kibana-6.3.2-linux-x86_64.tar.gz`#解压tar -zxvf kibana-6.3.2-linux-x86_64.tar.gz `mv kibana-6.3.2-linux-x86_64 /usr/local` 编辑配置文件 1234567# vim /usr/local/kibana-6.3.2-linux-x86_64/config/kibana.yml # grep ^[a-zA-Z].* /usr/local/kibana-6.3.2-linux-x86_64/config/kibana.ymlserver.port: 5601server.host: &quot;0.0.0.0&quot;elasticsearch.url: &quot;http://x.x.x.x:9200&quot;logging.dest: /var/log/kibana.log 启动/usr/local/kibana-6.3.2-linux-x86_64/bin/kibana &amp; 打开http://localhost:5601 即可看到kibana安装成功。 关于logstash的配置文件，详见下篇案例解析：elk收集分析ASA日志","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"centos","slug":"centos","permalink":"http://nbma.info/tags/centos/"},{"name":"monitor","slug":"monitor","permalink":"http://nbma.info/tags/monitor/"},{"name":"elk","slug":"elk","permalink":"http://nbma.info/tags/elk/"}]},{"title":"使用xtrabackup备份还原mysql","slug":"mysql-xtrabackup","date":"un22fin22","updated":"un66fin66","comments":true,"path":"mysql-xtrabackup/","link":"","permalink":"http://nbma.info/mysql-xtrabackup/","excerpt":"xtrabackup是一种物理备份工具，通过协议连接到mysql服务端，然后读取并复制innodb底层的”数据块”，完成所谓的”物理备份”。支持在线热备份（备份时不影响数据读写）。相对于mysqldump的逻辑备份还原快了太多了。","text":"xtrabackup是一种物理备份工具，通过协议连接到mysql服务端，然后读取并复制innodb底层的”数据块”，完成所谓的”物理备份”。支持在线热备份（备份时不影响数据读写）。相对于mysqldump的逻辑备份还原快了太多了。 安装最新版看https://www.percona.com/downloads下载rpm包：wget https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.4.9/binary/redhat/7/x86_64/percona-xtrabackup-24-2.4.9-1.el7.x86_64.rpmyum安装：yum install percona-xtrabackup-24-2.4.9-1.el7.x86_64.rpm 全量备份将备份的文件存放在/backup目录下 innobackupex --defaults-file=/etc/my.cnf --user=root --password=123123 /backup 备份完成后会显示 ok字样 全量备份的还原1.先prepare，利用–apply-log的作用是通过回滚未提交的事务及同步已经提交的事务至数据文件使数据文件处于一致性状态。备份出的数据并不能直接使用，因为备份出的数据是不一致的，我们还需要将同时备份出的事务日志应用到备份中，才能得到一份完整、一致、可用的数据，xtrabackup称这一步操作为prepare，也就是还原数据前的”准备”工作。 innobackupex --apply-log /backup/2018-06-23_10-53-51/ 在事务日志容量很大的情况下，可以使用–use-memory选项加速，在不指定内存大小的情况下，默认会占用100MB的内存。 2.copy：需要数据目录为空 innobackupex --defaults-file=/etc/my.cnf --copy-back /backup/2018-06-23_10-53-51/ 3.改权限 chown -R mysql:mysql /var/lib/mysql/ 指定库/表备份还原备份加参数–databases=”dba_test xtra_test”（多个库用空格隔开，指定表直接加点zabbix.history）prepare过程一样。还原，因为是部分备份，不能直接用–copy-back，只能手动来复制需要的库，也要复制ibdata(数据字典） 参考文档：xtrabackup 使用说明xtrabackup","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"centos","slug":"centos","permalink":"http://nbma.info/tags/centos/"},{"name":"mysql","slug":"mysql","permalink":"http://nbma.info/tags/mysql/"}]},{"title":"在CentOS7上开启和挂载NFS共享","slug":"centos-mount-nfs","date":"un22fin22","updated":"un66fin66","comments":true,"path":"centos-mount-nfs/","link":"","permalink":"http://nbma.info/centos-mount-nfs/","excerpt":"在CentOS7上开启和挂载NFS共享 NFS：Network File System 网络文件系统，可以让电脑在本地直接管理远端的硬盘。依赖RPC.RPC：Remote Procedure Call 远程过程调用，计算机通信协议。该协议允许运行于一台计算机的程序调用另一台计算机的子程序，而程序员无需额外地为这个交互作用编程。","text":"在CentOS7上开启和挂载NFS共享 NFS：Network File System 网络文件系统，可以让电脑在本地直接管理远端的硬盘。依赖RPC.RPC：Remote Procedure Call 远程过程调用，计算机通信协议。该协议允许运行于一台计算机的程序调用另一台计算机的子程序，而程序员无需额外地为这个交互作用编程。 服务端关闭防火墙和selinux 12345678910#安装nfs和rpcyum install -y rpc-bind nfs-utils#配置要共享的目录cat /etc/exports/share (rw,no_root_squash)#启动nfs和rpcbindsystemctl start nfssystemctl start rpcbind exports的文件格式： 1234567891011121314151617181920212223242526272829303132&lt;输出目录&gt; 客户端（选项:访问权限,用户映射,其他] 输出目录是指NFS系统中所定义的共享给客户端使用的文件系统客户端是定义网络中可以访问这个NFS共享目录的IP地址或网段或域名等 客户端常用的指定方式 指定ip地址的主机：192.168.100.1 指定一个子网：192.168.100.0&#x2F;24 也可以写成:192.168.100.0&#x2F;255.255.255.0 指定域名的主机：david.bsmart.cn 指定域中的所有主机：*.bsmart.cn 所有主机：*选项用来设置输出目录的访问权限、用户映射等。 NFS主要有3类选项： 设置输出目录只读：ro 设置输出目录读写：rw 用户映射选项 all_squash：将远程访问的所有普通用户及所属组都映射为匿名用户或用户组（nfsnobody）； no_all_squash：与all_squash取反（默认设置）； root_squash：将root用户及所属组都映射为匿名用户或用户组（默认设置）； no_root_squash：与rootsquash取反； anonuid&#x3D;xxx：将远程访问的所有用户都映射为匿名用户，并指定该用户为本地用户（UID&#x3D;xxx）； anongid&#x3D;xxx：将远程访问的所有用户组都映射为匿名用户组账户，并指定该匿名用户组账户为本地用户组账户（GID&#x3D;xxx）； 其它选项 secure：限制客户端只能从小于1024的tcp&#x2F;ip端口连接nfs服务器（默认设置）； insecure：允许客户端从大于1024的tcp&#x2F;ip端口连接服务器； sync：将数据同步写入内存缓冲区与磁盘中，效率低，但可以保证数据的一致性； async：将数据先保存在内存缓冲区中，必要时才写入磁盘； wdelay：检查是否有相关的写操作，如果有则将这些写操作一起执行，这样可以提高效率（默认设置）； no_wdelay：若有写操作则立即执行，应与sync配合使用； subtree：若输出目录是一个子目录，则nfs服务器将检查其父目录的权限(默认设置)； no_subtree：即使输出目录是一个子目录，nfs服务器也不检查其父目录的权限，这样可以提高效率； 客户端客户端如果不按照nfs的话默认是识别不了nfs的： 12345678[root@CentOS7-copy ~]# mount 10.211.55.21:&#x2F;share &#x2F;home&#x2F;media&#x2F;mount: 文件系统类型错误、选项错误、10.211.55.21:&#x2F;share 上有坏超级块、 缺少代码页或助手程序，或其他错误 (对某些文件系统(如 nfs、cifs) 您可能需要 一款 &#x2F;sbin&#x2F;mount.&lt;类型&gt; 助手程序) 有些情况下在 syslog 中可以找到一些有用信息- 请尝试 dmesg | tail 这样的命令看看。 所以需要先安装yum -y install nfs-utils经过测试，并不需要启动服务，装上就行 挂载测试 12345678910[root@CentOS7-copy ~]# mount 10.211.55.21:&#x2F;share &#x2F;home&#x2F;media&#x2F;[root@CentOS7-copy ~]# dd if&#x3D;&#x2F;dev&#x2F;zero of&#x3D;&#x2F;home&#x2F;media&#x2F;file2 bs&#x3D;1M count&#x3D;10记录了10+0 的读入记录了10+0 的写出10485760字节(10 MB)已复制，0.0422486 秒，248 MB&#x2F;秒[root@CentOS7-copy ~]# ll &#x2F;home&#x2F;media&#x2F;总用量 20484-rw-r--r-- 1 root root 10485760 6月 26 14:35 file1-rw-r--r-- 1 root root 10485760 6月 26 14:42 file2drwxr-xr-x 2 root root 4096 6月 26 14:33 sixsixsix 参考：在CentOS7上实现NFS共享","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"centos","slug":"centos","permalink":"http://nbma.info/tags/centos/"},{"name":"nfs","slug":"nfs","permalink":"http://nbma.info/tags/nfs/"}]},{"title":"ASA对VPN策略的处理过程","slug":"asa-vpn-policy-proc","date":"un55fin55","updated":"un66fin66","comments":true,"path":"asa-vpn-policy-proc/","link":"","permalink":"http://nbma.info/asa-vpn-policy-proc/","excerpt":"ASA收到VPN请求，由tunnel-group来识别VPN类型(L2L or 远程拨号 or SSLVPN)，然后使用tunnel-group中的认证方法（LOCAL or Radius）进行认证，认证通过后经过以下5个关联属性叠加，得到用户的最终的策略","text":"ASA收到VPN请求，由tunnel-group来识别VPN类型(L2L or 远程拨号 or SSLVPN)，然后使用tunnel-group中的认证方法（LOCAL or Radius）进行认证，认证通过后经过以下5个关联属性叠加，得到用户的最终的策略 1.用户属性2.用户属性中关联的group-policy3.tunnel-group中关联的group-policy4.系统默认的group-policy:DfltGrpPolicy5.tunnel-group的属性 这5个策略优先级从高到低，存在重复项时，优先使用最先匹配到的策略。 tunnel-grouptunnel-group用于终结VPN连接。一个VPN请求到达VPN，ASA找到一个与之关联的tunnel-group，tunnel-group为每一个成员定义了VPN连接的脚本。 - L2L VPN当一个L2L VPN抵达ASA，ASA通过这次请求源IP（对端加密点）来查询本地的tunnel-group,如果有一个有一个tunnel-group的名字等于该IP，那么就使用tunnel-group内的pre-shared-key对这次VPN进行认证。 12tunnel-group 61.128.1.1 type ipsec-l2l pre-shared-key IPSECKEY - EZVPNEZVPN的第一阶段认证group的名字必须能和tunnel-group名字一致 12345678tunnel-group EZGROUP type remote-accesstunnel-group EZGROUP general-attributes #就类似路由器在group里设置一样，地址池可以在这里敲。但是更推荐在group-policy里设置 address-pool EZPOOL #默认是LOCAL认证 #authentication-server-group LOCALtunnel-group EZGROUP ipsec-attributes ikev1 pre-shared-key EZVPNKEY - SSL VPNSSLVPN直接使用默认的DefaultWEBVPNGroup的tunnel-groupshow run all tunnel-group可以看到该部分配置 另外还有两个默认的tunnel-group分别对应L2L和远程接入VPN：DefaultL2LGroup适用于对端peer地址不固定的时候配置预共享密钥DefaultRAGroup适用于拨号VPN(如L2TP over IPSec) group-policy可以在多个地方调用： 12345678#在user属性里调用username ASAuser attributes vpn-group-policy user-group-policy#在tunnel-group里调用tunnel-group EZGROUP general-attributes default-group-policy TUNNEL-GROUP-POLICY","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"},{"name":"asa","slug":"asa","permalink":"http://nbma.info/tags/asa/"},{"name":"ipsec","slug":"ipsec","permalink":"http://nbma.info/tags/ipsec/"},{"name":"SSLVPN","slug":"SSLVPN","permalink":"http://nbma.info/tags/SSLVPN/"},{"name":"EZVPN","slug":"EZVPN","permalink":"http://nbma.info/tags/EZVPN/"}]},{"title":"ezvpn原理基本介绍","slug":"ezvpn-base","date":"un44fin44","updated":"un66fin66","comments":true,"path":"ezvpn-base/","link":"","permalink":"http://nbma.info/ezvpn-base/","excerpt":"协商过程第1阶段","text":"协商过程第1阶段 AM模式，不预选协商DH Group强度，所以必须强制指定group2三个包，因为省略了第一阶段前四个包。第1个包client先发自己支持的策略，组名和预共享密钥第2个包server使用PSK认证client第3个包完成协商 1.5阶段XAUTH：认证用户（用户名密码/AAA）MODE-CFG：推送策略 第2阶段快速模式，三个包 配置第1阶段1234567crypto isakmp policy 20 encr 3des authentication pre-share group 2crypto isakmp client configuration group GROUP key NBMAKEY 1.5阶段123456789101112#配置xauthaaa new-modelaaa authentication login EZ-XAUTH localaaa authorization network EZ-MODE-CFG local username cisco password 0 cisco#配置策略ip local pool POOL 11.11.11.10 11.11.11.110crypto isakmp client configuration group EZ-GROUP pool POOL 启用aaa之后建议在设备上开启线下保障策略，确保任何时候都可以使用console口 123456aaa newaaa authentication login noacs line noneline con 0 login authen noacsline aux 0 login authen noacs 第2阶段123456789101112131415161718crypto ipsec transform-set TRANS esp-3des esp-sha-hmac mode tunnelcrypto dynamic-map DYNAMIC-MAP 20 set transform-set TRANS #全局开启Xauthcrypto map EZVPN client authentication list EZ-XAUTHcrypto map EZVPN isakmp authorization list EZ-MODE-CFG#启用客户端配置响应crypto map EZVPN client configuration address respond #动态关联静态crypto map EZVPN 20 ipsec-isakmp dynamic DYNAMIC-MAPinterface GigabitEthernet0/0 crypto map EZVPN 当一台设备同时配置EzVPN和L2L VPN时，由于启用了全局的xauth认证，所以正常的L2L将无法进行第二阶段协商。解决办法有两个。一是在配置pre-sharkey的时候，指定使用该key的peer不进行xauth。命令 1crypto isakmp key XXXXX address 61.128.1.1 no-xauth 二是使用isakmp profile。 isakmp profileipsec profile的作用是对tunnel口的流量进行保护。而isakmp profile的作用主要是将一阶段的策略和第二阶段的策略进行绑定。常规配置的ipsec存在多个isakmp policy的时候，一二阶段协商过程是逐个查找从小到大进行匹配，并没有绑定对应的关系。 isakmp profile通过match identity来匹配远端设备，如EZVPN的group，L2L的peer address等。 修改上面的配置 123456789101112131415#去掉全局的配置no crypto map EZVPN client authentication list EZ-XAUTHno crypto map EZVPN isakmp authorization list EZ-MODE-CFGno crypto map EZVPN client configuration address respond #创建profile，匹配group,加入上面的1.5阶段配置crypto isakmp profile EZVPN-PROF match identity group EZ-GROUP client authentication list EZ-XAUTH isakmp authorization list EZ-MODE-CFG client configuration address respond #在dynamic map下调用crypto dynamic-map DYNAMIC-MAP 20 set isakmp-profile EZVPN-PROF L2L IPSec VPN修改： 1234567891011121314151617181920crypto keyring L2L-keyring pre-shared-key address 61.128.1.1 key NBMA-KEYcrypto isakmp policy 10 encr 3des authentication pre-share group 2crypto isakmp profile L2L-PROFILE keyring L2L-keyring match identity address 61.128.1.1 255.255.255.255 crypto ipsec transform-set L2L-SET esp-des esp-md5-hmac mode tunnelcrypto map DJ-MAP 10 ipsec-isakmp set peer 61.128.1.1 set transform-set L2L-SET set isakmp-profile L2L-PROFILE match address BJZB-YZIDC 关于isakmp profile调用的位置：和转换集transform-set在一起调用 ezvpn特性隧道分离默认EZVPN是tunnel-everything，所有流量包括直连的局域网的流量全都走到远端。 123456#源是远端网络，目的是any，到客户端看到的是一条目的路由ip access-list extended tunnel-split permit ip 10.0.0.0 0.0.255.255 anycrypto isakmp client configuration group EZ-GROUP acl tunnel-split save-password默认不允许客户端保存password，可以通过策略启用 12crypto isakmp client configuration group EZ-GROUP save-password backup-gateway备用网关，当EZVPN server不可用时，根据策略配置的backup-gateway发起连接请求 123crypto isakmp client configuration group EZ-GROUP backup-gateway second.nbma.info backup-gateway 61.128.1.1 banner连接成功之后弹出banner 12crypto isakmp client configuration group EZ-GROUP banner ^welcome to nbma!^ 硬件客户端使用思科路由器作为客户端,有3中连接模式client/network-extension/network-plus 12345678910111213crypto ispec client EZ-CLIENT connect [manual/auto] group EZ-GROUP key NBMAKEY mode [client/network-extension/network-plus] peer 61.128.1.1 #若果server启用了save-password: username cisco password ciscointerface f1/0 crypto ipsec client ezvpn EZ-CLIENT outsideinterface f1/1 crypto ipsec client ezvpn EZ-CLIENT inside 手动连接： 12345#发起连接crypto ipsec client ezvpn connect#调出“弹窗”crypto ipsec client ezvpn xauth输入用户名密码 模式client模式：客户端身后网络被转换成客户端获取的IP地址，客户端能访问server身后网络，反过来不行network-extension模式：不获取地址，两边使用真实地址，可相互访问network-plus模式：获取一个IP，用户server身后网络来网管客户端设备，其他和extension模式一样 DVTI技术之前的硬件客户端没有生成tunnel口，所以不支持动态路由、组播、QOS、acl、vrf等 server配置12345678910111213141516171819202122232425262728293031323334353637383940414243444546crypto isakmp policy 20 encr 3des authentication pre-share group 2crypto isakmp client configuration group EZ-GROUP key NBMAKEY#配置xauthaaa new-modelaaa authentication login EZ-XAUTH localaaa authorization network EZ-MODE-CFG local username cisco password 0 cisco#如果只是DVTI的话，不需要配置pool。配置之后同时支持软件拨入#ip local pool POOL 11.11.11.10 11.11.11.110#crypto isakmp client configuration group EZ-GROUP# pool POOLip access-list extended tunnel-split permit ip 10.0.0.0 0.0.255.255 anycrypto isakmp client configuration group EZ-GROUP acl tunnel-splitcrypto isakmp porfile IKS-PROF match identity group EZ-GROUP client authentication list EZ-XAUTH isakmp authorization list EZ-MODE-CFG client configuration address respond virtual-template 100crypto ipsec transform-set TRANS esp-3des esp-sha-hmac mode tunnelcrypto ipsec profile IPS-PROF set transform-set TRANS set isakmp-profile IKS-PROFinterface Virtual-Template 100 type tunnel #借一个有ip地址的接口 ip unnumbered f0/0 tunnel source f0/0 tunnel mode ipsec ipv4 tunnel protection ipsec profile IPS-PROF 客户端配置12345678910111213141516interface Virtual-Template 56 type tunnel #借一个有ip地址的接口 ip unnumbered f0/0crypto ipsec client ezvpn DVTI-VPN connect auto group EZ-GROUP key NBMAKEY mode network-extension peer 61.128.1.1 virtual-interface 56interface f1/0 crypto ipsec client ezvpn DVTI-VPN outsideinterface f1/1 crypto ipsec client ezvpn DVTI-VPN inside 连接： 12345#发起连接crypto ipsec client ezvpn connect#调出“弹窗”crypto ipsec client ezvpn xauth输入用户名密码 客户端生成一个隧道分离的静态路由，出接口是virtual access口.服务器自动生成一个客户端inside网段的静态路由，出接口是virtual access口 跑动态路由的话，只能在接口下配置，不能用network宣告，因为虚模板没地址 1234567#server端interface Virtual-Template 100 type tunnel ip ospf 1 area 0#client端interface Virtual-Template 56 type tunnel ip ospf 1 area 0","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"},{"name":"EZVPN","slug":"EZVPN","permalink":"http://nbma.info/tags/EZVPN/"}]},{"title":"GETVPN介绍及配置","slug":"getvpn","date":"un33fin33","updated":"un66fin66","comments":true,"path":"getvpn/","link":"","permalink":"http://nbma.info/getvpn/","excerpt":"Group Encrypted Transport VPN，思科私有技术用于内网（全局可路由）加密的VPN，不是互联网VPN（peer无法直接路由）目前的场景是用于加密MPLS VPN，因为MPLS本身只是加标签，并没有加密","text":"Group Encrypted Transport VPN，思科私有技术用于内网（全局可路由）加密的VPN，不是互联网VPN（peer无法直接路由）目前的场景是用于加密MPLS VPN，因为MPLS本身只是加标签，并没有加密 封装格式copy原始IP头部，然后内部用ESP加密IP数据报文，不影响QoS 123+----------—+—-------+--------------+| 原始IP头部 | esp头部 | 加密原始IP报文 |+-----------+--------+--------------+ 原理组成员Group Member向密钥服务器Key Server注册，KS上配置策略，产生一个ipsec sa，向同一组的GM推送sa和感兴趣流。组内成员可以实现any-to-any通讯，支持单播和组播 KS：验证组成员，管理安全策略，产生组密钥，分发策略和密钥，并不能加解密数据GM：加密设备，组播参与者，在安全和不安全区域执行路由。GETVPN最好有组播环境，这样KS只向一个组播地址分发即可。GDOI: Group Domain of Interpretation 公有协议，用于KS和GM之间通讯，和其他厂商兼容，UDP848 KSCP: Cooperative Protocol 协作协议，思科私有，用于主KS和备份KS通讯 协商过程GM &lt;—-&gt; KS：ike第一阶段协商，验证GM，6个包工作在UDP848，不是UDP500，生成IKE SAGM ——&gt; KS：使用ike sa加密，提供group IDGM &lt;—— KS**：使用ike sa加密，发送安全策略 .**GM ——&gt; KS：使用ike sa加密，确认GM &lt;—— KS：使用ike sa加密，发送TEK,KEK…..GM &lt;—— KS：使用KEK加密，周期更新密钥,rekey sa的密钥….. TKE 用于GM之间加密,ipsec sa的密钥 配置KS配置123456789101112131415161718192021222324252627282930313233343536373839404142434445464748#生成rsa密钥，用于前面rekey,ip domain name nbma.infocrypto key gemerate ras label GETVPN_KEY modulus 1024 exportable#ike第一阶段，所有ks和gm的预共享密钥crypto isakmp policy 10 authentication pre-sharecrypto isakmp key PRE-KEY address 10.1.1.1crypto isakmp key PRE-KEY address 10.1.1.2crypto isakmp key PRE-KEY address 10.1.1.254#感兴趣流ip access-list ex GETVPN_traffic primit ip 10.1.0.0 0.0.255.255 10.1.0.0 0.0.255.255#rekey更新流量ip access-list ex GETVPN_muiltucast primit udp host 10.1.1.1 eq 848 host 239.1.1.1 eq 848#定义转换集和profilecrypto ipsec transform-set TRANS esp-3des esp-md5-hmaccrypto ipsec profile IPSPROF set transform-set TRANS#GDOI组，组名本地有效crypto gdoi group GDOI_GROUP #所有的KS,GM的id要一致 identity number 66666 #指定本地作为KS服务器 server local address ipv4 10.1.1.1#指定rsa用于签名 rekey authentication mypubkey rsa GETVPN_KEY#如果用单播rekey还需要敲：rekey transport unicast#对rekey的加密算法（可选，默认3des） rekey algorithm aes 256#rekey更新流量 rekey address ipv4 GETVPN_muiltucast# 配置ipsec sa sa ipsec 1 match address ipv4 GETVPN_traffic profile IPSPROF reply time windows-size 3 GM配置1234567891011121314151617crypto isakmp policy 10 authentication pre-share#只需要配置主备ks的预共享密钥crypto isakmp key PRE-KEY address 10.1.1.1crypto isakmp key PRE-KEY address 10.1.1.2crypto gdoi group GDOI-GROUP identity number 66666 server address ipv4 10.1.1.1 server address ipv4 10.1.1.2crypto map GDOI-MAP 10 gdoi set group GDOI-GROUPinerface e0/0 crypto map GDOI-MAP 其他命令1234567891011#在ks上查看GM注册信息show crypto gdoi ks member #在gm上查看gdoishow crypto gdoi#在GM上设置bypass流量，只能denyip access-list external GM-ACL deny ip 10.1.0.0 0.0.255.255 10.1.2.0 0.0.0.255crypto map GDOI-MAP 10 gdoi match address GM-ACL 主备KS配置手动同步。手敲相同的配置，包括rsa密钥对，感兴趣流，转换及，ipsec sa的lifetime 1234567891011121314151617181920212223#在KS1上crypto gdoi group GDOI_GROUP server local redundancy peer address ipv4 10.1.1.2 local priority 100(越大越优先)#导出KS1的key crypto key export rsa GETVPN_KEY pem terminal 3des csico123#在KS2上导入密钥crypto key import rsa GETVPN_KEY pem terminal 3des csico123复制公钥复制私钥quit #（策略-略）crypto gdoi group GDOI_GROUP server local redundancy peer address ipv4 10.1.1.1 local priority 75","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"},{"name":"GETVPN","slug":"GETVPN","permalink":"http://nbma.info/tags/GETVPN/"}]},{"title":"ipsec&pptp&l2tp简单概念","slug":"ipsec-pptp-l2tp","date":"un33fin33","updated":"un22fin22","comments":true,"path":"ipsec-pptp-l2tp/","link":"","permalink":"http://nbma.info/ipsec-pptp-l2tp/","excerpt":"写的有点乱","text":"写的有点乱 动态map和静态map使用场景：hub固定IP，另一端没有固定IP。适用于思科和其他厂商对接。两端都是思科可以使用EZVPNpeer端直接普通的静态map配置hub端使用动态map 123crypto dynamic-map DY-MAP 10 set transform-set TRANS crypt\bo map STATIC-MAP 10000 ipsec-isakmp dynamic DY-MAP ikev2的SVTI待补充 NAT穿越问题ike 1-2包同时判断对方是否支持NAT-T3-4包发送NAT-D 第三个包hash自己的源目IP将值发送给B，然后对端收到后用收到的源目IP进行hash，如果不一致则后续5-6等包全都启用udp4500封装。 远程拨号VPN1，vpdn：pptp, l2tp over ipsec2，EzVPN3，SSL VPN pptp协商过程：TCP 1723PPP封装内层，外层是GRE，本身并不加密IPSEC只能用来加密IP流量，而PPTP还支持非IP,如IPX等在ASA上需要inspect pptp解决穿越问题 l2tp over ipsecL2TP:UDP1701PPP封装内层，外层是UDP，本身并不加密配合ipsec之后在PPP之外加上esp，对esp内部加密 平常不需要使用以下技术，直接使用GRE over IPSec或者SVTI直接跑动态即可 RRI反向路由注入多个ipsec vpn出口前往同一个peer是用来解决路由问题。根据active sa产生前往对端通讯店的静态路由 ，下一条是对端加密点IP。本地设备可以通过tag配置该路由，重分布进动态路由即可。 123crypto map XXX-MAP reverse route reverse route tag 10 DPD死亡对等体检测ikev1默认没有启用keepalive机制（类似路由协议hello）,所有如果对端peer down，本地无法得知，需要等待ipsec sa超时（1小时）后才发现。而DPD就是通过心跳检测对端peer是否active 两种模式periodic(周期) 和 on-demand（按需，默认）periodic：周期发送，占用加解密资源，检测快。5次失败之后自动清除sa 12crypto isakmp keepalive &lt;time&gt; periodicclear crypto ipsec sa on-demand：发送加密包出去，一定时间内没有解密包回来，这时候DPD会发送询问。如果一直有加解密，或者没有任何加解密被发送，那么不会发送查询。节约资源，但是可能存在一端sa被清，一端sa还存在 12crypto isakmp keepalive &lt;time&gt;clear crypto ipsec sa","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"},{"name":"ipsec","slug":"ipsec","permalink":"http://nbma.info/tags/ipsec/"}]},{"title":"使用ikev2配置IPSecVPN(思科IOS/ASA)","slug":"ipsec-ikev2-config","date":"un33fin33","updated":"un55fin55","comments":true,"path":"ipsec-ikev2-config/","link":"","permalink":"http://nbma.info/ipsec-ikev2-config/","excerpt":"","text":"IOS配置1234567891011121314151617181920212223242526272829303132333435363738crypto ikev2 proposal IKE_PROP encryption 3des aes-cbc-256 integrity sha256 sha512 group 2 5 14 prf sha256 sha(对随机数加密之后得到新的‘随机值’)crypto ikev2 policy IKE_PROL proposal IKE_PROPcrypto ikev2 keyring IKE_KEY peer PEER_B address 23.1.1.3 pre-shared-key IPSECKEYcrypto ikev2 profile IKE_PROF match identity remote address 23.1.1.3 255.255.255.255 identity local address 12.1.1.1 authentication local pre-share authentication remote pre-share keyring local IKE_KEYcrypto ipsec transform-set TRANS1 esp-des esp-md5-hmac mode tunnelcrypto ipsec transform-set TRANS2 esp-3des esp-sha256-hmac mode tunnelip access-list extended VPN permit ip 14.1.1.0 0.0.0.255 35.1.1.0 0.0.0.255crypto map IKE_MAP 10 ipsec-isakmp set peer 23.1.1.3 set transform-set TRANS1 TRANS2 set ikev2-profile IKE_PROF match address VPNinterface e0&#x2F;0 crypto map IKE_MAP ASA配置123456789101112131415161718192021222324crypto ikev2 enable outsidecrypto ikev2 policy 10 encryption aes-256 3des integrity sha512 sha256 group 5 2 1 prf sha256 sha lifetime seconds 86400tunnel-group 12.1.1.1 type ipsec-l2ltunnel-group 12.1.1.1 ipsec-attributes ikev2 remote-authentication pre-shared-key IPSECKEY ikev2 local-authentication pre-shared-key IPSECKEYcrypto ipsec ikev2 ipsec-proposal TRANS protocol esp encryption aes-192 des protocol esp integrity sha-1 md5access-list VPN extended permit ip 35.1.1.0 255.255.255.0 14.1.1.0 255.255.255.0 crypto map IKE_VPN 10 match address VPNcrypto map IKE_VPN 10 set peer 12.1.1.1 crypto map IKE_VPN 10 set ikev2 ipsec-proposal TRANScrypto map IKE_VPN interface outside","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"},{"name":"asa","slug":"asa","permalink":"http://nbma.info/tags/asa/"},{"name":"ipsec","slug":"ipsec","permalink":"http://nbma.info/tags/ipsec/"}]},{"title":"ipsec协商过程分析","slug":"ipsec-theory","date":"un66fin66","updated":"un55fin55","comments":true,"path":"ipsec-theory/","link":"","permalink":"http://nbma.info/ipsec-theory/","excerpt":"ipsec vpn，刚学完的时候以为自己掌握的还挺好的，各种排错无压力。去年到电信面试，连基本过程都说不清楚了，就记得是非对称加密协商对称加密的算法和密钥。说了一句跟HTTPS原理差不多……欸。趁着周末闲了赶紧再补补。","text":"ipsec vpn，刚学完的时候以为自己掌握的还挺好的，各种排错无压力。去年到电信面试，连基本过程都说不清楚了，就记得是非对称加密协商对称加密的算法和密钥。说了一句跟HTTPS原理差不多……欸。趁着周末闲了赶紧再补补。 重新梳理了以前掌握的不清楚的几个概念，新学习了ikev2的原理和原理，放一起对比下常说的ipsec第一阶段协商的6个包或者总共9个包指的是ikev1的主模式。ikev1（即isakmp）第一阶段： isakmp sa主动模式：使用预共享密钥的远程拨号VPN（即思科私有的EZVPN），第一阶段只有3个包主模式：第一阶段6个包第二阶段： ipsec sa快速模式：3个包 ikev1的ipsec协商总共9个包，在没有nat穿越的情况下，这9个包的源目端口都是UDP 500，使用isakmp封装。9个包之后加密ESP封装。 ikev2第一阶段：ike_sa_init（2个包）第二阶段：ike_auth（2个包） 同样，这4个包的源目端口都是UDP 500，使用isakmp封装。4个包之后加密ESP封装。 SA和SPI：安全关联，分为ike sa和ipsec sa，包含封装方式，验证算法，加密算法，预共享密钥等IKE sa:双向的，一致，默认有效期一天IPSec sa:单向的，A-&gt;B，B-&gt;A，默认有效期一小时SPI: 一串hash值，32bit，唯一标识一组sa，通常写作8位16进制 PFS: 完美向前保密，思科默认情况下面没有启用，ipsec sa的一个过期之后，重新生成的新KEY是有上一个key演算得到，开启PFS后，将重新交换DH协商新的密钥 ikev1协商过程 第一阶段第1-2包协商对ike过程的加密策略，发起方A发送自己的支持ike policy，B选择一组自己支持的policy发送给A 第一阶段第3-4包使用1-2的DH强度，交互DH。这个阶段用于生成非对称加密算法（由1-2阶段协商）的三对密钥 第一阶段第5-6包认证，使用3-4形成的第一把密钥，加密内容是预共享密钥，用于验证双方身份，使用第二把密钥做完整性校验，形成IKE SA 第二阶段第1-2包交换ipsec polcy（感兴趣流，transform-set）,协商对数据（感兴趣流）的加密策略,使用第一把密钥加密，第二把密钥校验完整性 第二阶段第3个包确认，形成两个ipsec sa的SPI代表控制层结束 A出方向的SPI=B入方向的SPI，A入方向的SPI=B出方向的SPI 最终，对感兴趣流使用第三把密钥对数据进行加密，使用第二阶段1-2协商的加密策略 ikev2协商过程第一阶段第1-2包相当于ikev1第一阶段的1-4 第二阶段第3-4包相当于ikev1第一阶段的5-6和第二阶段的1-3图中cisco FlexVPN即思科的ikev2 vpn ikev1的esp数据包结构esp的加密位置1、传输模式：通讯点和加密点一致这种模式下ESP报头在ip 头部之内，对四层以内的报头和数据进行加密2、隧道模式：通讯点和加密点不一致ESP直接将原来三层以内的报文全部加密，重新生成新的ip头部 这两种模式相比，transform模式数据比原数据包只多了一个esp头部，包长度有优势，传输效率高；tunnel模式在处理数据的时候不要拆开IP头部，直接加密，更快。 这部分由于ESP之后的部分全是加密的，所以只能通过数据包大小来对比.需要真机实现，等有机会了再做，模拟器只能为transport，设置tunnel无效 GRE头部的位置我是按照这个拓扑做的测试对比，主要看包接口和后续ESP数据包的大小从思科设备发起的ping默认大小是14+28+72=114Bytes.GRE头部大小是24Bytes 基于感兴趣流的IPSEC GRE over IPSec 思科的IPSec over GRE至于为什么会有这个，我看能百度搜到的华为设备全是按照这种方式配置的，蛋疼。 思科的SVTI技术tunnel模式设置为tunnel mode ipsec ipv4，其他配置和GRE over IPSec完全一样 思科的SVTI技术确实厉害~","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"},{"name":"ipsec","slug":"ipsec","permalink":"http://nbma.info/tags/ipsec/"}]},{"title":"在nginx部署https","slug":"nginx-deploy-https","date":"un11fin11","updated":"un66fin66","comments":true,"path":"nginx-deploy-https/","link":"","permalink":"http://nbma.info/nginx-deploy-https/","excerpt":"上周看nginx视频，中间看到https的部署，发现了很多自己一直以来都能接触到，但是完全不了解的专业名词。于是暂停视频，花了三天的时间，吧https相关的协议原理和证书类型都了解一下。","text":"上周看nginx视频，中间看到https的部署，发现了很多自己一直以来都能接触到，但是完全不了解的专业名词。于是暂停视频，花了三天的时间，吧https相关的协议原理和证书类型都了解一下。 周末重写了https的工作原理，今天快下班没事，吧https部署写一下。之后就要开始撸ansible了。 证书类型目前主流的SSL证书主要分为DV SSL 、 OV SSL 、EV SSL。 数字证书 DV SSL OV SSL EV SSL 用户建议 个人 组织、企业 大型企业、金融机构 公信等级 一般 高 强 认证强度 网站真实性 组织及企业真实性 严格认证 安全性 一般 中 高 可信度 常规 中 高（地址栏绿色） 要购买或者签发SSL证书，需要先在本地生成CSR，其中包含域名、所有人、位置等，然后根据CSR签发对应的证书。 自签证书CentOS系统已经安装了openssl，可以用来生成自签证书，但是这种证书由于其CA不在主机的受信任列表，只能用来做加密，无法提供任何验证，而且需要在浏览器中手动确认。 123456#生成私钥 openssl genrsa -idea -out mansur.key 1024#生成证书申请请求CSR openssl req -new -key mansur.key -out mansur.csr#使用私钥签发证书 openssl x509 -req -days 3650 -in mansur.csr -signkey mansur.key -out mansur.crt 12#直接生成符合苹果ATS规范的证书和对应私钥 openssl req -days 3650 -x509 -sha256 -nodes -newkey rsa:2048 -keyout mansur.key -out mansur_apple.crt 示例： 12345678910111213141516171819202122232425[root@CentOS7-copy tmp]# openssl req -days 3650 -x509 -sha256 -nodes -newkey rsa:2048 -keyout mansur.key -out mansur_apple.crtGenerating a 2048 bit RSA private key....+++.........................................................................................................................+++writing new private key to &#x27;mansur.key&#x27;-----You are about to be asked to enter information that will be incorporatedinto your certificate request.What you are about to enter is what is called a Distinguished Name or a DN.There are quite a few fields but you can leave some blankFor some fields there will be a default value,If you enter &#x27;.&#x27;, the field will be left blank.-----Country Name (2 letter code) [XX]:CNState or Province Name (full name) []:BeijingLocality Name (eg, city) [Default City]:ChaoyangOrganization Name (eg, company) [Default Company Ltd]:NBMABLOGOrganizational Unit Name (eg, section) []:NetCommon Name (eg, your name or your server&#x27;s hostname) []:nbma.infoEmail Address []:i@nbma.info[root@CentOS7-copy tmp]# ll总用量 12-rw-r--r-- 1 root root 1391 4月 17 10:14 mansur_apple.crt-rw-r--r-- 1 root root 1704 4月 17 10:14 mansur.key Let’s encrypt免费证书Let&#39;s encrypt可以签发免费的DV证书，常用于个人网站，但是其证书有效期只有三个月，需要手动续租。具体怎么签发，还有待研究，github上有很多脚本可以实现。签发完成后会得到四个文件 cert.pem #网站证书chain.pem #链证书fullchain.pem #网站证书+链证书privkey.pem #私钥 nginx配置不想写注释了，就这么看吧。 123456789101112131415161718192021222324252627282930server&#123; listen 80; listen 443 ssl http2; server_name nbma.info; index index.php index.html index.htm default.php default.htm default.html; root /www/wwwroot/nbma.info; #SSL-START SSL相关配置，请勿删除或修改下一行带注释的404规则 #error_page 404/404.html; #HTTP_TO_HTTPS_START if ($server_port !~ 443)&#123; rewrite ^(/.*)$ https://$host$1 permanent; &#125; #HTTP_TO_HTTPS_END ssl_certificate fullchain.pem; ssl_certificate_key privkey.pem; ssl_protocols TLSv1 TLSv1.1 TLSv1.2; ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE; ssl_prefer_server_ciphers on; ssl_session_cache shared:SSL:10m; ssl_session_timeout 10m; error_page 497 https://$host$request_uri; #SSL-END #.....&#125; 证书另外，做完上面这些发现有个问题，这些证书有的是.key格式，还有crt、pem等，专门查了一下，其实在unix中证书的这几个扩展名无所谓。他不过是一串字符串。但是，对于证书而言，他有两种不同的编码格式需要注意；首先所有的证书都是满足X.509标准的，这个标准定义了证书中应该包含哪些内容，具体需要查看RFC5280在这个标准之下，不同的操作系统或者中间件常用的编码方式也不一样： PEM - Privacy Enhanced Mail,打开看文本格式,以”—–BEGIN…”开头, “—–END…”结尾,内容是BASE64编码.查看PEM格式证书的信息:openssl x509 -in certificate.pem -text -nooutApache和Linux服务器偏向于使用这种编码格式。 DER - Distinguished Encoding Rules,打开看是二进制格式,不可读.查看DER格式证书的信息:openssl x509 -in certificate.der -text -noout -inform derJava和Windows服务器偏向于使用这种编码格式. 更多有关证书的说明，请查阅参考文档：那些证书相关的玩意儿(SSL,X.509,PEM,DER,CRT,CER,KEY,CSR,P12等)","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"centos","slug":"centos","permalink":"http://nbma.info/tags/centos/"},{"name":"https","slug":"https","permalink":"http://nbma.info/tags/https/"},{"name":"nginx","slug":"nginx","permalink":"http://nbma.info/tags/nginx/"}]},{"title":"802.1X认证过程(翻译)","slug":"8021X-auth-progression","date":"un22fin22","updated":"un66fin66","comments":true,"path":"8021X-auth-progression/","link":"","permalink":"http://nbma.info/8021X-auth-progression/","excerpt":"1、初始化当交换机检测到有新的请求者时，端口被启用，切状态是未授权。这种状态下，只允许802.1X的流量，其他流量（如TCP/UDP）将被丢弃。","text":"1、初始化当交换机检测到有新的请求者时，端口被启用，切状态是未授权。这种状态下，只允许802.1X的流量，其他流量（如TCP/UDP）将被丢弃。 2、启动为了启动认证，交换机将周期性的发送EAP-Request Identity帧到本地LAN中的特殊mac地址01:80:C2:00:00:03。请求者将侦听这个地址，并且在收到EAP-Request Identity时，使用包含请求者标识符（如用户ID）的EAP-Response Identity帧进行响应。交换机作为认证者，将此身份响应封装到Radius Access-Request数据包中，并转发到认证服务器。另外，请求者也可以通过向认证者发送EAPOL-Start帧来启动或重新启动认证，认证者使用EAP-Request Identity进行回复。 3、EAP协商身份认证服务器给交换机发送一个RADIUS Access-Challenge的回复报文，报文中包含了一个EAP Request，指定了EAP方法（认证服务器希望请求者使用的基于EAP的认证类型）。认证者将这个EAP Request封装到EAPOL帧中，转发给请求者。此时，请求者可以开始使用这个请求的EAP方法，或者执行NAK否认消息并响应一个自己希望执行的EAP方法。 4、认证如果请求和认证服务器同意之前的EAP方法，那么他们将会发送EAP Request和Responses给对方，通过认证者转发，直到认证服务器响应一个封装在RADIUS Access-Accept报文中的EAP-Success，或者封装在RADIUS Access-Reject报文中的EAP-Failure。如果认证成功，那么交换机端口将变为”授权”状态，允许所有正常流量。如果认证失败，交换机端口保持”未授权”状态。当申请者注销的时候，它会发送一个EAPOL-logoff信息给认证者，认证者改变端口状态到”未授权”，并阻止非EAP流量通过 封装过程：802.1x请求者 -- 交换机 -- 认证服务器 之间跑EAP协议请求者 -- 交换机 之间EAPOL,底层采用802.1x封装（二层封装）交换机 -- 认证服务器 之间EAPOR,采用radius封装（radius是udp） EAP的加密有很多种，常用的两种：EAP-TLS：需要自建CAEAP-PEAP：类似HTTPS 原文：IEEE 802.1X - 维基百科","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"},{"name":"802.1x","slug":"802-1x","permalink":"http://nbma.info/tags/802-1x/"}]},{"title":"SSLVPN基于角色（OU）的组策略分配","slug":"cisco-asa-ssl-vpn-policy-base-security-group","date":"un11fin11","updated":"un66fin66","comments":true,"path":"cisco-asa-ssl-vpn-policy-base-security-group/","link":"","permalink":"http://nbma.info/cisco-asa-ssl-vpn-policy-base-security-group/","excerpt":"之前已经说过了SSL VPN的基本配置，在此基础上，实现不同角色的用户使用不同的策略。","text":"之前已经说过了SSL VPN的基本配置，在此基础上，实现不同角色的用户使用不同的策略。 ASA防火墙根据用户的OU分配组策略的功能，是根据IETF的radius属性中的option 25实现的。radius服务器在进行身份验证和授权的过程中可以将包含用户OU的该属性值发送给ASA 注：IETF RADIUS option 25:RFC 2865 下面的配置案例，针对角色为SSLVPN-DBA的用户，ASA读取到这个属性时，将自动查询与该属性值一致的group-policy。 当一个用户存在多个OU时，ASA将按照ascii码表的顺序逐个查找角色对应的策略，一旦找到匹配，就不再查询其他角色。 Radius在防火墙配置组策略之前，需要在radius上对需要的用户分配相应的OU。 ASA针对SSLVPN-DBA角色配置策略aaa-server，tunnel-group配置在前一篇已写过 下发不同路由列表TECH-SPL1access-list TECH-SPL extended permit ip 172.17.0.0 255.255.0.0 any 配置group-policy，关联需要下发的路由TECH-SPL、访问控制SSL-ACL、地址池SSL-POOL12345678910111213141516group-policy SSLVPN-DBA internalgroup-policy SSLVPN-DBA attributes dns-server value 192.168.115.11 192.168.115.12 vpn-simultaneous-logins 30 vpn-idle-timeout 120 vpn-filter value SSL-ACL vpn-tunnel-protocol ssl-client split-tunnel-policy tunnelspecified split-tunnel-network-list value TECH-SPL address-pools value SSL-POOL webvpn anyconnect ssl dtls enable anyconnect mtu 1200 anyconnect keep-installer installed anyconnect dtls compression lzs anyconnect ask none default anyconnect Debugging在ASA上使用这两个命令查看debug debug radius all - 查看radius服务器的响应以及用户属性show vpn-sessiondb anyconncet - 查看anyconnect用户分配的组策略和隧道组 12345#debug radius allRadius: Type = 25 (0x19) ClassRadius: Length = 17 (0x11)Radius: Value (String) = 4d 6f 62 69 6b 65 2d 45 76 65 72 79 6f 6e 65 | SSLVPN-DBA 123456789101112131415#show vpn-sessiondb anyconncetUsername : v-KarlAndroRivera Index : 95Assigned IP : 1.2.3.4 Public IP : 5.6.7.8Protocol : AnyConnect-Parent SSL-TunnelLicense : AnyConnect PremiumEncryption : AnyConnect-Parent: (1)none SSL-Tunnel: (1)AES-GCM-256Hashing : AnyConnect-Parent: (1)none SSL-Tunnel: (1)SHA384Bytes Tx : 793552 Bytes Rx : 604215Group Policy : SSLVPN-DBA Tunnel Group : DefaultWEBVPNGroupLogin Time : 13:02:57 beijing Mon Oct 29 2017Duration : 1h:23m:09sInactivity : 0h:00m:00sVLAN Mapping : N/A VLAN : noneAudt Sess ID : ac11003d0005f0005bd69481Security Grp : none 参考文档:Cisco ASA - Group-policy assignment based on OU","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"},{"name":"asa","slug":"asa","permalink":"http://nbma.info/tags/asa/"},{"name":"SSLVPN","slug":"SSLVPN","permalink":"http://nbma.info/tags/SSLVPN/"}]},{"title":"思科ASA配置SSLVPN","slug":"cisco-asa-ssl-vpn-configure","date":"un11fin11","updated":"un66fin66","comments":true,"path":"cisco-asa-ssl-vpn-configure/","link":"","permalink":"http://nbma.info/cisco-asa-ssl-vpn-configure/","excerpt":"在ASA配置SSL VPN过程如下，","text":"在ASA配置SSL VPN过程如下， 接口和默认路由 略 创建地址池SSL-POOL1ip local pool SSL-POOL 172.17.44.2-172.17.47.254 mask 255.255.252.0 配置区域策略12same-security-traffic permit inter-interfacesame-security-traffic permit intra-interface 定义下发路由SSL-SPL123456access-list SSL-SPL extended permit ip 172.17.0.0 255.255.0.0 any access-list SSL-SPL extended permit ip 10.0.0.0 255.255.0.0 any access-list SSL-SPL extended permit ip 10.201.0.0 255.255.0.0 any access-list SSL-SPL extended permit ip 192.168.96.0 255.255.224.0 any access-list SSL-SPL extended permit ip 10.101.0.0 255.255.0.0 any access-list SSL-SPL extended permit ip 10.12.0.0 255.255.0.0 any 定义ACL策略SSL-ACL(可选)1access-list SSL-ACL extended permit ip any any 定义radius认证服务器SSL(可选)12345aaa-server SSL protocol radiusaaa-server SSL (inside) host 172.17.40.41 key XXXXXXXX authentication-port 1812 accounting-port 1813 允许inside管理(可选)1management-access inside 指定anyconnect客户端123456789webvpn enable inside anyconnect image disk0:/anyconnect-win-4.4.03034-webdeploy-k9.pkg 1 anyconnect image disk0:/anyconnect-macos-4.4.04030-webdeploy-k9.pkg 2 anyconnect image disk0:/anyconnect-linux64-4.4.04030-webdeploy-k9.pkg 3 anyconnect enable cache disable error-recovery disable 配置group策略SSL-POLICY，关联需要下发的路由SSL-SPL、访问控制SSL-ACL、地址池SSL-POOL1234567891011121314151617group-policy SSL-POLICY internalgroup-policy SSL-POLICY attributes dns-server value 192.168.115.11 192.168.115.12 vpn-simultaneous-logins 30 vpn-idle-timeout 120 #VPN过滤可选…… vpn-filter value SSL-ACL vpn-tunnel-protocol ssl-client split-tunnel-policy tunnelspecified split-tunnel-network-list value SSL-SPL address-pools value SSL-POOL webvpn anyconnect ssl dtls enable anyconnect mtu 1200 anyconnect keep-installer installed anyconnect dtls compression lzs anyconnect ask none default anyconnect 如果mtu太大，可能会出现“首次连接后断线，再次连接正常”的现象 默认tunnel-group关联策略，关联认证radius服务器SSL和group策略SSL-POLICY1234tunnel-group DefaultWEBVPNGroup general-attributes authentication-server-group SSL accounting-server-group SSL default-group-policy SSL-POLICY","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"},{"name":"asa","slug":"asa","permalink":"http://nbma.info/tags/asa/"},{"name":"SSLVPN","slug":"SSLVPN","permalink":"http://nbma.info/tags/SSLVPN/"}]},{"title":"cisco路由器nat回流解决办法--NVI","slug":"cisco-nat-nvi-back","date":"un66fin66","updated":"un55fin55","comments":true,"path":"cisco-nat-nvi-back/","link":"","permalink":"http://nbma.info/cisco-nat-nvi-back/","excerpt":"困扰已久的路由器映射的回流问题终于解决了。","text":"困扰已久的路由器映射的回流问题终于解决了。 回流，简单的说就是内网终端通过映射后的公网地址访问内网服务。通常配置的inside-outside模式的nat是无法实现回流的， Cisco的domainless NATDomainless就是说不再区分inside和outside，只是单纯地做NAT，用一个叫做NAT Virtual Interface的虚拟接口来实现，这样有什么好处呢？说实话，从界面上看不出来，但是从其实现角度，就可以通过路由的方式将带有ip nat enable配置的接口进来的包全部导入这个虚拟接口NVI0中。然后用数据包的源地址和目标地址分别查询SNAT表和DNAT表，根据结果进行NAT操作，随后进入真正的路由查询。 不管方向，不管路由，只要数据包进入了一块带有ip nat enable配置的物理网卡，就会进行NAT匹配以及匹配成功后的操作，不管是SNAT和DNAT都在这里进行。这个实现虽然很豪放，但是却解决了所有问题。 数据包在进入真正的路由查询前，NAT就已经完成了，在路由器看来，NAT操作被藏起来了，就好像数据包本来就是那个样子一样。当然Domainless的NAT也不再和任何其它操作关联，ACL，VPN感兴趣流匹配，policy routing等都和NAT无关。 如以上拓扑，将R3的80端口映射到外网，那么R2将无法使用公网地址访问R3该方式的传统的端口映射为： 1234567ip nat inside source static tcp 10.1.12.2 80 61.128.1.1 8000ip nat inside source static tcp 10.1.12.2 80 61.128.1.3 80ip nat inside source list NAT interface e0&#x2F;0 overloadinterface e0&#x2F;0ip nat outsideinterface e0&#x2F;1ip nat inside 更改为NVI NAT： 1234567ip nat source static tcp 10.1.12.2 80 61.128.1.1 8000ip nat source static tcp 10.1.12.2 80 61.128.1.3 80ip nat source list NAT interface e0&#x2F;0 overloadinterface e0&#x2F;0ip nat enableinterface e0&#x2F;1ip nat enable 更改为NVI NAT可能内网还是无法通过公网地址访问内网服务器，此时有个重要的一点是要关闭端口的重定向功能： 1234interface e0&#x2F;0no ip redirectsinterface e0&#x2F;1no ip redirects 这样配置即可完成，检查状态命令为：show ip nat nvi translations 1234sh ip nat nvi translations Pro Source global Source local Destin local Destin globaltcp 61.128.1.1:28909 10.1.11.2:28909 61.128.1.3:80 10.1.12.2:80tcp 61.128.1.1:8000 10.1.12.2:80 --- --- 访问测试OK。同时也能看到，现在内部终端R2通过公网地址访问R3的时候，源地址也被nat为出口路由器的公网地址。","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"},{"name":"nat","slug":"nat","permalink":"http://nbma.info/tags/nat/"}]},{"title":"grafana添加zabbix源和prometheus源","slug":"grafana-zabbix-prometheus","date":"un11fin11","updated":"un66fin66","comments":true,"path":"grafana-zabbix-prometheus/","link":"","permalink":"http://nbma.info/grafana-zabbix-prometheus/","excerpt":"grafana是用于可视化大型测量数据的开源程序，他提供了强大和优雅的方式去创建、共享、浏览数据。dashboard中显示了你不同metric数据源中的数据。","text":"grafana是用于可视化大型测量数据的开源程序，他提供了强大和优雅的方式去创建、共享、浏览数据。dashboard中显示了你不同metric数据源中的数据。 安装grafana(官方download](https://grafana.com/grafana/download) 12345wget https:&#x2F;&#x2F;s3-us-west-2.amazonaws.com&#x2F;grafana-releases&#x2F;release&#x2F;grafana-5.0.3-1.x86_64.rpm sudo yum localinstall grafana-5.0.3-1.x86_64.rpm systemctl start grafana-serversystemctl enable grafana-server 安装完成后访问Dashboard:http://本机IP:3000默认用户名密码都是admin 安装最新zabbix插件grafana-cli plugins install alexanderzobnin-zabbix-app 完成后在grafan Dashboard添加数据源： 1234type: zabbix apphttp url: http:&#x2F;&#x2F;zbx_IP&#x2F;zabbix&#x2F;api_jsonrpc.phpUsername: AdminPassword: ****** Save &amp; Test保存 在Dashboards页面导入自带的zabbix Status模板 添加prometheus数据源添加数据源： 1234Name:PrometheusType:PrometheusUrl:http:&#x2F;&#x2F;prometheus_ip:9090&#x2F;Access:proxy 在Dashboards页面导入自带的Prometheus Status模板和Grafana模板 目前grafana status模板是完全没有数据的，需要先添加监控在prometheus.yml中添加如下内容 12345- job_name: &#39;grafana&#39; static_configs: - targets: [&#39;**GRAFANA_IP**:9100&#39;] labels: instance: grafana 重启prometheussystemctl restart prometheus 在查看应该会获取到grafana server的一些数据。 另外grafana官方也有一些模板可以参考，在garfana dashboard中import Dashboard输入编号405，即https://grafana.com/dashboards/405导入即可。 有关zabbix和prometheus安装，参考：zabbix安装Prometheus安装","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"monitor","slug":"monitor","permalink":"http://nbma.info/tags/monitor/"},{"name":"zabbix","slug":"zabbix","permalink":"http://nbma.info/tags/zabbix/"}]},{"title":"Prometheus入门","slug":"Prometheus-base","date":"un44fin44","updated":"un66fin66","comments":true,"path":"Prometheus-base/","link":"","permalink":"http://nbma.info/Prometheus-base/","excerpt":"Prometheus的基本原理是通过HTTP协议周期性抓取被监控组件的状态，任意组件只要提供对应的HTTP接口就可以接入监控。不需要任何SDK或者其他的集成过程。这样做非常适合做虚拟化环境监控系统，比如VM、Docker、Kubernetes等。","text":"Prometheus的基本原理是通过HTTP协议周期性抓取被监控组件的状态，任意组件只要提供对应的HTTP接口就可以接入监控。不需要任何SDK或者其他的集成过程。这样做非常适合做虚拟化环境监控系统，比如VM、Docker、Kubernetes等。 输出被监控组件信息的HTTP接口被叫做exporter 。目前互联网公司常用的组件大部分都有exporter可以直接使用，比如Varnish、Haproxy、Nginx、MySQL、Linux系统信息(包括磁盘、内存、CPU、网络等等)。 Prometheus服务过程大概是这样： Prometheus Daemon负责定时去目标上抓取metrics(指标)数据，每个抓取目标需要暴露一个http服务的接口给它定时抓取。Prometheus支持通过配置文件、文本文件、Zookeeper、Consul、DNS SRV Lookup等方式指定抓取目标。Prometheus采用PULL的方式进行监控，即服务器可以直接通过目标PULL数据或者间接地通过中间网关来Push数据。 Prometheus在本地存储抓取的所有数据，并通过一定规则进行清理和整理数据，并把得到的结果存储到新的时间序列中。 Prometheus通过PromQL和其他API可视化地展示收集的数据。Prometheus支持很多方式的图表可视化，例如Grafana、自带的Promdash以及自身提供的模版引擎等等。Prometheus还提供HTTP API的查询方式，自定义所需要的输出。 PushGateway支持Client主动推送metrics到PushGateway，而Prometheus只是定时去Gateway上抓取数据。 Alertmanager是独立于Prometheus的一个组件，可以支持Prometheus的查询语句，提供十分灵活的报警方式。 Prometheus适用的场景Prometheus在记录纯数字时间序列方面表现非常好。它既适用于面向服务器等硬件指标的监控，也适用于高动态的面向服务架构的监控。对于现在流行的微服务，Prometheus的多维度数据收集和数据筛选查询语言也是非常的强大。Prometheus是为服务的可靠性而设计的，当服务出现故障时，它可以使你快速定位和诊断问题。它的搭建过程对硬件和服务没有很强的依赖关系。 Prometheus不适用的场景Prometheus它的价值在于可靠性，甚至在很恶劣的环境下，你都可以随时访问它和查看系统服务各种指标的统计信息。 如果你对统计数据需要100%的精确，它并不适用，例如：它不适用于实时计费系统。 Prometheus官网：https://prometheus.io/ 安装PrometheusPrometheus官方给出了多重部署方案，比如：Docker容器、Ansible、Chef、Puppet、Saltstack等。 Prometheus用Golang实现，因此具有天然可移植性(支持Linux、Windows、macOS和Freebsd)。这里直接使用预编译的二进制文件部署，开箱即用。 Prometheus安装 这里以Linux系统为例： 123$ wget https:&#x2F;&#x2F;github.com&#x2F;prometheus&#x2F;prometheus&#x2F;releases&#x2F;download&#x2F;v2.2.1&#x2F;prometheus-2.2.1.linux-amd64.tar.gz$ tar xzvf prometheus-2.2.1.linux-amd64.tar.gz$ mv prometheus-2.2.1.linux-amd64 &#x2F;usr&#x2F;local&#x2F;prometheus 其它系统版本可在这里下载：https://prometheus.io/download/ 验证安装 123456$ cd &#x2F;usr&#x2F;local&#x2F;prometheus$ .&#x2F;prometheus --versionprometheus, version 2.2.1 (branch: HEAD, revision: bc6058c81272a8d938c05e75607371284236aadc) build user: root@149e5b3f0829 build date: 20180314-14:15:45 go version: go1.10 配置Prometheus 在prometheus目录下有一个名为prometheus.yml的主配置文件。其中包含大多数标准配置及prometheus的自检控配置，默认配置文件如下： 12345678910111213141516171819202122232425262728293031$ cat &#x2F;usr&#x2F;local&#x2F;prometheus&#x2F;prometheus.yml# 全局配置global: scrape_interval: 15s # 默认抓取间隔, 15秒向目标抓取一次数据。 evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute. # scrape_timeout is set to the global default (10s). # 这个标签是在本机上每一条时间序列上都会默认产生的，主要可以用于联合查询、远程存储、Alertmanger时使用。 external_labels: monitor: &#39;codelab-monitor&#39;# Load rules once and periodically evaluate them according to the global &#39;evaluation_interval&#39;.rule_files: # - &quot;first.rules&quot; # - &quot;second.rules&quot;# 这里就表示抓取对象的配置# 这里是抓去promethues自身的配置scrape_configs:# job name 这个配置是表示在这个配置内的时间序例，每一条都会自动添加上这个&#123;job_name:&quot;prometheus&quot;&#125;的标签。 - job_name: &#39;prometheus&#39; # metrics_path defaults to &#39;&#x2F;metrics&#39; # scheme defaults to &#39;http&#39;. # \b重写了全局抓取间隔时间，由15秒重写成5秒。 scrape_interval: 5s static_configs: - targets: [&#39;localhost:9090&#39;] 创建用户 这里单独创建一个专门用于运行prometheus的用户，不用root运行程序是一种好习惯。主目录为/var/lib/prometheus，用作prometheus的数据目录。 12$ groupadd prometheus$ useradd -g prometheus -m -d &#x2F;var&#x2F;lib&#x2F;prometheus -s &#x2F;sbin&#x2F;nologin prometheus 创建Systemd服务 123456789101112$ vim &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;prometheus.service[Unit]Description&#x3D;prometheusAfter&#x3D;network.target[Service]Type&#x3D;simpleUser&#x3D;prometheusExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;prometheus&#x2F;prometheus --config.file&#x3D;&#x2F;usr&#x2F;local&#x2F;prometheus&#x2F;prometheus.yml --storage.tsdb.path&#x3D;&#x2F;var&#x2F;lib&#x2F;prometheusRestart&#x3D;on-failure[Install]WantedBy&#x3D;multi-user.target 启动Prometheus 1$ systemctl start prometheus 验证Prometheus是否启动成功 12345678$ systemctl status prometheus● prometheus.service - prometheus Loaded: loaded (&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;prometheus.service; disabled; vendor preset: disabled) Active: active (running) since Thu 2018-03-22 16:11:10 CST; 6s ago Main PID: 60721 (prometheus) CGroup: &#x2F;system.slice&#x2F;prometheus.service └─60721 &#x2F;usr&#x2F;local&#x2F;prometheus&#x2F;prometheus --config.file&#x3D;&#x2F;usr&#x2F;local&#x2F;prometheus&#x2F;prometheus.yml --storage.tsdb.path&#x3D;&#x2F;var&#x2F;li... 访问自带Web Prometheus自带一个比较简单的Web，可以查看表达式搜索结果、报警配置、prometheus配置,exporter状态等。自带Web默认在http://ip:9090。 Prometheus本身也是自带exporter的,我们通过请求 http://ip:9090/metrics 可以查看从exporter中能具体抓到哪些数据。 这里以Prometheus本身数据为例，简单演示下在Web中查询指定表达式及图形化显示查询结果。 使用Prometheus监控服务器上面用Prometheus本身的数据简单演示了监控数据的查询，这里我们用一个监控服务器状态的例子来更加直观说明。 为监控服务器CPU、内存、磁盘、I/O等信息，首先需要安装node_exporter。node_exporter的作用是用于机器系统数据收集。 安装node_exporter node_exporter也是用Golang实现，直接使用预编译的二进制文件部署，开箱即用。 123$ wget https:&#x2F;&#x2F;github.com&#x2F;prometheus&#x2F;node_exporter&#x2F;releases&#x2F;download&#x2F;v0.15.2&#x2F;node_exporter-0.15.2.linux-amd64.tar.gz$ tar -zxvf node_exporter-0.15.2.linux-amd64.tar.gz$ mv node_exporter-0.15.2.linux-amd64 &#x2F;usr&#x2F;local&#x2F;prometheus&#x2F;node_exporter 创建Systemd服务 123456789101112$ vim &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;node_exporter.service[Unit]Description&#x3D;node_exporterAfter&#x3D;network.target[Service]Type&#x3D;simpleUser&#x3D;prometheusExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;prometheus&#x2F;node_exporter&#x2F;node_exporterRestart&#x3D;on-failure[Install]WantedBy&#x3D;multi-user.target 启动Node exporter 1$ systemctl start node_exporter 验证Node exporter是否启动成功 12345678$ systemctl status node_exporter● node_exporter.service - node_exporter Loaded: loaded (&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;node_exporter.service; disabled; vendor preset: disabled) Active: active (running) since Thu 2018-03-22 16:14:04 CST; 6s ago Main PID: 60904 (node_exporter) CGroup: &#x2F;system.slice&#x2F;node_exporter.service └─60904 &#x2F;usr&#x2F;local&#x2F;prometheus&#x2F;node_exporter&#x2F;node_exporter 修改prometheus.yml，加入下面的监控目标： Node Exporter默认的抓取地址为http://IP:9100/metrics 1234567$ vim &#x2F;usr&#x2F;local&#x2F;prometheus&#x2F;prometheus.yml - job_name: &#39;linux&#39; static_configs: - targets: [&#39;localhost:9100&#39;] labels: instance: node1 prometheus.yml中一共定义了两个监控：一个是监控prometheus自身服务，另一个是监控Linux服务器。这里给个完整的示例： 1234567891011scrape_configs: - job_name: &#39;prometheus&#39; static_configs: - targets: [&#39;localhost:9090&#39;] - job_name: &#39;linux&#39; static_configs: - targets: [&#39;localhost:9100&#39;] labels: instance: node1 重启Prometheus 1$ systemctl restart prometheus 在Prometheus Web查看监控的目标 访问Prometheus Web，在Status-&gt;Targets页面下，我们可以看到我们配置的两个Target，它们的State为UP。","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"centos","slug":"centos","permalink":"http://nbma.info/tags/centos/"},{"name":"monitor","slug":"monitor","permalink":"http://nbma.info/tags/monitor/"}]},{"title":"nginx入门","slug":"learn-nginx","date":"un33fin33","updated":"un66fin66","comments":true,"path":"learn-nginx/","link":"","permalink":"http://nbma.info/learn-nginx/","excerpt":"nginx安装打开nginx.org查看最近稳定版，以下链接查看最新nginx的yum repo：http://nginx.org/en/linux_packages.html#stable","text":"nginx安装打开nginx.org查看最近稳定版，以下链接查看最新nginx的yum repo：http://nginx.org/en/linux_packages.html#stable 编辑/etc/yum.repo.d/nginx.repo填入以下内容： 12345[nginx]name&#x3D;nginx repobaseurl&#x3D;http:&#x2F;&#x2F;nginx.org&#x2F;packages&#x2F;OS&#x2F;OSRELEASE&#x2F;$basearch&#x2F;gpgcheck&#x3D;0enabled&#x3D;1 Replace “OS” with “rhel” or “centos”, depending on the distribution used, and “OSRELEASE” with “6” or “7”, for 6.x or 7.x versions, respectively. 然后使用yum list |grep nginx查看输出中是否含有nginx.x86_64如果有说明nginx repo安装成功。 安装nginxyum -y install nginx ##概述nginx -v 查看nginx版本 rpm -ql nginx 查看nginx目录 123456789101112131415161718192021222324252627282930313233&#x2F;etc&#x2F;logrotate.d&#x2F;nginx #nginx日志轮转，用于logratate服务的日志切割&#x2F;etc&#x2F;nginx #nginx主配置文件&#x2F;etc&#x2F;nginx&#x2F;conf.d #nginx主配置文件&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;default.conf #nginx默认配置文件&#x2F;etc&#x2F;nginx&#x2F;fastcgi_params #cgi配置相关&#x2F;etc&#x2F;nginx&#x2F;koi-utf #编码转换文件，映射转换文件&#x2F;etc&#x2F;nginx&#x2F;koi-win #编码转换文件，映射转换文件&#x2F;etc&#x2F;nginx&#x2F;mime.types #设置http协议的Content-Type与扩展名对应关系（nginx处理无法识别的扩展名时读取该文件）&#x2F;etc&#x2F;nginx&#x2F;modules #nginx模块目录&#x2F;etc&#x2F;nginx&#x2F;nginx.conf #nginx主配置文件&#x2F;etc&#x2F;nginx&#x2F;scgi_params #cgi配置相关&#x2F;etc&#x2F;nginx&#x2F;uwsgi_params #cgi配置相关&#x2F;etc&#x2F;nginx&#x2F;win-utf #编码转换文件，映射转换文件&#x2F;etc&#x2F;sysconfig&#x2F;nginx # 配置系统守护进程管理器管理方式&#x2F;etc&#x2F;sysconfig&#x2F;nginx-debug # 配置系统守护进程管理器管理方式&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;nginx-debug.service # 配置系统守护进程管理器管理方式&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;nginx.service # 配置系统守护进程管理器管理方式&#x2F;usr&#x2F;lib64&#x2F;nginx&#x2F;usr&#x2F;lib64&#x2F;nginx&#x2F;modules #nginx模块目录&#x2F;usr&#x2F;libexec&#x2F;initscripts&#x2F;legacy-actions&#x2F;nginx&#x2F;usr&#x2F;libexec&#x2F;initscripts&#x2F;legacy-actions&#x2F;nginx&#x2F;check-reload&#x2F;usr&#x2F;libexec&#x2F;initscripts&#x2F;legacy-actions&#x2F;nginx&#x2F;upgrade&#x2F;usr&#x2F;sbin&#x2F;nginx #nginx命令&#x2F;usr&#x2F;sbin&#x2F;nginx-debug #nginx命令&#x2F;usr&#x2F;share&#x2F;doc&#x2F;nginx-1.12.2 #帮助和手册&#x2F;usr&#x2F;share&#x2F;doc&#x2F;nginx-1.12.2&#x2F;COPYRIGHT #帮助和手册&#x2F;usr&#x2F;share&#x2F;man&#x2F;man8&#x2F;nginx.8.gz #帮助和手册&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;50x.html&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;index.html&#x2F;var&#x2F;cache&#x2F;nginx #nginx缓存目录&#x2F;var&#x2F;log&#x2F;nginx #nginx日志 nginx -V 查看nginx详细的编译参数 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152*#安装目录或路径*--prefix&#x3D;&#x2F;etc&#x2F;nginx --sbin-path&#x3D;&#x2F;usr&#x2F;sbin&#x2F;nginx --modules-path&#x3D;&#x2F;usr&#x2F;lib64&#x2F;nginx&#x2F;modules --conf-path&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf --error-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log --http-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log --pid-path&#x3D;&#x2F;var&#x2F;run&#x2F;nginx.pid --lock-path&#x3D;&#x2F;var&#x2F;run&#x2F;nginx.lock *#执行对应模块时，nginx所保留的临时文件*--http-client-body-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;client_temp --http-proxy-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;proxy_temp --http-fastcgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;fastcgi_temp --http-uwsgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;uwsgi_temp --http-scgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;scgi_temp *#nginx启动的用户和用户组*--user&#x3D;nginx --group&#x3D;nginx *#nginx模块*--with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module *#设置额外的参数将被添加到CFLAGS变量*--with-cc-opt&#x3D;&#39;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE&#x3D;2 -fexceptions -fstack-protector-strong --param&#x3D;ssp-buffer-size&#x3D;4 -grecord-gcc-switches -m64 -mtune&#x3D;generic -fPIC&#39; *#设置附加的参数，链接系统库*--with-ld-opt&#x3D;&#39;-Wl,-z,relro -Wl,-z,now -pie&#39; nginx.conf/etc/nginx/nginx.conf log_format main &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39; &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39; &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;; access_log /var/log/nginx/access.log main;#日志路径和格式 nginx变量nginx请求变量arg_PARAMETER、http_HRADER、sent_http_HEADER比如$http_user_agent nginx内置变量http://nginx.org/en/docs/http/ngx_http_log_module.html#log_format 自定义变量待添加 nginx模块nginx官方模块和第三方模块 proxy_pass模块语法：proxy_pass http://xxxx/yyy 正向代理：代理client反向代理：代理server 负载均衡通过proxy_pass转发到upstream server组upstream模块必须配置在server层以外 123456789101112131415161718192021upstream name&#123; server 1.1.1.1:8881; server x.nbma.info; server 2.2.2.2 weight&#x3D;5; #权重,需要设置加权轮询 server 3.3.3.3 backup; #备份节点 server 4.4.4.4 down; #不提供服务 server 5.5.5.5 max_fails&#x3D;3; #允许请求失败的次数 server 6.6.6.6 fail_timeout&#x3D;30; #重试时间 server 7.7.7.7 max_conn&#x3D;500; #最大连接数&#125;server &#123; location &#x2F;&#123; proxy_pass http:&#x2F;&#x2F;name; &#125;&#125; 调度算法 1234567upstream name&#123; ip_hash; #基于源IP hash least_conn; #最小连接 hash $request_uri; #基于变量uri进行hash server 1.1.1.1:8881; server x.nbma.info;&#125; rewrite规则语法： rewrite regex replacement [flag];位置：只能在server,location或者if内例如 1rewrite ^(.*)$ &#x2F;pages&#x2F;maintain.html break; flag类型： last: 停止rewrite检测，继续匹配rewrite之后的其他规则，服务器只收到一次请求break: 停止rewrite检测，不在匹配rewrite之后的其他规则，直接去root目录redirect: 返回302临时重定向，地址栏会显示跳转后的地址，服务器收到两次请求permanent: 返回301永久重定向，地址栏会显示跳转后的地址，服务器收到两次请求，客户端会缓存这次跳转结果，之后跳转将由浏览器完成，无需经过服务器处理 常见的rewrite规则：SEO优化 1234rewrite ^&#x2F;course-(\\d+)-(\\d+)-(\\d+)-\\.html$ &#x2F;course&#x2F;$1&#x2F;$2&#x2F;$3.html break;http:&#x2F;&#x2F;example.com&#x2F;course-11-22-33.htmlhttp:&#x2F;&#x2F;example.com&#x2F;course&#x2F;11&#x2F;22&#x2F;3.html 基于agent判断 123if ($http_user_agent ~* Chrome) &#123; rewrite ^&#x2F;nginx http:&#x2F;&#x2F;example.com&#x2F;xxx break;&#125; 文件路径不存在，类似404 123if (!-f $request_filename) &#123; rewrite ^(.*)$ http:&#x2F;&#x2F;example.com&#x2F;xxx redirect;&#125;","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"centos","slug":"centos","permalink":"http://nbma.info/tags/centos/"},{"name":"nginx","slug":"nginx","permalink":"http://nbma.info/tags/nginx/"}]},{"title":"关于动态路由的一些常见问题","slug":"ospf-question","date":"un22fin22","updated":"un66fin66","comments":true,"path":"ospf-question/","link":"","permalink":"http://nbma.info/ospf-question/","excerpt":"1：在一台路由器上，可以同时配置多个OSPF进程吗？可以，同一台设备上不用进程号的ospf lsdb是独立的。且进程号只具有本地意义，用于区分多个ospf进程。在同一链路接口两端设备的ospf进程号可以不一样。","text":"1：在一台路由器上，可以同时配置多个OSPF进程吗？可以，同一台设备上不用进程号的ospf lsdb是独立的。且进程号只具有本地意义，用于区分多个ospf进程。在同一链路接口两端设备的ospf进程号可以不一样。 2：OSPF中stub与NSSA有什么区别？主要区别是是否可以接受外部路由。其中stub区域内只有本地的1，2，3类LSA，通过ABR与area0相连,ABR会自动产生一条O IA（3类）的默认路由通告进该区域；NSSA区域除了具备stub特性外，还可以接收来自外部其他路由协议的路由，通过ASBR进入ospf，在NSSA内为7类LSA，再通过ABR转换为5类LSA进入其他OSPF区域。 3：OSPF建立虚链路只能用virtual-link命令吗？virtual-link：其他区域和area0的区域间虚链路sham-link: 在MPLS VPN环境下的后门链路，属于区域内虚链路gre：非ospf技术 4：为什么在OSPF中不能重分发静态默认路由？引入默认只能在进程下default-information originate (always)为什么这个，前面大神说如果重分布可以的话，某些情况下可能会导致环路，还没想到案例。 5：为什么OSPF在使用协议内过滤时，使用OUT和接口组合会报错？ospf邻居间传递的是lsdb。进程下in方向是从LSDB读取之后，本地生成的路由条目加入路由表之前生效的。而out通告出去的也是LSDB，不是像bgp那样的路由条目，所以无法通过out+接口过滤。 6：OSPF是否可以实现非等价的负载均衡？由于cost机制，只能实现等价负载均衡。 7：OSPF是否支持区域内汇总？为什么？同一区域的LSDB是一致的，要修改只能在ABR和ASBR，也就是不同区域间。 8.OSPF 的三张表、5个包分别是什么？三张表：show ip ospf neighbor #邻居表show ip ospf database #链路状态数据库（拓扑表）show ip route ospf #路由表 五个包：Hello包: 用于路由器之间发现和维护邻居关系/协商邻接关系等;DBD包: Database Description,有的教材也叫DD包,用于向邻居表述自己已经知道的LSA即LSDB;LSR包: Link State Request,链路状态请求包,用于请求邻接的路由器发送链路状态更新包(LSU);LSU包: Link State Update,链路状态更新包,用于回应链路状态请求包LSR,而发送的更新包;LSAck包: Link State Acknowlegement,链路状态确认包,用于对邻接的路由器发送过来的LSU包的确认回复包. 9.OSPF的网络类型、区域类型和LSA类型分别有哪些？网络类型： broadcast non-broadcast point-to-multipoint point-to-point 区域类型： 骨干区域：area0,连接其他区域 Stub区域：禁用外部AS的路由信息 过滤了LSA-4/5，允许LSA-1/2/3，ABR会产生缺省的3类lsa，没有4，5类所以区域内不没有外部路由 配置：区域内所有路由器进程下 area x stub Totally Stub区域：禁用外部AS和区域间的路由信息 过滤了LSA-3/4/5,允许LSA-1/2，ABR会产生缺省的3类lsa，没有4，5类所以区域内不没有外部路由 配置：区域内ABR进程下 area x stub no-summary，其他路由器 area x stub NSSA区域：在stub的基础上允许外部AS的路由以7类lsa存在 过滤了LSA-4/5，允许LSA-1/2/3/7，ASBR会产生缺省的7类lsa，该区域能引入外部路由 配置：区域内所有路由器进程下 area x nssa 另外，NSSA区域如果要下发默认路由的话，在abr上配置nssa default-information origin会生成7类默认路由。（直接在进程下default-information origin生成的是5类，不接受） totally NSSA区域：在NSSA基础上，过滤了区域间路由 过滤了LSA-3/4/5，允许LSA-1/2/7，ABR会产生默认路由（3类lsa），该区域能引入外部路由 配置：区域内ABR进程下 area x nssa no-summary，其他路由器 area x nssa LSA类型：1类LSA：Router LSA：描述路由器本身的网络信息 包含路由器的RID，直连链路，cost，和邻居路由器的信息 特点：区域内所有router都会产生，到ABR终止 2类LSA：Network LSA：描述MA网络的掩码 包含MA网络的网络号，掩码，以及连接到该网络的路由器列表 特点：DR产生，区域内传播，到ABR终止 3类LSA：network summary LSA：描述区域间的路由信息 包含所在区域的网络号和子网掩码 特点：由ABR产生，在整个AS内传播，经过下一个ABR时会重新生成（修改adv通告路由器）。 4类LSA：ASBR summary LSA：描述本区域外的ASBR的位置 包含ASBR的router ID 特点：由ABR产生，在整个AS内传播，经过下一个ABR时会重新生成（修改adv通告路由器）。 5类LSA：AS external summary LSA：描述AS外部的路由信息。 包含外部路由的网络号和掩码 特点：ASBR产生，AS内传播，经过ABR时不变，默认cost 20类型O E2 7类LSA：NSSA external LSA：由ASBR产生，几乎和LSA5通告是相同的 特点：由于 totally NSSA不允许5类，所以ASBR得到的外部路由以7类方式存在，仅在本区域内传递，经过ABR变回5类。 10.OSPF邻居建立的7个过程是什么？ Down: 在失效时间间隔内未收到邻居路由器发送过来的Hello包时的状态;Initiat: 初始化状态,已收到邻居的Hello包,但在该Hello包中未发现自己的状态,或Hello参数不匹配时的状态;Two-Way: 双向状态,在邻居发送过来的Hello包中发现自己的RID,Hello参数匹配且通过验证时的状态;ExStart: 预启动状态,向224.0.0.5发送了第一条DBD包后的状态,直到RID较高的路由器成为主路由器;Exchange: 交换状态,选举主路由器完成后进入的状态,两路由器继续交换DBD包直到双方获悉的LSID相同;Loading: 加载状态,所有DBD包交换完成后切换成加载状态,此时发送LSR/LSU/LSA以开始详细的LSA交换;Full: 全邻接状态,发送收到并且确认所有的LSA之后,双方路由器LSA完全相同,进入最终的全邻接状态. 11.路由协议的管理距离都是多少？这个题，开放的看，还是得跟其qi他pa友商对比一下，毕竟实际场景复杂…… 协议 思科 华为 static 1 60 rip 120 100 ospf 110 内10/外150 ebgp 20 255 ibgp 200 255 is-is 115 15 eigrp 内90/外170 - 切记，莫踩坑，友商的ospf内部路由优于静态，ospf和其他路由双点双向重分布可能会像eigrp一样有路由回流问题 12.RIP的防环机制有哪些？最大跳数，水平分割，路由中毒，毒性逆转，触发更新，抑制计时器 13.有类和无类路由协议分别是什么？有类，更新的时候只发送网络地址，不含掩码ripv1无类，发送网络和掩码，支持VLSMripv2,eigrp,ospf,is-is,bgp 14.EIGRP关闭水平分割的命令是什么？接口下no ip split-horizon eigrp &lt;as号&gt; 15.EIGRP邻居建立的4个过程？ 12345 RouterA RouterB [hello] ---1---&gt; &lt;--2---- [hello] + [null update(init位置1)][null update(init位置1) + ACK] ---3---&gt; &lt;--4---- [ACK] 之后邻居up，开始正常update 16.EIGRP的stub区域的作用？ 将某台路由器配置成eigrp的stub区域后,该路由器的邻居不会向该该路由器发送查询报文，以此来减少扩散更新算法的扩散范围。eigrp stub后面加上各种参数，以实现该路由器只发送直连路由，汇总路由或者重分布路由给邻居。（默认只发直连和汇总）,再或者只接受不发送路由。 17. BGP的13条选路原则是什么？(1). weightcisco私有 设置weight只在本地生效(2). 本地优先级 local-preference 越高越优先通常用于离开本AS的选路 默认为100，(3).本地起源本地注入路由(4).as-path 越短越优先(5).起源代码i代表的是network、aggregate引入？代表是重分布引入的路由e代表ebgp引入I&gt;e&gt;?(6).MED 多出口分离器 MED 越小越优先被称为BGP的Metric，如果BGP通告的从IGP得到的路由，则MED值将继承自IGP的metric通常用于告知ebgp邻居如何进入到本AS(7).EBGP优于IBGP(8).到达bgp更新源的下一跳igp metric值小的(9).BGP等价负载(10).建立EBGP邻居关系更新的(11). 优选最小的BGP邻居的router-id如果是从RR得到的路由，那么这条路由的router-id会被Originator-id替换(12).优选拥有最短的cluster-list长度的路由(13).优选来自用最低地址建立BGP连接的邻居的路由条目关于选路原则就简单写一下。详细的可以看我之前参考官方文档整理的笔记：https://nbma.info/bgp-best-path-selection-algorithm/ 实际工作而言，要注意哪些属性是可传递的，以及对端设备的厂商和本端是否一致。我遇到的常用的就是1，2，6，9这四个。 18. BGP的消息报文是哪些，状态机有哪些？ 5种报文：(1).open包含BGP 版本号 AS号 BGP标识 hold time 保持时间 可选参数 如果timer keepalive 时间不一致，取最小的时间(2).keepalive默认60s 维护TCP 邻居关系如果hold time 180s 如果在180s 时间内，没有收到keepalive消息，就中断TCP 会话连接(3).update 通告路由每个路由前缀一个update消息NLRI 网络层可达性消息 路由前缀 掩码路径属性withdrawn 路由撤销(4).notification当出现错误的时候 并且关闭BGP连接(5).refresh执行clear ip bgp * soft in(请求对方发更新，in方向) 6种状态机：(1).idle状态：初始状态，不接受任何BGP的连接。(2).connect状态：连接状态，系统等待TCP连接建立完成，如果建立成功后，系统发送open消息，此时进入open-sent状态。(3).Active状态：活跃状态，如果TCP连接没有建立成功，此时系统进入Active状态。(4).Open-sent：open消息发送状态，表示已经发送open消息，等待对等体的open消息。(5).Open-confirm：open消息确认状态。收到对等体的open消息已经发送确认消息，等待对等体对自己的open消息确认的keepalive消息。(6).Established：连接已建立，此时对等体可以发送update消息报文进行路由的更新了。 19.IGMPV1和IGMPv2的区别?v1: 所有成员依靠组播路由选举DR作为查询器 成员离组没有报告 不支持特定组查询 v2: 单次自行选举DR 成员主动发送离组报告 支持特性组查询 v3: 还支持过滤，指定源、组加入","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"},{"name":"bgp","slug":"bgp","permalink":"http://nbma.info/tags/bgp/"},{"name":"ospf","slug":"ospf","permalink":"http://nbma.info/tags/ospf/"},{"name":"eigrp","slug":"eigrp","permalink":"http://nbma.info/tags/eigrp/"}]},{"title":"无线基础","slug":"wireless-base","date":"un55fin55","updated":"un66fin66","comments":true,"path":"wireless-base/","link":"","permalink":"http://nbma.info/wireless-base/","excerpt":"最近梳理了一般无线CCNA的支持还有Aruba的无线基本配置","text":"最近梳理了一般无线CCNA的支持还有Aruba的无线基本配置 思科AireOSService-port interface :带外网管Manager Interface: PC https网管，WLC发起连接radius时使用AP Manager Interface: 用于AP寻找WLC ，与AP建立CAPWAP隧道；8.0以后版本默认和manager interface共用一个portVirtual Interface: 用于对无线用户隐藏真实的dhcp服务器地址（仅在中心转发时）Dynamic Interface: 关联有线网络的VLAN 创建WLAN的时候需要配置SSID，而且使用中心转发的时候需要关联对应的dynamic interface Option 43选项：在dhcp下配置option 43 hex f104.0a01.0164 f1固定，04表示一个控制器地址，08表示两个控制器地址0a010164即10.1.1.100 Aruba基本配置配置vlan, SVI配置上联trunk配置网关*配置环回口（默认使用VLan1作为控制器地址） 配置DHCP，指定AC地址 dns：解析Aruba-master到AC dhcp option 43： ADP：Aruba Discovry Protocol，二层广播或三层组播239.0.82.11 创建AP Group将AP加入group在group中创建virtual APvirtual AP关联vlan 创建SSID profile SSID名称和加密方式创建AAA profile 待续","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"}]},{"title":"tcp回流经过ASA防火墙问题","slug":"asa-tcp-traffic-back","date":"un44fin44","updated":"un55fin55","comments":true,"path":"asa-tcp-traffic-back/","link":"","permalink":"http://nbma.info/asa-tcp-traffic-back/","excerpt":"环境R2，R3网关在ASA，R3背后有10.0.0.0网络，ASA路由10.0.0.0/24下一跳是R3问题，R2访问10.0.0.0/24网段时，流量到达ASA，icmp和udp可以通过，tcp会被丢弃","text":"环境R2，R3网关在ASA，R3背后有10.0.0.0网络，ASA路由10.0.0.0/24下一跳是R3问题，R2访问10.0.0.0/24网段时，流量到达ASA，icmp和udp可以通过，tcp会被丢弃 1，R2的10.1.1.44发起TCP流量访问10.0.0.0网段web server2，ASA收到改流量，发现出站接口是相同的security-level，需要敲下这条命令： ASA(config)#same-security permit intra-interface3，然后这个SYN包会通过R3路由到达R4，4，Web server返回SYN-ACK，这个包在到达R3之后，将会被直接通过mac地址转发到R25，R2收到该数据包会直接丢弃，这是因为ASA的“tcp序列号随机化”的默认特性， 当ASA从任意接口收到一个的SYN包时，会将seq随机成另一个数字，记录在状态表中，然后再发出，这是他的一个安全策略。 而在上例中，假定R2初始的SYN包的seq是12345，经过ASA被随机成为56789，R4回报只会确认收到56789，这个包在到达R2之后会被丢弃，因为R2希望确认123456，为了避免这种内部的异步路由导致的丢包，需要在ASA赦免特定tcp流量的状态化检测，配置如下： 12345678910111213141516object-group network LOCAL network-object 10.1.1.0 255.255.255.0object-group network VPN network-object 10.0.0.0 255.255.255.0access-list TCP-BYPASS extended permit ip object-group LOCAL object-group VPN//抓取需要bypass的明细流量ASA(config)#class-map TCP-BYPASSASA(config-cmap)#match access-list TCP-BYPASS//创建class-map匹配感兴趣流量ASA(config-cmap)#policy-map TCP-BYPASS-POLICYASA(config-pmap)#class TCP-BYPASS//创建policy-map,指定class-mapASA(config-pmap-c)#set connection advanced-options tcp-state-bypass//开启tcp bypass特性ASA(config-pmap-c)#service-policy TCP-BYPASS-POLICY interface inside//针对inside调用 其他： 如果ping也被ASA检测，那么也需要禁用，否则从10.0.0.0发起的ping是不通的， 其他被ASA检测的协议也是类似","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"},{"name":"asa","slug":"asa","permalink":"http://nbma.info/tags/asa/"}]},{"title":"CentOS7部署zabbix3.4","slug":"Centos7-deploy-zabbix3","date":"un11fin11","updated":"un66fin66","comments":true,"path":"Centos7-deploy-zabbix3/","link":"","permalink":"http://nbma.info/Centos7-deploy-zabbix3/","excerpt":"早该总结一次了，之前都是自己编译，现在用yum直接装，还快。","text":"早该总结一次了，之前都是自己编译，现在用yum直接装，还快。 // 2018.12可以先用官网的docker镜像预览下功能安装好docker后，直接从docker hub的镜像启动一个容器 1234docker run --name zabbix-appliance -t \\ -p 10051:10051 \\ -p 80:80 \\ -d zabbix&#x2F;zabbix-appliance:latest 使用docker ps查看正在运行的容器 123[root@CentOS7 ~]# docker psCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMESa024336b08db zabbix/zabbix-appliance:latest &quot;docker-entrypoint.sh&quot; 7 days ago Up 3 seconds 0.0.0.0:80-&gt;80/tcp, 0.0.0.0:10051-&gt;10051/tcp, 443/tcp zabbix-appliance 下次启动的话，确保docker services是运行的，通过docker ps -a查看stop的容器。然后docker start hash/name启动原来容器。 下面是原文： Zabbix 3.4 支持Centos 7。貌似不支持6.9. 更多详细内容请参考官方说明文档，详细的安装要求不贴出来了。 https://www.zabbix.com/documentation/3.4/zh/manual/installation/requirements 虚拟机配置 双核 8G内存 01、最小化安装操作系统02、升级系统组件到最新版本sudo yum -y update 03、关闭 SELinuxsudo sed -i &quot;s/SELINUX=enforcing/SELINUX=disabled/g&quot; /etc/selinux/config 04、关闭防火墙sudo systemctl stop firewalld.service &amp;&amp; systemctl disable firewalld.service完成3、4两步，重启一下。 05、获取SQL源sudo rpm -Uvh https://dev.mysql.com/get/mysql57-community-release-el7-11.noarch.rpm 可以从https://dev.mysql.com/downloads/file/?id=470281 下载 06、安装 Zabbix 所需软件支持包先装mysqlsudo yum install mysql-* --skip-broken 有冲突的软件跳过 安装Apachesudo yum -y install httpd 123456789101112#安装sudo yum -y install httpd#启动systemctl start httpd.service #停止systemctl stop httpd.service #重启systemctl restart httpd.service #开机启动systemctl enable httpd.service #开机不启动systemctl disable httpd.service 安装phpsudo yum install php 安装php扩展123sudo yum install php-mysqlnd php-gd libjpeg* php-snmp php-ldap php-odbc php-pear php-xml php-xmlrpc php-mbstring php-bcmath php-mhash php-common php-ctype php-xml php-xmlreader php-xmlwriter php-session php-mbstring php-gettext php-ldap php-mysqli --skip-brokensudo yum install wget telnet net-tools python-paramiko gcc gcc-c++ dejavu-sans-fonts python-setuptools python-devel sendmail mailx net-snmp net-snmp-devel net-snmp-utils freetype-devel libpng-devel perl unbound libtasn1-devel p11-kit-devel OpenIPMI unixODBC 07、设置 MySQL 参数（8GB 内存为例）如果你不清楚这些参数的含义，请不要修改，保持默认即可。直接跳过这一节sudo vim /etc/my.cnf 不然没权限保存在文件最后添加以下内容： 123456789101112131415161718192021222324innodb_file_per_table = 1innodb_status_file = 1innodb_buffer_pool_size = 6Ginnodb_flush_log_at_trx_commit = 2innodb_log_buffer_size = 16Minnodb_log_file_size = 64Minnodb_support_xa = 0default-storage-engine = innodbbulk_insert_buffer_size = 8Mjoin_buffer_size = 16Mmax_heap_table_size = 32Mtmp_table_size = 32Mmax_tmp_tables = 48read_buffer_size = 32Mread_rnd_buffer_size = 16Mkey_buffer_size = 32Mthread_cache_size = 32innodb_thread_concurrency = 8innodb_flush_method = O_DIRECTinnodb_rollback_on_timeout = 1query_cache_size = 16Mquery_cache_limit = 16Mcollation_server = utf8_bincharacter_set_server = utf8 注：原则上 innodb_buffer_pool_size 需要设置为主机内存的 80%，如果主机内存不是 8GB，以上参数可依据相应比例进行调整，例如主机内存为 16GB，则 innodb_buffer_pool_size 建议设置为 12GB，innodb_log_buffer_size 建议设置为 32M，innodb_log_file_size 建议设置为 128M，以此类推。请注意innodb_buffer_pool_size的值必须是整数，例如主机内存是4G，那么innodb_buffer_pool_size可以设置为3G，而不能设置为3.2G 08、启动 MySQLsudo systemctl enable mysqld &amp;&amp; systemctl start mysqld 09、获取 MySQL 的 root 初始密码grep &#39;temporary password&#39; /var/log/mysqld.log JtZizq!Rl6E+ 10、进行 MySQL 安全配置配置开始时会用到第 09获取的初始密码，建议修改为自定义密码，其它选项选择 y 即可 mysql_secure_installation 密码改为：Aa123456,. 11、重启 MySQLsudo systemctl restart mysqld 12、配置 MySQL 中 zabbix要的库和账号权限12345678910111213mysql -u root -p#需要输入第 10步中设置的自定义密码#创建数据库mysql&gt;create database zabbix character set utf8; #创建用户和密码mysql&gt;create user zabbix@&#x27;%&#x27; identified by &#x27;Qingdao@2017&#x27;; #赋权mysql&gt;grant all privileges on zabbix.* to zabbix@&#x27;%&#x27;;#刷新权限mysql&gt;flush privileges;mysql&gt;exit; 13、安装 Zabbix源sudo rpm -ivh http://repo.zabbix.com/zabbix/3.4/rhel/7/x86_64/zabbix-release-3.4-2.el7.noarch.rpm3.4最新版看这里：http://repo.zabbix.com/zabbix/3.4/rhel/7/x86_64/ 14、安装zabbixsudo yum -y install zabbix-server-mysql zabbix-web-mysql zabbix-java-gateway zabbix-web 15、导入 zabbix 所需信息cd /usr/share/doc/zabbix-server-mysql-3.4.7(注意版本号)zcat create.sql.gz | mysql -uroot zabbix -p（需要输入第 10 步中设置的自定义密码） 16、配置 zabbix 参数sudo vim /etc/zabbix/zabbix_server.conf 这个配置要一遍过主要是以下几个选项参数需要设置（8GB 内存为例）： 123456789101112131415161718192021DBPassword=xxxxx#配置为第 12 步第 3 行中设置的自定义密码CacheSize=512M#（CacheSize在371行）HistoryCacheSize=128M#（HistoryCacheSize在397行）HistoryIndexCacheSize=128M#（HistoryIndexCacheSize在405行）TrendCacheSize=128M#（TrendCacheSize在414行）ValueCacheSize=256M#（ValueCacheSize在425行）Timeout=30#（Timeout在432)其它参数保持默认值即可 17、配置 Apache 中的 PHP 参数（8GB 内存为例）sudo vim /etc/httpd/conf.d/zabbix.conf 1234567php_value max_execution_time 600php_value memory_limit 256Mphp_value post_max_size 32Mphp_value upload_max_filesize 32Mphp_value max_input_time 600php_value always_populate_raw_post_data -1date.timezone 去掉注释符号#，并将值修改为 &#96;Asia&#x2F;Shanghai&#96; 18、重启系统systemctl stop mysqld &amp;&amp; reboot 19、启动zabbixsudo systemctl start httpd &amp;&amp; systemctl start zabbix-server 20、初始化在浏览器中输入 http://zbx监控服务器的IP地址/zabbix，进行 zabbix 的页面初始化配置 这里如果密码输错，是跳转不到下一步的。密码是前面设置的 Qingdao@2017 默认用户名 admin，默认密码 zabbix，确认可正常登录系统。 21、设置中文界面登录进入系统后，确认 Zabbix server is running 的值是 Yes。然后选择 Administrator –&gt; Users –&gt; Admin 回到”监测中” –&gt; “仪表板”，就可以看到监控系统已设置为中文界面了。 22、修复图片中文乱码 首先copy本机的中文字体，仿宋、楷体、雅黑均可 将字体名称修改为graphfont.ttf备份zabbix原字体，在*/usr/share/zabbix/fonts/*目录 并将自己修改好的字体上传到该目录，修复权限chmod 777 graphfont.ttf 23、zabbix-agent安装及配置1、安装zabbix-agentyum install zabbix-agent -y 2、配置zabbix-agent12345678#grep -n &#x27;^&#x27;[a-Z] /etc/zabbix/zabbix_agentd.conf13:PidFile=/var/run/zabbix/zabbix_agentd.pid32:LogFile=/var/log/zabbix/zabbix_agentd.log43:LogFileSize=097:Server=172.16.8.254138:ServerActive=172.16.8.254149:Hostname=Zabbix server267:Include=/etc/zabbix/zabbix_agentd.d/\\*.conf 3、启动zabbix-agent并设置开机启动systemctl enable zabbix-agent.servicesystemctl restart zabbix-agent.service","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"centos","slug":"centos","permalink":"http://nbma.info/tags/centos/"},{"name":"monitor","slug":"monitor","permalink":"http://nbma.info/tags/monitor/"},{"name":"zabbix","slug":"zabbix","permalink":"http://nbma.info/tags/zabbix/"}]},{"title":"vim中文入门指南","slug":"vim-tutor","date":"un11fin11","updated":"un66fin66","comments":true,"path":"vim-tutor/","link":"","permalink":"http://nbma.info/vim-tutor/","excerpt":"vimtutor这个很6 啊，mac下还是中文","text":"vimtutor这个很6 啊，mac下还是中文 第一讲：基础 光标在屏幕文本中的移动既可以用箭头键，也可以使用 hjkl 字母键。 h (左移) j (下行) k (上行) l (右移) 欲进入 Vim 编辑器(从命令行提示符)，请输入：vim 文件名 &lt;回车&gt; 欲退出 Vim 编辑器，请输入 :q! &lt;回车&gt; 放弃所有改动。或者输入 :wq &lt;回车&gt; 保存改动。 在正常模式下删除光标所在位置的字符，请按： x 欲插入或添加文本，请输入： i 输入欲插入文本 &lt;ESC&gt; 在光标前插入文本 A 输入欲添加文本 &lt;ESC&gt; 在一行后添加文本 特别提示：按下 键会带您回到正常模式或者撤消一个不想输入或部分完整的命令。 第二讲：删除 欲从当前光标删除至下一个单词，请输入：dw 欲从当前光标删除至当前行末尾，请输入：d$ 欲删除整行，请输入：dd 欲重复一个动作，请在它前面加上一个数字：2w 在正常模式下修改命令的格式是：operator [number] motion其中： operator - 操作符，代表要做的事情，比如 d 代表删除 [number] - 可以附加的数字，代表动作重复的次数 motion - 动作，代表在所操作的文本上的移动，例如 w 代表单词(word)，$ 代表行末等等。 欲移动光标到行首，请按数字0键：0 欲撤消以前的操作，请输入：u (小写的u)欲撤消在一行中所做的改动，请输入：U (大写的U)欲撤消以前的撤消命令，恢复以前的操作结果，请输入：CTRL-R 第三讲：置入 要重新置入已经删除的文本内容，请按小写字母 p 键。该操作可以将已删除的文本内容置于光标之后。如果最后一次删除的是一个整行，那么该行将置于当前光标所在行的下一行。 要替换光标所在位置的字符，请输入小写的 r 和要替换掉原位置字符的新字符即可。 更改类命令允许您改变从当前光标所在位置直到动作指示的位置中间的文本。比如输入 ce 可以替换当前光标到单词的末尾的内容；输入 c$ 可以替换当前光标到行末的内容。 更改类命令的格式是： c [number] motion 第四讲：查找替换 CTRL-G 用于显示当前光标所在位置和文件状态信息。G 用于将光标跳转至文件最后一行。先敲入一个行号然后输入大写 G 则是将光标移动至该行号代表的行。gg 用于将光标跳转至文件第一行。 输入 / 然后紧随一个字符串是在当前所编辑的文档中正向查找该字符串。输入 ? 然后紧随一个字符串则是在当前所编辑的文档中反向查找该字符串。完成一次查找之后按 n 键是重复上一次的命令，可在同一方向上查找下一个匹配字符串所在；或者按大写 N 向相反方向查找下一匹配字符串所在。CTRL-O 带您跳转回较旧的位置，CTRL-I 则带您到较新的位置。 如果光标当前位置是括号(、)、[、]、{、}，按 % 会将光标移动到配对的括号上。 在一行内替换头一个字符串 old 为新的字符串 new，请输入 :s/old/new在一行内替换所有的字符串 old 为新的字符串 new，请输入 :s/old/new/g在两行内替换所有的字符串 old 为新的字符串 new，请输入 :#,#s/old/new/g在文件内替换所有的字符串 old 为新的字符串 new，请输入 :%s/old/new/g进行全文替换时询问用户确认每个替换需添加 c 标志 :%s/old/new/gc 第五讲小结 :!command 用于执行一个外部命令 command。 请看一些实际例子： (MS-DOS) (Unix) :!dir :!ls - 用于显示当前目录的内容。 :!del FILENAME :!rm FILENAME - 用于删除名为 FILENAME 的文件。 :w FILENAME 可将当前 VIM 中正在编辑的文件保存到名为 FILENAME 的文件中。 v motion :w FILENAME 可将当前编辑文件中可视模式下选中的内容保存到文件FILENAME 中。 :r FILENAME 可提取磁盘文件 FILENAME 并将其插入到当前文件的光标位置后面。 :r !dir 可以读取 dir 命令的输出并将其放置到当前文件的光标位置后面。 第六讲小结 输入小写的 o 可以在光标下方打开新的一行并进入插入模式。输入大写的 O 可以在光标上方打开新的一行。 输入小写的 a 可以在光标所在位置之后插入文本。输入大写的 A 可以在光标所在行的行末之后插入文本。 e 命令可以使光标移动到单词末尾。 操作符 y 复制文本，p 粘贴先前复制的文本。 输入大写的 R 将进入替换模式，直至按 键回到正常模式。 输入 :set xxx 可以设置 xxx 选项。一些有用的选项如下： ‘ic’ ‘ignorecase’ 查找时忽略字母大小写 ‘is’ ‘incsearch’ 查找短语时显示部分匹配 ‘hls’ ‘hlsearch’ 高亮显示所有的匹配短语 选项名可以用完整版本，也可以用缩略版本。 在选项前加上 no 可以关闭选项： :set noic 第七讲小结 输入 :help 或者按 键或 键可以打开帮助窗口。 输入 :help cmd 可以找到关于 cmd 命令的帮助。 输入 CTRL-W CTRL-W 可以使您在窗口之间跳转。 输入 :q 以关闭帮助窗口 您可以创建一个 vimrc 启动脚本文件用来保存您偏好的设置。 当输入 : 命令时，按 CTRL-D 可以查看可能的补全结果。按 可以使用一个补全。 from V2ex设置显示行号(为了要了方便到某一行) :set number移动到行首(第0列) 数字键 0移动到行首(第一个非空字符)Shift+6移动到行位 $ or Shift+4向上\\下滚动半屏 ctrl+u\\d向上\\下滚动一屏(这个比较实用，记住) ctrl+b\\f移动到第 x 行 xG or :x移动到当前行字符 x 上(向后搜索，继续移动到下一个 x 的命令按,键，上一个 x 的命令是按;键) fx移动到当前行字符 x 上(向前搜索，继续移动到下一个 x 的命令按,键，上一个 x 的命令是按;键) Fx","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"centos","slug":"centos","permalink":"http://nbma.info/tags/centos/"}]},{"title":"HTTPS的工作原理","slug":"https-theory","date":"un00fin00","updated":"un55fin55","comments":true,"path":"https-theory/","link":"","permalink":"http://nbma.info/https-theory/","excerpt":"HTTPS在传输数据之前需要客户端（浏览器）与服务端（网站）之间进行一次握手，在握手过程中将确立双方加密传输数据的密码信息。","text":"HTTPS在传输数据之前需要客户端（浏览器）与服务端（网站）之间进行一次握手，在握手过程中将确立双方加密传输数据的密码信息。 TLS/SSL协议不仅仅是一套加密传输的协议，更是一件经过艺术家精心设计的艺术品，TLS/SSL中使用了非对称加密，对称加密以及HASH算法。握手过程的具体描述如下： 下面对这个4个阶段11个包进行详细分析 1.Client Hello报文客户端将产个一个随机数A、并和浏览器能支持的TLS版本号（Extension字段）、以及浏览器能支持的加密方法发送给服务器。 2.Server Hello, Certificate, Server Key Exchange, Server Hello Done 我这边抓包是在服务器上使用tcpdump进行的，server hello的整个过程都在一个数据包中体现。我在查找https相关信息的时候，看到其他网站抓包显示sever hello的四个阶段分对应时四个独立的数据包，原因怀疑是nginx或者apache的特性，有待确认 2.1 Server Hello报文Server Hello中包含了服务器从client hello中选出一组加密算法与HASH算法，TLS版本，一个服务器新生成的随机数B这里可以看到server hello使用和选定的版本都是TLS1.2，选定的算法是TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 2.2 Certificate报文Certificate部分含有两个数字证书，分别是网站的证书和一个中间证书（又称链证书） 中间证书主要解决安卓在某种情况下无法验证网站证书问题，详情查看文末参考文档网站的数字证书中包含服务器的公钥（公钥的指纹在serialNumber字段）和证书的颁发机构的数字签名 1234&#x2F;&#x2F;网站证书：Certificate: 308204f9308203e1a003020102021203ca27d7faa2474679... (id-at-commonName&#x3D;nbma.info)&#x2F;&#x2F;中间证书：Certificate: 308204923082037aa00302010202100a0141420000015385... (id-at-commonName&#x3D;Let&#39;s Encrypt Authority X3,id-at-organizationName&#x3D;Let&#39;s Encrypt,id-at-countryName&#x3D;US) 2.3 Server Key Exchange报文这部分还没弄明白作用，前面client hello的Extension字段中也有ECDH的参数 2.4 Server Hello Done报文3.Client Key Exchange, Change Cipher Spec, Encrypted Handshake Message 浏览器获得网站证书之后浏览器要做以下工作： 验证证书的合法性（颁发证书的机构是否合法，证书中包含的网站地址是否与正在访问的地址一致等），如果证书受信任，则浏览器栏里面会显示绿色的锁，否则会给出证书不受信的提示。 3.1 Client Key Exchange报文如果证书受信任，或者是用户接受了不受信的证书，浏览器会发送一个Client Key Exchange的报文。该报文中包含一个客户端生成的新的随机数C，这个随机数被称为Pre-master key，并用网站证书中提供的公钥对该报文进行加密。 3.2 Change Cipher Spec该报文提示服务器此后的报文将使用Pre-master key进行加密 3.3 Encrypted Handshake Message该报文包含连接至今所有报文的校验值，并使用Pre-master key对消息进行加密。 4.New Seesion Ticket, Change Cipher Spec, Encrypted Handshake Message网站接收浏览器发来的数据之后要做以下的操作： a) 使用自己的私钥将信息解密取出Pre-master key，使用Pre-master key解密浏览器发来的握手消息，并验证HASH是否与浏览器发来的一致。 b) 使用密码加密一段消息，发送给浏览器。 4.1 New Seesion Ticket服务器跟据客户端发送的信息，生成一个seesion ticket。如果对话中断，下次重连的时候，只要客户端给出这个编号，且服务器有这个编号的记录，双方就可以重新使用已有的”对话密钥”，而不必重新生成一把。同事也能看到，此ticket有效期为600s 这个session ticket是加密的，只有服务器才能解密，其中包括本次对话的主要信息，比如对话密钥和加密方法。当服务器收到session ticket以后，解密后就不必重新生成对话密钥了。 4.2 Change Cipher Spec同样，提示客户端此后的报文将使用Pre-master key进行加密 4.3 Encrypted Handshake Message被加密的finish信息 5.Encrypted Application Data客户端解密并计算握手消息的HASH，如果与服务端发来的HASH一致，此时握手过程结束。 这里浏览器与网站互相发送加密的握手消息并验证，目的是为了保证双方都获得了一致的随机数C。然后双方使用前面的三个随机数A/B/C，生成”对话密钥”（session key又称master key），之后对信息的加密使用master key进行对称加密。 另外，HTTPS一般使用的加密与HASH算法如下： 非对称加密算法：RSA，DSA/DSS 对称加密算法：AES，RC4，3DES HASH算法：MD5，SHA1，SHA256 参考文档：HTTPs握手流程抓包解析图解SSL/TLS协议中间证书的使用","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"},{"name":"https","slug":"https","permalink":"http://nbma.info/tags/https/"}]},{"title":"交换机的堆叠、VSS、IRF、VPC区别","slug":"switch-redundancy","date":"un44fin44","updated":"un66fin66","comments":true,"path":"switch-redundancy/","link":"","permalink":"http://nbma.info/switch-redundancy/","excerpt":"偶然想到这个问题，正好总结一下。","text":"偶然想到这个问题，正好总结一下。 思科的堆叠技术：常见于低端设备，提供简化的本地管理，将一组交换机作为一个对象来管理，堆叠组内设备各自独立。MAC地址表项、ARP表项等不相同。VSS虚拟交换系统：可以将多台交换机组合为单一虚拟交换机，交换组内设备表项相同，统一设备管理。最终简化网络拓扑 其实将这四种技术称为“二层”“冗余”技术并不准确，因为其使用场景和作用即不相同也不冲突，并且工作范围也不是全都局限于二层，直接分类或者横向对比不是十分准确，这里只是将这几种容易混淆的概念列出，如果疏漏或错误，还请指正。 传统Port Channel 交换机端使用LACP或者PAgP协议，服务器端使用NIC teaming技术讲多条链路绑定在一起，STP运行在所有物理链路组成的逻辑链路上。优点是绝大部分交换机都支持这种技术，缺点是所有port channel的组成端口都必须位于同一台交换机上，可能造成单点故障 StackWise Catalyst低端交换上使用的堆叠技术，可以将两台交换机“合并”为一台进行使用和管理，同一prot channel当中的端口可以位于不同物理交换机上。不需要特殊配置，只需要连线即可。只有一个控制层面(control plane)和管理层面（management plane），主要用于接入层端口扩充，同一逻辑单元最多能够接入9台物理交换机 VSS Catalyst 4500和6500上使用的技术，但是对于硬件型号和引擎要求较多，并且只能将两台设备“合并”在一起。此外，VSS不只是二层技术，而是将二层和三层全部“合并”。只有一个控制层面（control plane）和管理层面（management plane） vPC 适用于Nexus交换机，单纯的二层跨机箱冗余技术，不支持VPN或QoS等三层特性。和StackWise和VSS不同的是，配置了vPC的Nexus依然保持各自的控制层面(control plane)和管理层面（management palne），可以用于构建大二层网络。此外还有vitual Port Channel Plus和Enhanced virtual Port Channel，有兴趣可以进一步查阅文档 总结 这四种技术的使用场景和支持设备各不相同，应该根据具体需求进行选择","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"}]},{"title":"ping交换机的SVI地址出现延迟并且很不稳定","slug":"ping-switch-svi-delay","date":"un11fin11","updated":"un66fin66","comments":true,"path":"ping-switch-svi-delay/","link":"","permalink":"http://nbma.info/ping-switch-svi-delay/","excerpt":"在交换机的vlan 1起一个地址，PC接到交换机，给PC设置一个vlan 1段的地址，然后在PC上ping vlan 1的地址会出现延迟，原本没考虑过这个问题，一直觉得应该小于1ms，但是真机上就是会这样。","text":"在交换机的vlan 1起一个地址，PC接到交换机，给PC设置一个vlan 1段的地址，然后在PC上ping vlan 1的地址会出现延迟，原本没考虑过这个问题，一直觉得应该小于1ms，但是真机上就是会这样。 首先一个问题，我们为什么要“-t”的ping 3750？因为本质上来说：1、交换机是转发设备而不是终端设备，业务数据不会进到3750的CPU。2、ping 包（icmp）的destination如果是3750本地的话，icmp包需要进到3750的CPU处理并产生icmp reply以回应icmp source。 所以，如果没有特殊需求，可以忽略这种延时。因为，ping 3750无非只是连通性测试而非转发性能测试。（转发性能测试需要其他方式测试）而且，从结果来看，平均延时只有2ms，其实延时也不是很高。 总之，1、 icmp包的destination如果是交换机，那么一定会由CPU处理并相应，所以，延时一定和cpu利用率有关。如果是丢包的话，还会和CoPP相关。2、 这种测试本身没有任何实质意义。 &nbsp; icmp的echo是低优先级的数据包，系统需要在处理高优先级的进程和流量之后进行对ping的应答，另外正如楼上专家所说，穿越数据转发和ping 交换机本身是有区别的，结果没有意义。","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"}]},{"title":"BGP选路原则验证及分析","slug":"bgp-best-path-selection-algorithm","date":"un11fin11","updated":"un55fin55","comments":true,"path":"bgp-best-path-selection-algorithm/","link":"","permalink":"http://nbma.info/bgp-best-path-selection-algorithm/","excerpt":"最近重新验证一下bgp协议在思科设备上选路原则问题，并且分析了每一条的属性在配置过程中的注意事项，顺便整理一下文章：","text":"最近重新验证一下bgp协议在思科设备上选路原则问题，并且分析了每一条的属性在配置过程中的注意事项，顺便整理一下文章： 思科官方的定义： http://www.cisco.com/c/en/us/support/docs/ip/border-gateway-protocol-bgp/13753-25.html 使用的网络拓扑如下：基本配置：每个路由器上配置一个环回口loopback0:xx.1.1.1/32；R4是RR。1. weight 只在本地有效。 a针对邻居修改：原来的bgp路由情况 直接针对邻居修改权重：R3(config-router)#nei 23.1.1.2 weight 1从该邻居得到的条目权重被修改： b.针对特定路由条目通过route-map修改access-list 1 permit 5.5.5.5 //匹配需要修改的BGP路由route-map WE permit 10 //使用route-map修改权重值match ip address 1set weight 2route-map WE permit 20router bgp 200neighbor 13.1.1.1 route-map WE in //在bgp邻居下调用修改后的结果： 2. 本地优先级local preference 通常用于离开本AS的选路 默认为100，ibgp邻居之间会更新本地优先级属性，不会更新给real EBGP 邻居(联邦会更新本地优先级属性) 针对EBGP设置 in方向（常用，选择ASBR） IBGP 设置in 或者out都可以a.全局配置 —-把EBGP 邻居学习到的路由都修改bgp default local-preference 102b. 匹配某条路由，针对邻居设置本地优先级。 修改前： 使用route-map修改本地优先级来影响R1选路：R1(config)#access-list 1 permit 33.1.1.1 /32R1(config)#route-map LO permit 10R1(config-route-map)#match ip address 1R1(config-route-map)#set local-preference 200R1(config)#route-map LO permit 20R1(config)#router bgp 100R1(config-router)#nei 22.1.1.1 route-map LO in 3. origin 本地起源一般看到 next-hop 为0.0.0.0 都是本地注入的本地注入路由 三种方法： network 重分布 aggregate 在R2上新开启一个环回口122.1.1.1/32，宣告进BGP，设置weight为0；同时在R1上配置该环回口的静态路由，重分布进BGP。此时R2优选本地产生的路由。R2(config)#access-list 1 per 122.1.1.1 /32R2(config)#route-map OR permit 10R2(config-route-map)#match ip address 1R2(config-route-map)#set weight 0R2(config)#router bgp 100R2(config-router)#network 122.1.1.1 mask 255.255.255.255 route-map ORR1(config)#ip route 122.1.1.1 255.255.255.255 10.1.1.2R1(config)#router bgp 100R1(config-router)#redistribute static 4. as-path 越短越优先 bgp bestpath as-path ignore//隐含命令，忽略as-path作为选路原则 宣告R3的环回口，R1分别从R2R3学习到该路由，由于ebgp优于ibgp，R1会优选从EBGP（R3）学到的路由 在R1上通过route-map增加从R3得到的路由的as-path，使其优选R2：R1(config)#access-list 1 permit 33.1.1.1 /32R1(config)#route-map AS per 10R1(config-route-map)#matc ip add 1R1(config-route-map)#set as-path prepend 200 200 200 200R1(config)#router bgp 100R1(config-router)#neighbor 13.1.1.3 route-map AS inR1(config-router)#exit 5.起源代码origin codei代表的是network、aggregate引入？代表是重分布引入的路由e代表ebgp引入（已经不用了）IGP&gt;egp&gt;? 删掉上一个route-map，改回之前的状态 在R1通过route-map强制修改从R3得到的路由的起源代码R1(config)#access-list 1 permit 33.1.1.1 /32R1(config)#route-map OR permit 10R1(config-route-map)#match ip address 1R1(config-route-map)#set origin incompleteR1(config-route-map)#router bgp 100R1(config-router)#neighbor 13.1.1.3 route-map OR in 6. MED多出口分离器，越小越优先被称为BGP的Metric，如果BGP通告的从IGP得到的路由，则MED值将继承自IGP的metric通常用于告知ebgp邻居如何进入到本AS 在R3上分别针对R1R2设置一个metric值，当路由更新到R1时，通过前5条无法选出最优路由，此时R1会比较两条bgp路由的MED值，得到最优 R3(config)#route-map R1R3(config-route-map)#set metric 13R3(config-route-map)#exitR3(config)#route-map R2R3(config-route-map)#set metric 12R3(config)#router bgp 200R3(config-router)#neighbor 13.1.1.1 route-map R1 outR3(config-router)#neighbor 23.1.1.2 route-map R2 Out 7.EBGP优于ibgp与管理距离无关。 默认情况下R1和R2从R3和对方同时得到33.1.1.1/32的路由，但都是优选从R3的得到的 8. metric，到达bgp下一跳的IGP的metric默认情况，宣告R3环回口，在R4上看到，他应该是根据route-id选择R1作为最优吓一跳，因为此时在IGP路由表中，R4到达11.1.1.1和22.1.1.1的metric相同，通过前面的选路原则没有选出最优 此时，可以通过更改去往11.1.1.1的metric来干预选路，在R1的lo 0修改cost:R1(config-if)# int lo 0R1(config-if)#ip ospf cost 1000此时R4的igp路由表： R4的bgp选录已经被影响： 9. load balance负载均衡开启ibgp多路径maximum-paths ibgp 4对于ebgp，直接在bgp中开启maximum-paths 4或者maximun-paths eibgp 4对于ibgp负载均衡：还原上一步的操作，还是在r4上 ，bgp路由33.1.1.1下一跳11.1.1.1和22.1.1.1的metric相同，直接在bgp进程下开启：R4(config)#router bgp 100R4(config-router)#maximum-paths ibgp 2结果如下： 对于ebgp负载均衡默认情况下，R3上5.5.5.5的bgp路由优选ebgp邻居建立时间最久的下一跳， 在bgp开启负载均衡：R3(config)#router bgp 200R3(config-router)#maximum-paths 2 10.older 建立邻居更久的 使用bgp bestpath compare-routerid，可以跳过这条 对于R3,，分别与R1R2建立邻居关系：通过重新建立邻居来重置ebgp邻居R3(config)#router bgp 200R3(config-router)#nei 23.1.1.2 shutR3(config-router)#nei 23.1.1.2 shut*Oct 29 19:40:10.994: %BGP-5-NBR_RESET: Neighbor 23.1.1.2 reset (Admin. shutdown)*Oct 29 19:40:10.999: %BGP-5-ADJCHANGE: neighbor 23.1.1.2 Down Admin. shutdown*Oct 29 19:40:10.999: %BGP_SESSION-5-ADJCHANGE: neighbor 23.1.1.2 IPv4 Unicast topology base removed from session Admin. shutdownR3(config-router)#no nei 23.1.1.2 shut 11.route-id如果是从RR得到的路由，那么这条路由的router-id会被Originator-id替换，也就说会拿Originator-id和其他路由的router-id作比较。前面说过，在默认情况下， R4上33.1.1.1的最优根据R1，R2的之中较小的route-id选择了11.1.1.1。通过修改R1的bgp router-id来影响选路：修改前： 修改后： 12.cluster list 簇list长度将R4设置为RR，R1、R5、R6为客户端；R6设置为RR，R5为客户端。这样R5分别从R4和R6学习到33.1.1.1的路由，并且前十条选录原则无法选出最优路由，第十一条router-id由于RR原因被originator id覆盖。此时会根据cluster list长度进行选路： 可以看到，从44.1.1.1得到的路由cluster长度为1，从66.1.1.1得到的路由cluster长度为2，优选44.1.1.113.最小的neighbor 地址","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"},{"name":"bgp","slug":"bgp","permalink":"http://nbma.info/tags/bgp/"}]},{"title":"snmp的最大值导致报警问题","slug":"snmp-max-value-notify","date":"un00fin00","updated":"un55fin55","comments":true,"path":"snmp-max-value-notify/","link":"","permalink":"http://nbma.info/snmp-max-value-notify/","excerpt":"某天下午突然收到一条告警信息：ASA被重启！！","text":"某天下午突然收到一条告警信息：ASA被重启！！ 异常 - 10.1.1.1异常时间 2016.12.11 - 14:10:21 10.1.1.1 reloaded10.1.1.1(10.1.1.1) sysUpTime : 00:04:14 上面的报警信息来自内网的zabbix，调用脚本通过微信公众号推送报警信息；针对所有的网络设备都配置了snmp，来监控一些参数。 检查思路，作为出口设备，如果一旦真的重启，引发的报警信息就不只是一条了，初步判断是误报，登陆ASA也能看到，ASA up 1 year 132 days zabbix上设置的报警的triger是 {10.1.1.1:sysUpTime.last(0)}&lt;600 在思科提供的mib中检查，针对sysuptime的描述如下： the timetick value for system uptime (OID 1.3.6.1.2.1.1.3.0) is a 32-bit value so once the system has been up for 1 year, 132 days, 2 hours, 27 minutes and 52.96 seconds the value will roll to 0 again 也就是说这个值最多记497天，之后会清零重计。 解决方案就是同时监控这个值snmpenginetime (.1.3.6.1.6.3.10.2.1.3) ，进行综合判断。这个两个oid都是counter32类型，最大值都是2^32-1=4294967295，区别是sysuptime指设备的网络管理部分，每次系统重新启动时都会重新初始化，单位是百分之一秒，最多到42949672.95s；snmpenginetime是指设备SNMP模块的运行时间，单位是一秒，最大可以到4294967295s，也就是135年。另外，即使未重启设备，该模块也可能会独立重启。以下情况会导致SNMP模块重启，并将snmpenginetime清零： 配置SNMPv3（必须配置snmpEngineID） 更改snmpEngineID 设备重启 设备bug导致snmp服务重启 建议监控系统中结合两个oid一起使用。 关于接口流量的最大值在MIB中，ifOutOctets和ifInOctets来分别表示接口流出数据量和接口流入数据量，单位是字节。其数据类型为counter32。其能表示最大值为2^32-1=4294967295。依据oid的值累加，千兆口跑满32秒就可以达到最大值。 ifHCOutOctets和ifHCInOctets也是分别表示接口流出数据量和接口流入数据量其数据类型为counter64，最大值为16EB这个值的概念是如果千兆口满跑4000多年才能达到。 早起设备有一个这样的建议何时使用何种计数器： 1234&lt;20,000,000 bits&#x2F;second 使用counter32&lt;20,000,000 bits&#x2F;s &lt; 650,000,000bits&#x2F;s 使用counter32或者counter64&gt; 650,000,000bits&#x2F;s 使用 counter64小于 10 Mb 接口不支持 counter64。 对于目前的设备，建议直接使用counter64: 类型 IF-MIB OID counter32 ifInOctets 1.3.6.1.2.1.2.2.1.10 counter32 ifOutOctets 1.3.6.1.2.1.2.2.1.16 counter64 ifHCInOctets 1.3.6.1.2.1.31.1.1.1.6 counter64 ifHCOutOctets 1.3.6.1.2.1.31.1.1.1.10 参考文档CISCO:SNMP计数器：常见问题","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"},{"name":"monitor","slug":"monitor","permalink":"http://nbma.info/tags/monitor/"},{"name":"snmp","slug":"snmp","permalink":"http://nbma.info/tags/snmp/"}]},{"title":"Cisco交换机恢复出厂设置方法","slug":"cisco-switch-reconvery-factory","date":"un55fin55","updated":"un66fin66","comments":true,"path":"cisco-switch-reconvery-factory/","link":"","permalink":"http://nbma.info/cisco-switch-reconvery-factory/","excerpt":"一、通过命令恢复出厂设置 1、delete vlan.dat delete config.text reload","text":"一、通过命令恢复出厂设置 1、delete vlan.dat delete config.text reload Compiled Wed 20-Jul-11 06:23 by prod_rel_team 回车 Would you like to enter the initial configuration dialog? [yes/no]: n 2、delete vlan.dat erase startup-config(与write erase命令效果一样) reload Compiled Wed 20-Jul-11 06:23 by prod_rel_team 回车 Would you like to enter the initial configuration dialog? [yes/no]: n 二、硬恢复出厂设置 1、如果忘记密码，断电重启，按住mode键10s左右，进入rommon模式； 2、长按MODE键12秒钟左右，下面三个灯闪,然后,第二,第三个灯变成橙色,松开自动重启(这样会恢复出厂设置)。 附：新购交换机进入Web页面并进行配置方法： 新购的思科交换机往往都没有说明书，要进行初始化配置，一般都需要专业的网络工程师，通过用CISCO随机带CONSOLE线,一端连在CISCO交换机的CONSOLE口,一端连在计算机的COM口进行设置，这个我们下次再谈，先谈谈菜鸟级的配置。 实际上思科 Catalyst 2950/2960 已经具备了WEB的初始化设置功能，只是没有说明书或者是全英文的说明书，很多人不太了解，我们现在就讲讲这个，以方便非网络专业人员学习和设置。 第一步：先把交换机断电，再接通电源，各LED灯会依次不停的闪烁，等待3分钟。 第二步：等各LED灯无变化后，按下MODE按钮3-4秒不松，待MODE按钮上面的LED灯全亮后松开MODE按钮 这个时候，交换机已经进入了设置状态 第三步：将你的计算机网卡设置为自动获取IP地址，并打开DHCP 第四步：将网络线（直通线）一头接到计算机的网卡，另一头接到交换机的1X口，（注意：一定要1X入口，其他口不行） 这个时候你可以在计算机输入命令，CMD / ipconfig 你可以发现，你计算机取到的ip地址是 10.0.0.2 如果不是，请重新从第一步开始。 第五步：打开计算机的浏览器，输入10.0.0.1 即可出现交换机的配置窗口，我的2960配置窗口居然还是全中文的，好爽。 第六步：依次按说明输入交换机的ip地址、子网掩码、网关、交换机名称、密码，以及远程telnet管理密码，点提交即可。 第七步：交换机将重新启动，按新的ip连接交换机即可。","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"}]},{"title":"chrome在使用idrac6出现“失败 已屏蔽的错误”","slug":"chrome-idrac6-fail-error","date":"un44fin44","updated":"un66fin66","comments":true,"path":"chrome-idrac6-fail-error/","link":"","permalink":"http://nbma.info/chrome-idrac6-fail-error/","excerpt":"出于安全上的考虑，会使用内网IP作为IPMI的管理IP，然后通过ssh的隧道或者xshell的隧道翻墙进行IPMI的管理。","text":"出于安全上的考虑，会使用内网IP作为IPMI的管理IP，然后通过ssh的隧道或者xshell的隧道翻墙进行IPMI的管理。 偶尔会遇到一个问题，就是下载的jnlp文件被chrome屏蔽，转用firefox则会报错”update title error”，一直未能解决。怀疑过idrac的固件版本，比对同组几台尝试更新固件未有结论。因为要用到java的虚拟介质来进行一些重装的操作，得想办法解决。返回到问题现象：检查被屏蔽以及正常下载open的文件之间的差别：https://10.10.10.61/viewer.jnlp(10.10.10.61@0@idrac-99MC53X%2C+PowerEdge+R610%2C+%u7528%u6237%uFF1Aroot@1476947550673) https://10.10.10.51/viewer.jnlp(10.10.10.51@0@idrac-H7SB33X%2C+PowerEdge+R610%2C+%26%2329992%3B%26%2325143%3B%26%2365306%3Broot@1476947000322) 似乎除了后面括号里的一些参数差异之外没有其他不同，尝试将正常的一些参数替代到被屏蔽的url，可以下载但是打开提示超时了。嗯?似乎这个方式可以绕过chrome的某些检测，继续尝试，终于发现了一个方式：打开一个正常的jnlp查看这个文件的名称，将其IP修改为被屏蔽的IP，比如将51修改为61.在浏览器打开（确认代理设置），确认可下载，解决。 这个解决方法应该是绕过了chrome的检测（不清楚chrome这个安全策略到底如何绕过。。）。而且从实际测试上看，chrome应该是对java的相关策略支持最好的。","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"centos","slug":"centos","permalink":"http://nbma.info/tags/centos/"}]},{"title":"csico2911/k9激活securityk9的license","slug":"csico2911k-securityk9-license","date":"un44fin44","updated":"un66fin66","comments":true,"path":"csico2911k-securityk9-license/","link":"","permalink":"http://nbma.info/csico2911k-securityk9-license/","excerpt":"新买了一台2911/K9，不带security功能，找公司买了个license，激活过程如下","text":"新买了一台2911/K9，不带security功能，找公司买了个license，激活过程如下 一、需要具备的东西1. securityk9的license文件：xxxxxxx.lic 2.一台思科2911/K9 3.网线 激活步骤1.PC开启TFTP服务2。将license拷到路由器中router#copy tftp flash0: 按提示输入tftp地址、文件名。然后确认即可 3.安装router#licence install flash0:xxxxxxx.lic 4.安装完成，reload之后show version安装前： 12345678910------------------------------------------------------------------------Technology Technology-package Technology-packageCurrent Type Next reboot------------------------------------------------------------------------ipbase ipbasek9 Permanent ipbasek9&lt;span style&#x3D;&quot;color: #ff0000;&quot;&gt;security None None None&lt;&#x2F;span&gt;uc None None Nonedata None None NoneNtwkEss None None NoneCollabPro None None None 安装reload后： 123456789101112Technology Package License Information for Module:&#39;c2900&#39;------------------------------------------------------------------------ Technology Technology-package Technology-package Current Type Next reboot ------------------------------------------------------------------------ ipbase ipbasek9 Permanent ipbasek9 &lt;span style&#x3D;&quot;color: #ff0000;&quot;&gt;security securityk9 Permanent securityk9&lt;&#x2F;span&gt; uc None None None data None None None NtwkEss None None None CollabPro None None None","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"}]},{"title":"GNS3模拟ASA8.4(2)激活license","slug":"gns3-asa842-license","date":"un11fin11","updated":"un66fin66","comments":true,"path":"gns3-asa842-license/","link":"","permalink":"http://nbma.info/gns3-asa842-license/","excerpt":"正常情况下，用GNS3模拟ASA8.4，模拟出来的系统failover、VPN-DES、VPN-3DES-AES功能是disabled的。需要用liences激活，激活过程如下：","text":"正常情况下，用GNS3模拟ASA8.4，模拟出来的系统failover、VPN-DES、VPN-3DES-AES功能是disabled的。需要用liences激活，激活过程如下： show ver可以看到没激活的功能： ciscoasa(config)# show ver Cisco Adaptive Security Appliance Software Version 8.4(2) Compiled on Wed 15-Jun-11 18:17 by buildersSystem image file is “Unknown, monitor mode tftp booted image”Config file at boot was “startup-config” ciscoasa up 1 hour 13 mins Hardware: ASA 5520, 512 MB RAM, CPU Pentium II 1000 MHzInternal ATA Compact Flash, 256MBBIOS Flash unknown @ 0x0, 0KB0: Ext: GigabitEthernet0 : address is 0000.aba3.be00, irq 01: Ext: GigabitEthernet1 : address is 0000.aba3.be01, irq 02: Ext: GigabitEthernet2 : address is 0000.aba3.be02, irq 03: Ext: GigabitEthernet3 : address is 0000.aba3.be03, irq 0 Licensed features for this platform:Maximum Physical Interfaces : Unlimited perpetualMaximum VLANs : 100 perpetualInside Hosts : Unlimited perpetualFailover : Disabled perpetualVPN-DES : Disabled perpetualVPN-3DES-AES : Disabled perpetualSecurity Contexts : 0 perpetualGTP/GPRS : Disabled perpetualAnyConnect Premium Peers : 5000 perpetualAnyConnect Essentials : Disabled perpetualOther VPN Peers : 5000 perpetualTotal VPN Peers : 0 perpetualShared License : Disabled perpetualAnyConnect for Mobile : Disabled perpetualAnyConnect for Cisco VPN Phone : Disabled perpetualAdvanced Endpoint Assessment : Disabled perpetualUC Phone Proxy Sessions : 2 perpetualTotal UC Proxy Sessions : 2 perpetualBotnet Traffic Filter : Disabled perpetualIntercompany Media Engine : Disabled perpetual This platform has an ASA 5520 VPN Plus license. Serial Number: 123456789ABRunning Permanent Activation Key: 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000Configuration register is 0x0Configuration last modified by enable_15 at 08:15:56.899 UTC Mon Feb 29 2016 &nbsp; 进入config模式，输入license ciscoasa(config)# activation-key 0x4a3ec071 0x0d86fbf6 0x7cb1bc48 0x8b48b8b0 0$Validating activation key. This may take a few minutes…Failed to retrieve permanent activation key.Failover is different.running permanent activation key: Restricted(R)new permanent activation key: Unrestricted(UR)WARNING: The running activation key was not updated with the requested key.Proceed with update flash activation key? [confirm]The flash permanent activation key was updated with the requested key,and will become active after the next reload.ciscoasa(config)# activation-key 0xb23bcf4a 0x1c713b4f 0x7d53bcbc 0xc4f8d09c 0$Validating activation key. This may take a few minutes…Failover is different.running permanent activation key: Restricted(R)new permanent activation key: Unrestricted(UR)WARNING: The running activation key was not updated with the requested key.Proceed with update flash activation key? [confirm]The flash permanent activation key was updated with the requested key,and will become active after the next reload.ciscoasa(config)# reload 重启之后： ciscoasa# show version Cisco Adaptive Security Appliance Software Version 8.4(2) Compiled on Wed 15-Jun-11 18:17 by buildersSystem image file is “Unknown, monitor mode tftp booted image”Config file at boot was “startup-config” ciscoasa up 11 secs Hardware: ASA 5520, 512 MB RAM, CPU Pentium II 1000 MHzInternal ATA Compact Flash, 256MBBIOS Flash unknown @ 0x0, 0KB0: Ext: GigabitEthernet0 : address is 0000.ab2c.3a00, irq 01: Ext: GigabitEthernet1 : address is 0000.ab2c.3a01, irq 02: Ext: GigabitEthernet2 : address is 0000.ab2c.3a02, irq 03: Ext: GigabitEthernet3 : address is 0000.ab2c.3a03, irq 0 Licensed features for this platform:Maximum Physical Interfaces : Unlimited perpetualMaximum VLANs : 100 perpetualInside Hosts : Unlimited perpetualFailover : Active/Active perpetualVPN-DES : Enabled perpetualVPN-3DES-AES : Enabled perpetualSecurity Contexts : 5 perpetualGTP/GPRS : Disabled perpetualAnyConnect Premium Peers : 25 perpetualAnyConnect Essentials : Disabled perpetualOther VPN Peers : 5000 perpetualTotal VPN Peers : 0 perpetualShared License : Enabled perpetualAnyConnect for Mobile : Disabled perpetualAnyConnect for Cisco VPN Phone : Disabled perpetualAdvanced Endpoint Assessment : Enabled perpetualUC Phone Proxy Sessions : 10 perpetualTotal UC Proxy Sessions : 10 perpetualBotnet Traffic Filter : Enabled perpetualIntercompany Media Engine : Enabled perpetual This platform has an ASA 5520 VPN Plus license. Serial Number: 123456789ABRunning Permanent Activation Key: 0xb23bcf4a 0x1c713b4f 0x7d53bcbc 0xc4f8d09c 0x0e24c6b6Configuration register is 0x0Configuration has not been modified since last system restart.ciscoasa# 已激活 下面是两个license: 用这两条命令分两次激活，第一次很快，第二次很慢，估计需要六七分钟。 activation-key 0x4a3ec071 0x0d86fbf6 0x7cb1bc48 0x8b48b8b0 0xf317c0b5activation-key 0xb23bcf4a 0x1c713b4f 0x7d53bcbc 0xc4f8d09c 0x0e24c6b6","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"},{"name":"asa","slug":"asa","permalink":"http://nbma.info/tags/asa/"}]},{"title":"ASA告警，cpu98%","slug":"asa-cpu98","date":"un22fin22","updated":"un66fin66","comments":true,"path":"asa-cpu98/","link":"","permalink":"http://nbma.info/asa-cpu98/","excerpt":"某天上午10点半，网络报警，服务器上不了，连接网络设备卡顿严重，网络告急！！！","text":"某天上午10点半，网络报警，服务器上不了，连接网络设备卡顿严重，网络告急！！！ 打开ASDM发现现象如下：CPU98%、ouside口out方向流量打满。分析如下： **1.ASA的cpu98%**。第一反应：关闭log、关闭snmp。没有反应， cpu正常是在10%以内。 2. 查看接口流量，out方向流量能说明流量来自内部，定位源头区域。锁定inside。 3.登录到下级交换机，查看接口流量，show interface coun 查看每个接口的流速，定位接口。e0/5的流量特别大。锁定e0/5。 4.查看e0/5学习到的mac，有2个。定位主机：1台是web测试机，1台是xx公司的web服务器。 5.查看2台服务器的进程，2台都是linux的系统。web测试机，没有什么进程，处于闲置状态。基本可以排除。把它重启一下，在这过程中，ASA的cpu始终没有下降。所以，完全肯定不是它。真凶是：xx公司的web服务器。 6.验证真凶：重启xx公司的web服务器，ASA的cpu立马下降到3%。果不出其然。 7.导出xx公司的web服务器的log，好好分析原因吧！","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"},{"name":"asa","slug":"asa","permalink":"http://nbma.info/tags/asa/"}]},{"title":"通过站对站的ipsec vpn无法ping通ASA的inside口","slug":"ipsec-vpn-ping-asa-inside","date":"un22fin22","updated":"un66fin66","comments":true,"path":"ipsec-vpn-ping-asa-inside/","link":"","permalink":"http://nbma.info/ipsec-vpn-ping-asa-inside/","excerpt":"正常情况下，ASA只允许相应方向的地址ping对应的接口，公网地址能ping通ouside口，内部直连inside网段可以ping通inside口. 某公司在A/B两个IDC机房之间通过两台ASA配置了ipsec vpn，并且在A机房部署了zabbix监控，通过私有地址监控网络状态","text":"正常情况下，ASA只允许相应方向的地址ping对应的接口，公网地址能ping通ouside口，内部直连inside网段可以ping通inside口. 某公司在A/B两个IDC机房之间通过两台ASA配置了ipsec vpn，并且在A机房部署了zabbix监控，通过私有地址监控网络状态 在配置B机房的ASA监控时，从zabbix服务器无法ping到B机房的ASA inside口，查询思科文档发现如下文字： Ping 其他接口management-access 命令使用户只有在使用全通道 IPSec VPN 或 SSL VPN 客户端（AnyConnect 2.x 客户端 SVC 1.x）或通过站点到站点 IPSec 通道连接到 PIX/ASA 时，才可以从外部连接到 management-access 接口。 除非已在全局配置模式下配置了 management-access，否则无法从外部访问 PIX 的内部接口。 asa(config)#**management-access inside** asa(config)#**show running-config management-access** management-access inside 在B机房ASA配置模式下，配置对应命令保存。 在9.2以前的版本，只需要配置management-access inside即可，但是在9.4之后，思科对ASA上配置ipsec的nat赦免规则做了调整，默认解密之后不再查找路由表，而是直接按照nat规则放到出接口，所以，在这个版本之后，nat赦免需要添加一个feature：route-lookup 1nat (inside,outside) source static INISIDE-NET INISIDE-NET destination static REMOTE-NET REMOTE-NET route-lookup 指定route-lookup命令会告诉ASA查看条目的路由表，然后相应地转发数据包。在比较早的ASA版本是默认查询路由表的。新版需要手动指定。 9ps@C","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"},{"name":"asa","slug":"asa","permalink":"http://nbma.info/tags/asa/"},{"name":"ipsec","slug":"ipsec","permalink":"http://nbma.info/tags/ipsec/"}]},{"title":"华为USG6000防火墙L2TP over IPSec配置","slug":"usg6000-l2tp-over-ipsec","date":"un00fin00","updated":"un66fin66","comments":true,"path":"usg6000-l2tp-over-ipsec/","link":"","permalink":"http://nbma.info/usg6000-l2tp-over-ipsec/","excerpt":"","text":"马克http://www.huawei.com/ecommunity/bbs/10216483.html【组网需求】如图下所示，公司通过USG5500（V3R1版本）连接Internet。公司希望出差员工能够使用手机（3G/4G）接入公司内部网络，实现安全、高效的移动办公。http://support.huawei.com/ecommunity/bbs/10246004.htmlhttp://support.huawei.com/enterprise/productsupport?lang=zh&amp;pid=8661805&amp;idAbsPath=7919710|9856724|21430823|21100508|8661805","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"},{"name":"ipsec","slug":"ipsec","permalink":"http://nbma.info/tags/ipsec/"}]},{"title":"流量劫持 —— 浮层登录框的隐患","slug":"danger-behind-popup-login-dialog","date":"un11fin11","updated":"un66fin66","comments":true,"path":"danger-behind-popup-login-dialog/","link":"","permalink":"http://nbma.info/danger-behind-popup-login-dialog/","excerpt":"传统的登录框在之前的文章流量劫持危害详细讲解了 HTTP 的高危性，以至于重要的操作都使用 HTTPS 协议，来保障流量在途中的安全。","text":"传统的登录框在之前的文章流量劫持危害详细讲解了 HTTP 的高危性，以至于重要的操作都使用 HTTPS 协议，来保障流量在途中的安全。 ![](http://fex.baidu.com/img/danger-behind-popup-login-dialog/traditional-login.png) 这是最经典的登录模式。尽管主页面并没有开启 HTTPS，但登录时会跳转到一个安全页面来进行，所以整个过程仍是比较安全的 —— 至少在登录页面是安全的。 对于这种安全页面的登录模式，黑客硬要下手仍是有办法的。在之前的文章里也列举了几种最常用的方法：拦截 HTTPS 向下转型、伪造证书、跳转钓鱼网站。 ![](http://fex.baidu.com/img/danger-behind-popup-login-dialog/traditional-danger.png) 其中转型 HTTPS 的手段最为先进，甚至一些安全意识较强的用户也时有疏忽。 然而，用户的意识和知识总是在不断提升的。尤其在如今各种网上交易的时代，安全常识广泛普及，用户在账号登录时会格外留心，就像过马路时那样变得小心翼翼。 久而久之，用户的火眼金睛一扫地址栏即可识别破绽。 ![](http://fex.baidu.com/img/danger-behind-popup-login-dialog/hehe.png) 因此，这种传统的登录模式，仍具备一定的安全性，至少能给用户提供识别真假的机会。 华丽的登录框不知从何时起，人们开始热衷在网页里模仿传统应用程序的界面。无论控件、窗口还是交互体验，纷纷向着本地程序靠拢，效果越做越绚。 然而华丽的背后，其本质仍是一个网页，自然掩盖不了网页的安全缺陷。 当网页特效蔓延到一些重要数据的交互 —— 例如账号登录时，风险也随之产生。因为它改变了用户的使用习惯，同时也彻底颠覆了传统的意识。 ![](http://fex.baidu.com/img/danger-behind-popup-login-dialog/modern-login.png) 乍一看，似乎也没什么问题。虽然未使用登录页跳转，但数据仍通过 HTTPS 传输，途中还是无法被截获。 HTTP 页面用 HTTPS 有意义吗？如果认为这类登录框没什么大问题，显然还没领悟到『流量劫持』的精髓 —— 流量不是单向的，而是有进也有出。 能捕获你『出流量』的黑客，大多也有办法控制你的『入流量』。这在流量劫持第一篇里也详细列举了。 使用 HTTPS 确实能保障通信的安全。但在这个场合里，它只能保障『发送』的数据，对于『接收』的流量，则完全不在其保护范围内。 因为整个登录框都当作『虚拟窗口』嵌套在主页面里的，因此其中的一切都在同个页面环境里。而主页面使用的仍是不安全的 HTTP 协议，所以注入的 XSS 代码能轻而易举的控制登录框。 ![](http://fex.baidu.com/img/danger-behind-popup-login-dialog/modern-login-inject.png) 当然，或许你会说这只是设计缺陷。若是直接嵌入 HTTPS 登录页的 iframe 框架，那就会因同源策略而无法被 XSS 控制了。 这样的改进确实能提高一些安全性，但也只是略微的。既然我们能控制主页面，里面显示什么内容完全可以由 XSS 说了算。不论什么登录框、框架页，甚至安全插件，我们都可以将其删除，用看起来完全相同的文本框代替。得到账号后，通过后台反向代理实现登录，然后通知前端脚本伪造一个登录成功的界面。 所以，HTTPS 被用在 HTTP 页面里，意义就大幅下降了。 和『缓存投毒』配合出击在流量劫持第二篇里提到『HTTP 缓存投毒』这一概念，只要流量暂时性的被劫持，都可导致缓存长期感染。但这种攻击有个前提，必须事先找到站点下较稳定的脚本资源，做投毒的对象。 传统登录在传统的登录模式里，缓存投毒非常难以利用： HTTPS 资源显然无法被感染。 而使用 HTTPS 向下转型的方案，也会因为离开劫持环境，而无法访问中间人的 HTTP 版登陆页面，导致缓存失效；或者这个真实的 HTTP 版的登录页面根本就不接受你的本地缓存，直接重定向到正常的 HTTPS 页面。 因此只有在主页面上，修改链接地址，让用户跳转到钓鱼网站去登录，才能勉强利用。 浮层登录制作一个精良的浮层登录框，需要不少的界面代码，所以经常引用 jQuery 这类通用脚本库。而这些脚本往往是长久不会修改的，因此是缓存投毒的绝好原料。 所以，浮层登录框的存在，让『缓存投毒』有了绝佳的用武之地。 在之前的文章 WiFi流量劫持 —— JS脚本缓存投毒，演示了如何利用 www.163.com 下的某个长缓存脚本进行投毒，最终利用网易的浮层登录框获取账号。尽管网易也使用 HTTPS 传输账号数据，但在流量攻击面前不堪一击。 尽管这种登录模式风险重重，但最近百度也升级成浮层登录框，并且还是所有产品。所以，我们再次尝试那套的古老方法，看看在如今是否仍能发起攻击。 我们选几个最常用的产品线，进行一次缓存扫描： ![](http://fex.baidu.com/img/danger-behind-popup-login-dialog/cache-sniffer.png) 果然，每个产品线里都有长期未修改、并且缓存很久的脚本库。 接着开启我们的钓鱼热点，让前来连接的用户，访问任何一个页面都能中毒。 为了让钓鱼热点更隐蔽，这次我们不再使用路由器，而是利用报废的安卓手机（下一篇文章详细讲解如何实现）。 ![](http://fex.baidu.com/img/danger-behind-popup-login-dialog/phishing-wifi.jpg) 为了不影响附近办公，本文就不演示同名热点钓鱼了，所以随便取了个名字。 接着让『受害者』来连一下我们的热点： ![](http://fex.baidu.com/img/danger-behind-popup-login-dialog/connect-wifi.jpg) 之前正好开着网页，所以很快收到了 HTTP 请求。我们在任何网页里注入 XSS，进行缓存投毒。 （由于原理和之前讲一样，所以这里就省略步骤了） 然后重启电脑，连上正常的 WiFi（模拟用户回到安全的场合）。 打开 tiebai.baidu.com，一切正常。 ![](http://fex.baidu.com/img/danger-behind-popup-login-dialog/tieba.jpg) 开始登录了。。。 看看这种浮层登录框，能否躲避我们的从沉睡中唤起的 XSS 脚本： ![](http://fex.baidu.com/img/danger-behind-popup-login-dialog/tieba-poisoning.jpg) 奇迹依然发生！ 由于之前有过详细的原理讲解，因此这里就不再累述了。不过在实战中，缓存投毒+非安全页面登录框，是批量获取明文账号的最理想手段。 不可逆的记忆如果现在再将登录模式换回传统的，还来得及吗？显然，为时已晚。 当网站第一次从传统登录，升级到浮层登录时，用户大多不会立即输入，而是『欣赏』下这个新版本的创意。确认不是病毒广告弹出的窗口，而是真的官方设计的，才开始登录。 当用户多次使用浮层登录框之后，慢慢也就接受了这种新模式。 即使未来，网站取消了浮层登录，黑客使用 XSS 创建一个类似的浮层，用户仍会毫不犹豫的输入账号。因为在他们的记忆里，官方就曾使用过，仍然保留着对其信任度。 安全性升级既然这个过程是不可逆的，撤回传统模式意义也不大。事实上，使用浮层的用户体验还是不错的，对于不了解安全性的用户来说，还是喜欢华丽的界面。 要保留体验，又得考虑安全性，最好的解决方案就是将所有的页面都使用 HTTPS，将站点武装到牙齿，不留一丝安全缝隙。这也是未来网站的趋势。 &lt;/div&gt;","categories":[{"name":"收藏分享","slug":"收藏分享","permalink":"http://nbma.info/categories/%E6%94%B6%E8%97%8F%E5%88%86%E4%BA%AB/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"}]},{"title":"流量劫持能有多大危害？","slug":"traffic-hijack-2","date":"un55fin55","updated":"un66fin66","comments":true,"path":"traffic-hijack-2/","link":"","permalink":"http://nbma.info/traffic-hijack-2/","excerpt":"上一篇文章，介绍了常见的流量劫持途径。然而无论用何种方式获得流量，只有加以利用才能发挥作用。 不同的劫持方式，获得的流量也有所差异。DNS 劫持，只能截获通过域名发起的流量，直接使用 IP 地址的通信则不受影响；CDN 入侵，只有浏览网页或下载时才有风险，其他场合则毫无问题；而网关被劫持，用户所有流量都难逃魔掌。","text":"上一篇文章，介绍了常见的流量劫持途径。然而无论用何种方式获得流量，只有加以利用才能发挥作用。 不同的劫持方式，获得的流量也有所差异。DNS 劫持，只能截获通过域名发起的流量，直接使用 IP 地址的通信则不受影响；CDN 入侵，只有浏览网页或下载时才有风险，其他场合则毫无问题；而网关被劫持，用户所有流量都难逃魔掌。 在本文中，我们通过技术原理，讲解如下问题： 为什么喜欢劫持网页？ 只浏览不登陆就没事吗？ 自动填写表单有风险吗？ 离开劫持环境还受影响吗？ 使用 HTTPS 能否避免劫持？ 流量劫持能否控制我电脑？ 为什么喜欢劫持网页？理论上说，劫持到用户的流量数据，也就获得相应程序的网络通信。但在现实中，数据并不代表真实内容。一些重要的网络程序，都是私有的二进制协议，以及各种加密方式。想通过流量来还原出用户的聊天信息、支付密码，几乎是不可能的。即使花费各种手段，破解出某个程序的通信协议，然而一旦程序升级改变了协议格式，或许就前功尽弃了。因此，很难找到种一劳永逸的客户端劫持方案。 然而，并非所有程序都是客户端的。一种新兴的应用模式 —— WebApp，发展是如此之快，以至于超越客户端之势。在如今这个讲究跨平台、体验好，并有云端支持的年代，WebApp 越来越火热。各种应用纷纷移植成网页版，一些甚至替代了客户端。同时，也造就了流量劫持前所未有的势头。 WebApp，其本质仍是普通的网页而已。尽管网页技术在近些年里有了很大的发展，各种新功能一再增加，但其底层协议始终没有太大的改进 —— HTTP，一种使用了 20 多年古老协议。 在 HTTP 里，一切都是明文传输的，流量在途中可随心所欲的被控制。传统程序事先已下至本地，运行时只有通信流量；而在线使用的 WebApp，流量里既有通信数据，又有程序的界面和代码，劫持简直轻而易举。 上一篇也提到，如果在户外没有 3G 信号的地方钓鱼，无法将获得的流量转发到外网。然而，使用网页这一切就迎刃而解。我们完全可以在自己的设备上搭建一个站点，留住用户发起离线攻击。对于那些连上 WiFi 能自动弹网页的设备，那就更容易入侵了。 因此，劫持网页流量成了各路黑客们的钟爱，一种可在任意网页发起 XSS 的入侵方式。 ![](http://fex.baidu.com/img/traffic-hijack-2/http-inject.png) 下面，开始我们的攻防之旅。 只浏览不登陆就没事吗？每当砖家出来提醒时，总免不了这么一句：公共场合尽量不登录账号。于是，大家就认为只看网页不登陆就平安无事了。 如果是公共的电脑，那也就无所谓；否则，自己的一些账号可能就倒霉了。 在自己的设备上，大家都会记住各种账号的登录状态，反正只有自己用，也没什么大不了的。然而，在被劫持的网络里，一切皆有可能发生。即使浏览再平常不过的网页，或许一个悄无声息的间谍脚本已暗藏其中，正偷偷访问你那登录着的网页，操控起你的账号了。 听起来似乎很玄乎吧，砖家似乎也没说已登录的账号会怎么样。难道随便一个网页，就能让各种账号被控制吗？ 大家都知道，HTTP 是无状态的，不像传统协议有个『会话』之类的概念。各种账号的登录状态，只能依靠浏览器的 Cookie 来实现。因此，只要有了的 Cookie 也就获得了用户账号的使用权。 和传统 XSS 攻击不同，流量劫持可以得到任何通信数据，当然也包括那些受 HttpOnly 保护的 Cookie。攻击脚本只需对某个站点发起请求，黑客即可在中途劫持到传输的 Cookie 数据。如果同时发起众多站点，就能覆盖相当一部分目标了。 ![](http://fex.baidu.com/img/traffic-hijack-2/cookie-sniffer.png) 这种请求未必要真正访问一次页面，仅仅将 URL 作为图片加载，将目标站点的 Cookie 送出即可。 黑客得到 Cookie，即可在自己浏览器里还原出登录状态。尽管你确实没有登录操作，但那些已登录的却能出卖你。 _防范措施_：访问一些重要的网站，尽量不要记住登录状态，以免 Cookie 被泄露。不过，只要网站绑定了 Cookie 和 IP 段，这招的危害程度就大幅降低了，仅凭 HttpOnly 还是很不靠谱的。 自动填写表单有风险吗？使用上面的方法获得 Cookie，即使能控制账号，但其密码仍无法得知，随时都有可能失去控制权。 不过，一些用户有让浏览器自动保存密码的习惯。通过这点，我们是否能套出记住的密码来呢？ 分析下浏览器是如何自动填写页面表单的。其实很简单，浏览器发现页面 URL 和表单名匹配记录里的，就自动填上了。 ![](http://fex.baidu.com/img/traffic-hijack-2/save-pwd.png) 要是在流量可控的网络里，剥离页面所有内容只剩表单，又会如何？ ![](http://fex.baidu.com/img/traffic-hijack-2/match-pwd.png) 保存着的密码仍能自动填上，并且可被脚本访问到！ 如果我们在用户访问的页面里，创建大量的隐藏框架页，即可尝试获取各种网站保存着的账号了。（如今 Chrome 框架页已经不会自动填写了。具体实现和浏览器有关）。 然而，即使框架页不自动填写，但主页面总得保留该功能吧。如果发现用户某个打开着的网页很久没有交互了，可悄悄跳转到如上那样的纯表单页，无论能否获取数据，都将继续跳转，一个接一个的尝试。。。直到用户切回窗口，再恢复到原先那个页面。 ![](http://fex.baidu.com/img/traffic-hijack-2/save-sniffer.png) 由于泄露的是明文的账号和密码，即使数量不多，也能通过社工获取到用户的更多信息，最终导致更严重的泄露。 _防范措施_：所以无论是 Cookie 记住登录，还是浏览器自动填表，重要的账号都应慎用。 浏览器的自动填表也应增加些安全策略，例如必须有用户的交互才开始填写，规定的时间里只能填有限次。 离开劫持环境还受影响吗？或许你在想，网络再怎么不安全，离开之后就应该没事了吧。 有时在公共场合赶上免费的 WiFi，打开网页看一会新闻，是常有的事。这么短的时间里能有多大的事。不过在入侵脚本面前，一小会和长久并没太大区别。机会只要出现了，无论多么短暂都能渗透。 如果只看重眼前利益，这种短暂的入侵并没多少利用价值；但若放远目光，能让攻击在今后发起，那就不再局限于时间和空间了。因此，我们需要一个时光机，让入侵脚本穿越到用户未来的时空运行。 若用传统 XSS 的思维，这几乎无法实现。但在流量劫持面前，一切皆有可能 —— 因为我们能控制任意流量！ HTTP 缓存投毒上一篇文章提到，但凡有缓存的地方都是大有可为的。显然，对于有着复杂的 HTTP 缓存系统来说，存在缺陷是在所难免了。这种简单的纯文本协议，几乎没有一种签名机制，来验证内容的真实性。即使页面被篡改了，浏览器也完全无法得知，甚至连同注入的脚本也一块缓存起来。 于是，我们可以将『缓存投毒』的概念，引入 HTTP 协议里。但凡具备可执行的资源，都可以通过预加载带毒的版本，将其提前缓存起来。 为了将缓存的有效期发挥到极致，我们事先在各大网站上，找出一些过期时间长、很久没有修改的资源，评估其未来变化不大的可能。 ![](http://fex.baidu.com/img/traffic-hijack-2/find-stable-res.png) 当用户打开任意一个 HTTP 网页时，注入的 XSS 代码开始预加载这些资源。由于一切流量都在控制之中，我们可以完全不走代理，而是返回自己的攻击脚本。 ![](http://fex.baidu.com/img/traffic-hijack-2/cache-poisoning.png) 用户浏览器收到回复后，就将其一一缓存起来了。我们可以事先收集大量的资源地址，让用户在线的时间里，尽可能多的缓存受到感染。 未来，用户访问引用了这些资源的网站时，入侵脚本将穿越时空，从沉睡中唤醒。 ![](http://fex.baidu.com/img/traffic-hijack-2/cache-actived.png) 只要用户不清空缓存，这些被感染的脚本始终附着在浏览器缓存里，直到用户强制刷新页面时或许才能解脱。更多细节可参考这里。 离线储存投毒不过，有些网站使用的都是很短的缓存，上述的入侵方式似乎就无能为力了。不过，HTML5 时代带来了一项新的缓存技术 —— 离线储存。由于它没有过期时间，因此适用于任意网页的投毒！ 类似的，当用户触发了我们的注入脚本之后，我们创建一个隐形的框架页，加载被感染的网页。同样，通过流量劫持，我们返回一个简单的页面，里面包含一个带有 manifest 属性的 HTML 文档，以及后期运行的脚本。 ![](http://fex.baidu.com/img/traffic-hijack-2/offline-poisoning.png) 由于通过隐藏框架访问了这个页面，用户并不知情，但尽职的浏览器却将其缓存起来。 未来，用户打开被感染的网页时，浏览器直接从离线储存里取出，其中布置的脚本因此触发。 由于是个空白页面，因此需要填充上真实的网站内容。最简单的方法，就是嵌套一个原页面的框架，并在 URL 里加上随机数，确保是最新的在线内容。 ![](http://fex.baidu.com/img/traffic-hijack-2/offline-actived.png) 因为嵌套的是同域框架，最终仍能被入侵脚本所控制。 不过，离线存储投毒的后期影响会小一些。未来用户在安全的网络里打开页面时，虽然能立即显示之前缓存的页面，但同时也会尝试访问 .appcache 文件。由于这个文件大多都不存在，因此浏览器很可能删除掉离线数据，导致之后的访问不再使用离线储存。 因此理论上说只有一次的触发机会，但它没有过期时间，适用于任意 HTTP 页面投毒。 _防范措施_：在不安全的场合，尽量使用『隐身模式』浏览网页。例如 Chrome 里按 Ctrl+Shift+N 就能调出，可将自己处于隔离的沙盒里。 FireFox 浏览器存储离线文件时，会有用户交互提示，提醒用户是否有这必要。 也许不久后，框架页面不再被离线储存所接受，新标准随时都有可能改变。但 HTTP 缓存投毒是协议栈的缺陷，因此很难防范，下一篇会发现实际入侵效果非常理想。 使用 HTTPS 能否避免劫持？如果从密码学的角度来说，使用了 SSL 加密的数据确实难以破解，更不用谈修改了。 然而，惹不起但总躲得起吧。虽然无法破解，但流量仍掌握在自己手中，走哪条路还是由我说的算，完全可以绕过你。 偷换证书不同于简单的 HTTP 代理，HTTPS 服务需要一个权威机构认定的证书才算有效。自己随便签发的证书，显然是没有说服力的，HTTPS 客户端因此会质疑。 在过去，这并不怎么影响使用过程，无非弹出一个无效的证书之类的提示框。大多用户并不明白是什么情况，就点了继续，导致允许了黑客的伪证书，HTTPS 流量因此遭到劫持。 ![](http://fex.baidu.com/img/traffic-hijack-2/ssl-proxy.png) 在经历越来越多的入侵事件之后，人们逐渐意识到，不能再轻易的让用户接受不信任的证书了。如今，主流浏览器对此都会给予严重的警告提示，避免用户进入伪安全站点。 ![](http://fex.baidu.com/img/traffic-hijack-2/ssl-err.png) 如果重要的账户网站遇到这种情况，无论如何都不该继续，否则大门钥匙或许就落入黑客之手。 因此，这种偷换证书的劫持，在安全意识越来越高的今天，很难再发挥实效了。我们需要一个更隐蔽的方式来躲开加密数据。 过滤 HTTPS 跳转事实上，在 PC 端上网很少有直接进入 HTTPS 网站的。例如支付宝网站，大多是从淘宝跳转过来，而淘宝使用的仍是不安全的 HTTP 协议。如果在淘宝网的页面里注入 XSS，屏蔽对 HTTPS 的页面访问，用 HTTP 取而代之，那么用户也就永远无法进入安全站点了。 ![](http://fex.baidu.com/img/traffic-hijack-2/from-http.png) 尽管地址栏里没有出现 HTTPS 的字样，但域名看起来也是正确的，大多用户都会认为不是钓鱼网站，因此也就忽视了。 因此，只要入口页是不安全的，那么之后的页面再安全也无济于事。 当然也有一些用户通过输网址访问的，他们输入了 www.alipaly.com 就敲回车进入了。然而，浏览器并不知道这是一个 HTTPS 的站点，于是使用默认的 HTTP 去访问。不过这个 HTTP 版的支付宝的确也存在，其唯一功能就是重定向到自己 HTTPS 站点上。 劫持流量的中间人一旦发现有重定向到 HTTPS 站点的，显然不愿意让用户走这条不受自己控制的路。于是拦下重定向的命令，自己去获取重定向后的站点内容，然后再回复给用户。于是，用户始终都是在 HTTP 站点上访问，自然就可以无限劫持了。 ![](http://fex.baidu.com/img/traffic-hijack-2/direct-http.png) 搜索引擎劫持事实上，HTTPS 站点还有个很大的来源 —— 搜索引擎。遗憾的是，国产搜索引擎几乎都不提供 HTTPS 服务。因此在不安全的网络里，搜索结果是不具备任何权威的。 _防范措施_：重要的网站必定使用 HTTPS 协议，登陆时需格外留意。 国外的大型网站几乎都提供 HTTPS 服务，甚至是默认的标准。相比国内只有少数重要的服务才使用，绝大多数的信息都是在明文传输。这是为了方便什么来着，你猜。 流量劫持能否控制我电脑？如果不考虑一些浏览器安全漏洞，理论上说网页与系统是完全隔离的，因此无需担心系统受到影响。 钓鱼插件有时为了能让网页获得更多的在线能力，安装插件必不可少，例如支付控件、在线播放器等等。在方便使用的同时，也埋下了安全隐患。 如果是一些小网站强迫用户安装插件的，大家几乎都是置之不理。但若一些正规的大网站，提示用户缺少某些插件，并且配上一些专业的提示，相信大多都会选择安装。而这一切，通过被注入的攻击脚本完全能办到。 ![](http://fex.baidu.com/img/traffic-hijack-2/plugin-phishing.png) 不过，正规的插件都是有完整的数字签名的，而伪造的很难躲过浏览器的验证，会出现各种安全提示。因此，攻击者往往使用直接下载的方式，提示用户保存并打开安装包。 页面提权现在越来越多的应用程序，选择使用内嵌网页来简化界面的开发，在移动设备上更是普遍。 通常为了能让页面和客户端交互，赋予一些本地程序的接口供调用，因此具有了较高的权限。不过，正常情况下嵌入的都是受白名单限制的可信页面，因此不存在安全隐患。 然而在被劫持的网络里，一切明文传输的数据都不再具备可信度。同样的脚本注入，就能获得额外的权限了。 ![](http://fex.baidu.com/img/traffic-hijack-2/hybrid-app.png) 一些带有缺陷的系统，攻击脚本甚至能获得出乎意料的能力。通过之前提到的网页缓存投毒，这颗埋下的地雷随时都有可能触发。 下载程序即使上网从不安装插件，但是下载程序还是经常需要的。由于大多数的下载网站，使用的都是 HTTP 流量，因此劫持者能轻易的修改可执行文件，将其感染上病毒或木马，甚至完全替换成另一个程序。 用户总认为从官网上下载的肯定没问题，于是就毫无顾虑的打开了。这时，入侵的不再是浏览器环境，而是能控制整个系统了。 _防范措施_：如果是从浏览器里下载的程序，留意是否具有数字签名，正规的厂商几乎都会提供。如果想试用一些来路不明的小程序，保存到虚拟机里使用就放心多了。 未来 SPDY 技术普及的时候，就再不用担心网页劫持这些事。它将 HTTP 协议封装在加密的流量里传输，想劫持一个普通网页都很困难了。 结尾暂时就说到这。事实上类似 XSS 的攻击方式还有很多，这里只谈了一些能和流量劫持配合使用的。利用上一篇讲述的各种劫持途径，配合本文提到的入侵方式，可以劫持不少用户了。下一篇，将演示如何利用这些原理，发起实战攻击。","categories":[{"name":"收藏分享","slug":"收藏分享","permalink":"http://nbma.info/categories/%E6%94%B6%E8%97%8F%E5%88%86%E4%BA%AB/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"}]},{"title":"流量劫持是如何产生的？","slug":"traffic-hijack","date":"un55fin55","updated":"un66fin66","comments":true,"path":"traffic-hijack/","link":"","permalink":"http://nbma.info/traffic-hijack/","excerpt":"流量劫持，这种古老的攻击沉寂了一段时间后，最近又开始闹的沸沸扬扬。众多知名品牌的路由器相继爆出存在安全漏洞，引来国内媒体纷纷报道。只要用户没改默认密码，打开一个网页甚至帖子，路由器配置就会被暗中修改。互联网一夜间变得岌岌可危。","text":"流量劫持，这种古老的攻击沉寂了一段时间后，最近又开始闹的沸沸扬扬。众多知名品牌的路由器相继爆出存在安全漏洞，引来国内媒体纷纷报道。只要用户没改默认密码，打开一个网页甚至帖子，路由器配置就会被暗中修改。互联网一夜间变得岌岌可危。 攻击还是那几种攻击，报道仍是那千篇一律的砖家提醒，以至于大家都麻木了。早已见惯运营商的各种劫持，频繁的广告弹窗，大家也无可奈何。这么多年也没出现过什么损失，也就睁只眼闭只眼。 事实上，仅仅被运营商劫持算是比较幸运了。相比隐匿在暗中的神秘黑客，运营商作为公众企业还是得守法的，广告劫持虽无节操但还是有底线的。这不，能让你看见广告了，也算是在提醒你，当前网络存在被劫持的风险，得留点神；相反，一切看似风平浪静毫无异常，或许已有一个天大的间谍潜伏在网络里，随时等你上钩 —— 这可不是弹广告那样简单，而是要谋财盗号了！ 我会被劫持吗？不少人存在这样的观点：只有那些安全意识薄弱的才会被入侵。只要装了各种专业的防火墙，系统补丁及时更新，所有的密码都很复杂，劫持肯定是轮不到我了。 的确，安全意识强的自然不容易被入侵，但那只对传统的病毒木马而已。而在流量劫持面前，几乎是人人平等的。网络安全与传统的系统安全不同，网络是各种硬件设备组合的整体，木桶效应尤为明显。即使有神一样的系统，但遇到猪一样的设备，你的安全等级瞬间就被拉低了。现在越来越流行便宜的小路由，它们可是承载着各种网上交易的流量，你能放心使用吗？ 即使你相信系统和设备都绝对可靠，就能高枕无忧了吗？事实上有问题的设备并不多，但出问题的事却不少，难道其中还存在什么缺陷？没错，还遗漏了最重要的一点：网络环境。 如果网络环境里有黑客潜伏着，即使有足够专业的技术，是在所难逃了，敌暗我明，稍不留神就会落入圈套。 当然，苍蝇不叮无缝的蛋。有哪些隐患导致你的网络环境出现了裂缝？太多了，从古到今流行过的攻击方式数不胜数。甚至可以根据实际环境，自己创造一种。 现在回忆下尝试过的劫持案例。 上古时代： Hub 嗅探 MAC 欺骗 MAC 冲刷 ARP 攻击 DHCP 钓鱼 DNS 劫持 CDN 入侵 中世纪： 路由器弱口令 路由器 CSRF PPPoE 钓鱼 蜜罐代理 工业时代： WiFi 弱口令 WiFi 伪热点 WiFi 强制断线 WLAN 基站钓鱼 Hub 嗅探集线器（Hub）这种设备如今早已销声匿迹了，即使在十年前也少有人用。作为早期的网络设备，它唯一的功能就是广播数据包：把一个接口的收到的数据包群发到所有接口上。且不吐槽那小得惊人的带宽，光是这转发规则就是多么的不合理。任何人能收到整个网络环境的数据，隐私安全可想而知。 ![](http://fex.baidu.com/img/traffic-hijack/hub.png) 嗅探器成了那个时代的顶尖利器。只要配置好过滤器，不多久就能捕捉到各种明文数据，用户却没有任何防御对策。 _防范措施_：还在用的赶紧扔了吧。 这种设备目前唯一可用之处就是旁路嗅探。利用广播的特性，可以非常方便分析其他设备的通信，例如抓取机顶盒的数据包而不影响正常通信。 MAC 欺骗交换机的出现逐渐淘汰了集线器。交换机会绑定 MAC 地址和接口，数据包最终只发往一个终端。因此只要事先配置好 MAC 对应的接口，理论上非常安全了。 ![](http://fex.baidu.com/img/traffic-hijack/switch.png) 不过，很少有人会那么做，大多为了偷懒，直接使用了设备默认的模式 —— 自动学习。设备根据某个接口发出的包，自动关联该包的源地址到此接口。 然而这种学习并不智能，甚至太过死板，任何一个道听途说都会当作真理。用户发送一个自定义源 MAC 地址的包是非常容易的，因此交换机成了非常容易被忽悠的对象。只要伪造一个源地址，就能将这个地址关联到自己的接口上，以此获得受害者的流量。 ![](http://fex.baidu.com/img/traffic-hijack/switch-spoofing.png) 不过，受害者接着再发出一个包，绑定关系又恢复原先正常的。因此只要比谁发的频繁，谁就能竞争到这个 MAC 地址的接收权。如果伪造的是网关地址，交换机就误以为网关电缆插到你接口上，网络环境里的出站流量瞬间都到了你这里。 当然，除非你有其他出站渠道，可以将窃取的数据代理出去；否则就别想再转发给被你打垮的真网关了，被劫持的用户也就没法上外网。所以这招危害性不是很大，但破坏性很强，可以瞬间集体断网。 _防范措施_：机器固定的网络尽量绑定 MAC 和接口吧。貌似大多数网吧都绑定了 MAC 和接口，极大增强了链路层的安全性。同时，独立的子网段尽可能划分 VLAN，避免过大的广播环境。 大学里见过千人以上还不划分 VLAN 的，用一根短路网线就可以毁掉整个网络。 MAC 冲刷之前说了集线器和交换机的转发区别。如果交换机发现一个暂时还未学习到的 MAC 地址，将会把数据包送往何处呢？为了不丢包，只能是广播到所有接口。 ![](http://fex.baidu.com/img/traffic-hijack/switch-broadcast.png) 如果能让交换机的学习功能失效，那就退化成一个集线器了。由于交换机的硬件配置有限，显然不可能无限多的记录地址对应条目。我们不停伪造不重复的源地址，交换机里的记录表很快就会填满，甚至覆盖原有的学习记录，用户的数据包无法正常转发，只能广播到所有接口上了。 ![](http://fex.baidu.com/img/traffic-hijack/switch-flood.png) _防范措施_：还是 MAC 和接口绑定。一旦绑定，该接口只允许固定的源地址，伪造的自然就失效了。当然，好一点的交换机都有些策略，不会让一个接口关联过多的 MAC 地址。 曾经在家试过一次，捕捉到小区内用户上网的流量。不过伪造包发的太快，~15万包/秒，更致命的是发错目标地址，发到城域网准入服务器上，导致工作人员切断了整个小区半天的网络… 所以必须得选一个 VLAN 内的、并且实际存在的地址做为目标 MAC，以免产生大量的数据风暴。 ARP 攻击这种攻击大家几乎都听出老茧了，即使不懂电脑的人也知道装个 ARP 防火墙保平安，其危害之大可想而知。 简单的说，ARP 就是广播查询某个 IP 对应的 MAC 地址，在用这个 IP 的人回个声。知道这个 IP 对应的 MAC 地址，就可以链路通信了（链路层只能通过MAC地址通信）。 ![](http://fex.baidu.com/img/traffic-hijack/arp-request.png) 如果有人冒充回复，并抢在正常人之前，伪造的答案也就先入为主。IP 被解析到错误的地址上，之后所有的通信都被劫持了。 ![](http://fex.baidu.com/img/traffic-hijack/arp-spoofing.png) 事实上，早期的系统还有个更严重的BUG：直接给用户发送一个 ARP 回复包，即使对方从没请求过，系统也会接受这个回复，并提前保存里面的记录。这种基于缓存的投毒，让劫持成功率更上一层楼。 ![](http://fex.baidu.com/img/traffic-hijack/arp-poisoning.png) _防范措施_：由于这种攻击太过泛滥，以至大部分路由器都带了防 ARP 攻击的功能。客户端的 ARP 防火墙也数不胜数，似乎成了安全软件的标配。当然，系统也支持强制绑定 IP 与 MAC 的对应，必要时可以使用。 很多教程都是用 Wireshark 来演示，事实上当年有一款叫 Iris 的软件非常好用，可以修改封包再次发送，用它可以很容易搞明白各种攻击的原理。不过N年没更新了还不支持64位的。 DHCP 钓鱼现实中，并不是每个人都会配置网络参数，或者出于方便，让网络系统自动配置。出于这个目的，DHCP 服务诞生了。 由于没有配置IP地址、网关、DNS 等，在网络上是寸步难行的，因此首先需要从 DHCP 那获得这些。然而，既然连 IP 地址都没有，那又是如何通信的？显然，只能发到广播地址（255.255.255.255）上，而自己则暂时使用无效的IP地址（0.0.0.0）。（事实上，链路层的通信只要有 MAC 地址就行，IP 地址已属于网络层了，但 DHCP 由于某些特殊需要使用的是 UDP 协议） 因为是发往广播，内网环境里的所有用户都能听到。如果存在多个DHCP服务器，则分别予以回复；用户则选择最先收到的。由于规则是如此简单，以至于用户没有选择的余地。 ![](http://fex.baidu.com/img/traffic-hijack/dhcp-broadcast.png) 尚若黑客也在内网里也开启了 DHCP 服务，用户收到的回复包很可能就是黑客发出的，这时用户的网络配置完全听天由命了，不想被劫持都难了。 ![](http://fex.baidu.com/img/traffic-hijack/dhcp-phishing.png) _防范措施_：如果是用网线上网的话，最好还是手动的配置。当然，管理员应该严格控制 DHCP 回复的权限，只允许交换机特定的接口才有资格发送回复包。 只要是这类提问/抢答模式的，都面临被冒充回答的风险。很多原理都类似。 DNS 劫持如同 ARP 将 IP 解析成 MAC 地址 一样，DNS 负责将域名解析成 IP 地址。作为网络层的服务，面对的用户更广泛，当然面临的风险也大的多。一旦遭到入侵，所有用户都倒霉了。近些年的重大网络事故无不和 DNS 有关。 DNS 服务一旦被黑客控制，用户发起的各种域名解析，都将被暗中操控。将正常网站解析成黑客服务器的 IP，并事先开启了 HTTP 代理，用户上网时几乎看不出任何破绽；而黑客则获取到所有访问流量，各种网站账号信息都将一览无余。 ![](http://fex.baidu.com/img/traffic-hijack/dns-hijack.png) 由于 DNS 服务器的重要性，现实中通常有着较高的安全防护，想入侵它系统不是件易事。但实际未必如此兴师动众，一些 DNS 程序本身就存在着设计缺陷，导致黑客能控制某些域名的指向。其中最恶名昭彰的当属 DNS 缓存投毒。 大家或许已发现，域名-&gt;IP-&gt;MAC-&gt;接口，只要是动态查询的就会多一个环节，风险自然增加。灵活性与安全性始终是不可兼得。 _防范措施_：手动设置一些权威的 DNS 服务器，例如 8.8.8.8，4.4.4.4 会靠谱的多。 公网上的 DNS 劫持很少发生，但家用路由器的 DNS 劫持已泛滥成灾了。开头报道的路由器漏洞，最终的利用方式也就是修改了 DNS 地址。 CDN 入侵CDN 能加速大家都知道，但其中原理不少人都不清楚。其实，CDN 本身就是一种 DNS 劫持，只不过是良性的。 不同于黑客强制 DNS 把域名解析到自己的钓鱼 IP 上，CDN 则是让 DNS 主动配合，把域名解析到临近的服务器上。这台服务器同样也开启了 HTTP 代理，让用户感觉不到 CDN 的存在。 不过 CDN 不像黑客那样贪心，劫持用户所有流量，它只『劫持』用户的静态资源访问，对于之前用户访问过的资源，CDN 将直接从本地缓存里反馈给用户，因此速度有了很大的提升。 然而，只要是有缓存的地方，都是大有可为的。一旦 CDN 服务器遭受入侵，硬盘上的缓存文件就岌岌可危了，网页被注入脚本，可执行文件被感染，一大波僵尸即将出现。 ![](http://fex.baidu.com/img/traffic-hijack/cdn-hijack.png) _防范措施_：感觉运营商不靠谱的话，换个第三方不带加速的 DNS，或许就不会解析到 CDN 服务器上了。 不少 CDN 黑白通吃，为了省流量不按套路出牌，超过了缓存时间也不更新，甚至还有忽略 URL 问号后面的，导致程序猿们在资源更新的问题上头疼不已。 路由器弱口令当电脑价格一再下降，到了大家打算买第二台的时候，路由器市场也随之火热起来。 但由于繁琐的配置，差劲的用户体验，至今仍有相当部分的用户不明白如何配置路由器。192.168.1.1 和 admin/admin 几乎成了国内路由器的常量。多少回，用这毫无技术含量的方法进入网吧或图书馆的路由器后台。 如果有人恶搞重启路由，或者给他人限速，你得感谢他的仁慈，这都算不严重。要是把路由器的DNS给改了，那就相当严重了！公网的 DNS 劫持一般不会持续太久，但路由器的 DNS 劫持也许长年累月都不会觉察到。 事实上，不乏一些安全意识强的用户也使用默认密码。理由很简单，目前的路由器有两道门槛：一个 WiFi 连接密码，另一个才是管理密码。很多人设置了复杂的 WiFi 密码就高枕无忧了，心想都连不到我的网络里怎么可能进的了后台？ 之前我也有过这观念，但总觉不对劲：万一家里其他电脑或手机中毒了，自动尝试用弱口令爆进路由器后台怎么办。城门都被占领了，城墙再牢固又有何用。 ![](http://fex.baidu.com/img/traffic-hijack/router-weak-pwd.png) 事实上，黑客除了修改 DNS 配置外，还有更恐怖的行为：升级路由器的固件 —— 替换成一个看似完全相同但植入了恶意程序的固件！尽管这目前还尚未普及，然而一旦流行，大批路由器将成为潘多拉魔盒。 _防范措施_：千万别轻视路由器的密码，其实它比你所有账号都重要。 不改默认密码的用户，神都保佑不了你~ 路由器 CSRF回到本文开始所说的，为什么有那么多路由器会出现这个漏洞呢？也许是路由器的开发人员太高估用户了，认为绝大多数用户都修改了默认密码，因此 CSRF 几乎难以产生。 事实上，国内网民的安全意识远超他们的想象。加上刚才说的，只设置了 WiFi 密码而忽略了管理密码，导致一个恶意程序就能悄悄进入路由器后台。 没想到现在这种病毒还真出现了，而且居然还是 Web 版的！ ![](http://fex.baidu.com/img/traffic-hijack/router-csrf.png) CSRF 漏洞让病毒木马都用不着了。用户直接访问一个网页，甚至是一帖子，浏览器自动向路由器发起修改配置的请求。 由于国产路由器的网页开发是如此的差劲，登录基本都是用既不安全又丑陋的 HTTP 401 弹框。这种登录只需在 URL 里填上『用户名:密码@』即可自动通过，即使登录失败也不会有什么提示。 _防范措施_：绝对要看管好路由器密码，并且定期去检查配置是否被篡改。 看过路由器页面源代码会发现，那简直是惨不忍睹，甚至还是 IE5 时代的风格。路由器芯片都是采购的，内核也有开源的，所谓的『自主研发』就是做了那几个页面？ PPPoE 钓鱼好了，不吐槽路由器了，下面说说再高级的路由器也无法避免的事。 除了一些大公司或学校，用的是固定的专线接入上网，个人或者小组织很少会使用这种土豪级套餐，只能老老实实的拨号上网 —— 无论是电信，还是网通铁通各种通。 不少人都存在误区，认为拨号是物理信号的建立过程，在没有拨上之前，点对点是不通的。如果真是这样，那么拨号时账号密码是如何传过去的呢？显然不可能。事实上，终端之间时刻都是畅通的，只不过不拨号就无法得到IP、网关、会话等参数，即使强制把包发给网关，人家虽能收到，但没有认证的会话是不予理睬的，你自然没法上网。 PPPoE，大家经常在拨号时看到这词。Point-Point Protocol over Ethernet，故名思议，就是点对点的协议：用户发送账号密码认证给终端（BRAS），并得到上网 IP、网关地址、会话等。而且协议是基于以太网的，哪怕线路不是，也得想办法把数据封装进去。 传统的 ADSL 是通过电话线上网的，于是需要一个『猫』来把以太网数据调制成电话信号，最终通过电信交换机传输。这种设备保障每家每户都是独立的，以免电话信号被窃听。 然而，后来兴起的各种通就不一定了。不少打着的『千兆到楼，百兆到家』的宽带，就是建了N个小区局域网，然后合并到一个大的城域网（MAN）里。所谓的『百兆』，无非就是拖进你家的那根网线插在楼下一个 100Mbps 的交换机上而已。 用过网通的都知道，百兆带宽并没有快到哪里，甚至在一些南方地区网速慢如蜗牛。但在下载的时候，却能轻松飙到数兆每秒。这时局域网的作用就发挥出来了，如果附近有多个人在看同样的视频，P2P 就直接在内网里共享流量了，大幅减轻了节点的压力。 但是，整个小区成了一个局域网，是多么的不安全。有时甚至不合理的 VLAN 划分，导致多个小区成一内网。要是有人开启 DHCP 服务，其他用户插上网线就能上网了，连拨号都不用，难道天上掉馅饼了？如果敢吃，那可能就落入黑客的陷阱了。 当然，现在直接插网线的并不多，基本通过路由器自动拨号了。但他们的协议都是一样的 —— PPPoE，一种极不安全的协议。 类似 DHCP 协议，PPPoE 也是通过广播来探寻有哪些可用的终端，意味着整个小区的内网用户都能收到；同时探寻包一直往上冒泡，直到被城域网的终端们收到，然后开始纷纷回应。 ![](http://fex.baidu.com/img/traffic-hijack/pppoe-broadcast.png) 如果小区里有人私自开启一个 PPPoE 终端服务，显然是最先被收到的。真正的回应包还在大街小巷里传递着，用户和黑客已经开始协商认证了。 ![](http://fex.baidu.com/img/traffic-hijack/pppoe-phishing.png) 不过或许你会说，这必须有人拨号才能上钩，现在都用路由器，长年累月不会断开。如果不想耐心等，也有很简单的方法：来一次集体掉线。 刚刚说过，可以用短路的网线，引发一场广播风暴。不过这太过暴力了，甚至会引起流量异常的报警。我们可以使用更简单有效的方法：MAC 欺骗，不停伪造终端服务器的 MAC 地址，就可以将小区用户的数据包统统吸过来了。 PPPoE 使用的是一种隧道方式，将任何数据都封装在其栈下，因此捕捉到用户任意一个包，即可得到 PPPoE 栈上的会话 ID。然后冒充终端，向用户发送一个『断开连接』的指令，用户就乖乖下线了。使用这种方法，分分钟就能让整个小区的用户重新拨一次号，于是可以快速钓鱼了。 还有更糟的是，PPPoE 绝大多数时候都是明文传输用户名和密码的，因此还能额外获得用户发来的认证账号。 前面吐槽了大学寝室楼 1000 多机器还不划 VLAN 的，于是写一个简单的 PPPoE 模拟器，就能轻松抓到整个网络环境里的上网账号。（还支持一键全都拨上，集体下线的恶作剧功能~） ![](http://fex.baidu.com/img/traffic-hijack/pppoe-phishing-demo.png) _防范措施_：由于 PPPoE 的安全严重依赖物理层，所以尽量不要装以太网接入的宽带。当然，管理员们应该严格限制 PPPoE 搜寻回复包，就像 DHCP 那样只允许特定接口出现。事实上小区内部是不可能出现 BRAS 服务器的，因此只允许交换机的 WAN 口出现回复包，那样就不容易被钓鱼了。 PPPoE 还有个更严重 BUG，会话 ID 只有 2 字节，最多 65536 种可能。事先构造个『拨号断开』的请求包，接着把会话 ID 依次遍历一下，就能让某个终端服务器的所有用户下线。如果事先收集好所有终端服务器地址，可以发起一次全城断网- - 这个 BUG 应该早已经修复了，只需绑定 &lt;会话 ID，用户 MAC，小区 VLAN-ID&gt; 关系即可。而且一个小脚本就能断开全城各县市的网络，说明终端部署不能太过集中。 蜜罐代理由于众所周知的原因，某国对代理的需求居高不下。不管黑的白的，透明的还是高匿的，只要能翻出去就是好的。 VPN 需要用户名密码以及各种认证，中途被劫持几乎是不可能的。黑客抓住了人们的纯真的心里，将目光转到代理上面。的确，加密后的数据中途确实难以劫持，但最终仍要在服务端还原出真实内容吧。如果一时大意，连接了某个免费的 VPN，或许就登上了黑客的贼船了。 相比 HTTP 代理只影响部分功能，VPN 将整个系统的流量都通过穿越过去了。而这一切应用程序并不知晓，仍然将一些重要的数据往外发送，最终被黑客所劫持。 ![](http://fex.baidu.com/img/traffic-hijack/honey-proxy.png) _防范措施_：不要贪图小利，用那些打着免费幌子的代理。天下没有免费的午餐。 很多蜜罐代理未必是黑客布下的，而是你懂的。 WiFi 弱口令当互联网延伸到移动设备时，网线成了最大的累赘，无线网络逐渐进入人们视野。如今，由于无线的廉价和便利，几乎应用到所有的便捷设备。一切都不再受限制，人们可以随时随地上网，这是过去难以想象的；黑客也可以随时随地发起攻击，这是过去梦寐以求的。 但无论上网方式如何变化，以太网始终是网络的核心。如同刚才说的 ADSL，尽管载体是电话线路，但最终解调出来的仍是以太网数据。WiFi 也一样，无论电波怎样传播，最终只有还原出标准的以太网封包才能被路由。 无线网络形同一个看不见的巨大集线器，无需任何物理传播介质，附近所有人都可以收听数据信号，专业设备甚至能在更远处捕获。如果没有一种强有力的加密方式把数据封装起来，那么就毫无隐私可言了。 在经历了各种加密被攻破后，WPA2 如今成为无线网络标准加密算法。如果企图通过传统爆后台那样，一次次的尝试弱口令去连接，那效率将是何其的低下。 和拨号不同，WiFi 用户首先需『关联』热点，以建立起物理通道。类似 PPPoE 那样，WiFi 在认证之前也是可以通信的，并且是明文数据 —— 不过，这仅仅是认证数据包明文而已，真正密码显然不会出现在其中。毕竟它和拨号的目的完全不同：一个是为了加密之后所有的流量，而后者仅仅识别下你有没有上网的权限。 通过传统的嗅探工具，可以方便获取这些握手通信包。尽管找不出密码，但里面保存着密钥初始化相关的数据。通过专业的 WPA2 破解工具，加上丰富的密码字典，有相当一部分的无线网络，能在可接受的时间里被破解。 ![](http://fex.baidu.com/img/traffic-hijack/wifi-weak-pwd.png) 对于不少人来说，无线密码是他第一道也是唯一一道防线。连上之后，不出意外即可轻易进入路由器后台，然后就可以控制他整个内网的流量了。 _防范措施_：最简单也是最有效的方法：给密码加些特殊符号。 如果给他的路由器刷一个固件，能自动破解其他的无线网络，破解之后自动进后台，自动给它升级自己的固件。。。排山倒海的路由器木马爆发了。 WiFi 热点钓鱼上面简单的说了无线密码的破解。但若本来就知道密码的情况下，又如何发起入侵呢？ 这种场合很常见，在一些商场、餐厅、旅馆等地方，无线网络即使有密码，大家一般也能在墙上或卡片上找到，处于半公开的状态。或者是破解了邻居的无线密码，但无法进入路由器后台，又该如何继续？ 如今越来越智能的无线设备，已能很好的防御诸如 MAC 欺骗以及 ARP 攻击这类原始入侵了，因此需要一个更先进和隐蔽的方式，能绕过网络设备，直接发起点对点的进攻。 在大公司或大商场上过无线网的用户会发现，在室内无论走到哪里网络都存在，即使从一层到五层信号照样满格，而在自己家中信号隔墙就下降不少。难道是开了信号特别强大的热点吗？但在建筑外面却收不到。事实上，不难发现每层楼天花板上，都吸附着不少盘子似的东西。没错，正是这些分布在各处的设备，覆盖了整栋楼的无线网络，让信号死角变得更少。 但是同时存在那么多热点，搜索列表里显示的却没有几个。因为他们都有着同样的热点名（SSID），客户端通常会将同名热点合并成一个。至于连接时，系统会选择信号最好的那个。如果这些热点的认证方式也是相同的，无论连哪个都没问题。 ![](http://fex.baidu.com/img/traffic-hijack/wifi-ds.png) 仔细揣摩这条特征，不难发现其中大有文章可做 —— 这不天生就为我们钓鱼准备的！我们再开一个同名同认证的伪热点，只要在信号上压倒对方，钓上附近的鱼儿那是妥妥的。 ![](http://fex.baidu.com/img/traffic-hijack/wifi-spoofing.png) 目前几乎还没有哪个客户端对此有防御，无论是商场还是咖啡店，甚至是一些大公司里，对此也束手无策。原因很简单，问题既不出在设备、也不是部署上，更不能归咎与用户。这是整个协议栈的弱点。 发起此攻击的唯一材料，就是一个超大功率的热点，以此来压倒正常的，争做用户『最信赖』的信号源。 其实，每个热点都时时刻刻广播着一种叫 Beacon 的数据包，里面带有热点名等相关的信息。用户网卡收集之后进过筛选分析，即可得知附近有哪些热点，各自信号如何。功率大的热点，用户接收时的信号强度（RSSI）自然也会高一些。 当然，过高的信号源可能会引起一些监控的警觉，自己也被置于巨大的辐射之中。如果仅仅是对某个方位片杀，使用定向天线会有更好的效果。 不过，光有发射能力还是不够的。即使能把 Beacon 推送到数十公里外，让全城都能看见你的热点名，但前来连接的设备可没有那么强劲信号。因此没有一个高灵敏的接收系统，再强的信号也只是一厢情愿罢了。 _防范措施_：因为是底层的缺陷，这种劫持通常很难防护。从理论上说，热点通常是固定着的，因此可以事先记录下每个热点的3D坐标，然后根据 WiFi 定位时刻监控热点位置，如果某个热点信号出现在远离事先的地方，很可能是钓鱼热点发出的假信号。 但在现实中，要同时追踪那么多设备并不容易。除非所有的无线设备，都自带监控附近热点的功能，那样可以节省大量追踪成本。 不过在安全性高的场合，还是使用『接入认证』，连接时要求输入用户名和密码来准入。 用户成功连上 WiFi 后，导致网络状态发生改变，一些系统会尝试请求某个特定的 URL，如果返回的是 HTTP 302，会自动弹出重定向后的网页。目的是为了方便打开网页版的准入，有时连上 CMCC 会自动弹出一个登录网页就是如此。iPhone，iPad，WP 都支持，MacOS 最新版弹出的网页不会执行脚本了。利用这个废功能来弹广告应该很不错~ WiFi 强制断线不得不说 WiFi 的另一个缺陷 —— 被下线。类似 PPPoE 主动或被动断开拨号时都有一个注销包，WiFi 也一样。 之前提到，遍历 PPPoE 的会话ID，冒充所有用户发出注销请求，可以断开全城的网络。WiFi 也有类似的缺陷，只不过正好反过来：冒充热点，向所有用户广播注销包，于是所有连着该热点的用户都下线了。 ![](http://fex.baidu.com/img/traffic-hijack/wifi-deauth.png) 不过，WiFi 的被下线仅仅是认证被注销，用户和热点仍是关联着的。用户接着重新发起认证，因此又给黑客一个获取握手数据的机会。 如果广播持续不断，用户也就一直没法上网，屏幕上会不停的闪烁着『连接中… / 已断开』。对方可能会尝试重启路由，但发现问题仍在，而且所有设备都是这情况，会认为路由器出问题了，于是尝试恢复出厂设置 —— 这一刻，危险降临了！ 照国产路由器的风格，出厂时 WiFi 是没有密码的，而且后台基本是弱口令。因此有个非常短暂的安全缝隙，能钻入这台设备并拿下他的网络！如果事先写好脚本，一旦发现有开放的热点，立即连上并且爆入后台，更是可以直接秒杀！对方刚恢复完路由器，还没回到电脑前就已被劫持了，这是无论如何也想不到的。。。 当然，为了防止他之后进入路由器改密码，你必须立即隐藏 SSID，让 Beacon 不再发出，这样大家都看不见这台设备了，只能通过 BSSID（路由器 MAC 地址）来连接。但是人家会有疑问，刚恢复好的路由器怎么看不见？这时得事先建立一个钓鱼热点，名字和那被隐藏的 SSID 一样，将对方引诱到自己的蜜罐上。 在这个蜜罐里开启一个和路由器页面差不多的站点（可以直接反向代理他路由器的页面），拖住用户，让你有充足的时间来操作那台被隐藏的真设备。甚至可以换掉他固件了！ 当然，有些设备不让轻易更新固件，需要输入路由器上的某个号码，或者按一个键才能开始。这时得发挥蜜罐站点的作用了，你可以在页面上画个文本框，提示他输入路由器上的那号码，或者直接让他去按那按钮。由于路由器后台太过专业，很少会有人质疑它的权威性，几乎都是按部就班。 ![](http://fex.baidu.com/img/traffic-hijack/honey-router.png) 事实上，你的蜜罐一直开着，对方肯定会在里面配置 WiFi 密码和管理密码，以及 PPPoE 账号。于是他的一切上网秘密都被掌控！即使不改他路由器也无所谓了，以后可以随时进入。 _防范措施_：不要轻易恢复路由器的出厂设置。真有必要请务必留神，尽快改掉默认密码。即使周围没有黑客，一些中毒的设备随时可能来连上并爆进后台窜乱。 软硬兼施，这招是不是太阴了？稍微用一点心理学或是社工，原本不怎么严重的漏洞可以扩大很多倍。 WLAN 基站钓鱼前面说的热点钓鱼，只能在特定的场合下进行。劫持KFC的用户，只能在KFC附近；入侵小区的路由，只能在家完成。这极大的限制了攻击范围，完全没有发挥出无线网络的灵活性。 然而有一种网络，无论走到哪都能收到。打开手机，总能看见 CMCC 这类热点如同幽灵一般存在。如今，WLAN 业务已遍地开花，几乎覆盖了全国各地。它支持更高的频段，并向下兼容 WiFi，设备遍布全城，试图打造一个无线城域网。唯一的遗憾是收费的，而且信号也一般，远不如 3G 实用。 有时我们并没有连接这些热点，系统却自动连上了。原因很简单，之前某个时候手贱，去连过它们。而系统会保存主动连过的热点，再次出现时就自动上了。事实上，去连过这些热点的人不在少数。 不用说，你也想到开热点钓鱼了。并且用户几乎都是用 WiFi 来连接，也就没有必要使用 WLAN 设备。使用之前的大功率热点，取个 CMCC 的名字，放在阳台上对着大街，不一会就连上一堆用户了。要是支持虚 AP 的话，把 CMCC-AUTO，ChinaNet 等等这些名字全部用上，前来光临的就更多了。 上面提到了，不少设备连上 WiFi 后能自动弹网页，利用这个特性，钓鱼就更容易了。大多手机系统为了节省流量，当 WiFi 和 3G 同时可用时，会优先使用 WiFi，于是用户的流量不知不觉流到黑客那里。 ![](http://fex.baidu.com/img/traffic-hijack/wlan-phishing.png) 事实上，我们还可以把整套钓鱼方案集成到安卓里。利用手机创建的热点吸引附近的用户，捕捉到的流量还可以通过自己的 3G 网络代理出去。使用 Linux 内核强大的转发机制，我们可以轻易的控制用户的各种流量。以后可别嘲笑街上低头玩手机的人，人家说不定正在劫持你呢。 不过，在一些地方例如地铁上面，3G 信号很差，难以将热点收到的数据转发出去，因此只能钓鱼无法劫持。这种单机模式是否仍能入侵呢？下篇文章将叙述，如何发起离线钓鱼。 _防范措施_：WiFi 不用就应及时关闭，以免自动连上不安全的热点。对于一些长期不用的连接记录，不如趁早删了吧。 安卓热点默认只支持 10 个用户，在街上开个叫 CMCC 的热点，会发现瞬间就连满了。所以还是把笔记本藏书包里，配几个好点的无线网卡，既隐蔽效果也好。大功率天线虽然很过瘾，但不能过度使用，说不定哪天就被查水表了~ 结尾就谈到这里吧，这些只是之前尝试有效的案例，事实上还有太多的途径，要是再算上系统内部的方式那就无数了。但不论如何变化，流量劫持的最终利用方式几乎是如出一辙的 —— 利用它能做些什么呢？终极危害能有多大？请听下回分解。","categories":[{"name":"收藏分享","slug":"收藏分享","permalink":"http://nbma.info/categories/%E6%94%B6%E8%97%8F%E5%88%86%E4%BA%AB/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"}]},{"title":"Html合并单元格","slug":"html-merge-cells","date":"un33fin33","updated":"un66fin66","comments":true,"path":"html-merge-cells/","link":"","permalink":"http://nbma.info/html-merge-cells/","excerpt":"今做简历的时候，需要在html合并单元格，找到了这个： 在Html合并单元格时，使用的属性为: 跨行合并：rowspan, 跨列合并： colspan.","text":"今做简历的时候，需要在html合并单元格，找到了这个： 在Html合并单元格时，使用的属性为: 跨行合并：rowspan, 跨列合并： colspan. 第一部分：rowspan使用方法 1. ： &lt;table border=”2” width=”50%”&gt;&lt;tr&gt;&lt;td rowspan=”2”&gt;AAAAA&lt;/td&gt;&lt;td&gt;BBBBBB&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;CCCCC&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt; AAAAA BBBBBB CCCCC 2\\. ： &lt;table border=”2” width=”50%”&gt;&lt;tr&gt;&lt;td&gt;AAAAA&lt;/td&gt;&lt;td rowspan=”2”&gt;BBBBB&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;CCCCC&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt; AAAAA BBBBB CCCCC &nbsp; 第二部分：colspan使用方法 1. ： &lt;table border=”2” width=”50%”&gt;&lt;tr&gt;&lt;td&gt;AAAAAA&lt;/td&gt;&lt;td&gt;BBBBBB&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td colspan=”2” align=”center”&gt;CCCCC&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt; AAAAAA BBBBBB CCCCC 2\\. ： &lt;table border=”2” width=”50%”&gt;&lt;tr&gt;&lt;td colspan=”2” align=”center”&gt;AAAAAA&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;BBBBBB&lt;/td&gt;&lt;td&gt;CCCCC&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt; AAAAAA BBBBBB CCCCC","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[]},{"title":"CentOS系统DNS不能解析问题","slug":"centos-dns-unresolution","date":"un44fin44","updated":"un66fin66","comments":true,"path":"centos-dns-unresolution/","link":"","permalink":"http://nbma.info/centos-dns-unresolution/","excerpt":"新装一台机器，双网卡，系统为CentOS6.0 ，eth0为内网ip，eth1为公网ip。 放到外地公网上去，ip地址已经设好了。dns也设置成功，保存退出。重启service network restart后发现不能解析了。用ｉｐ地址可以连，但是不能ping www.baidu.com","text":"新装一台机器，双网卡，系统为CentOS6.0 ，eth0为内网ip，eth1为公网ip。 放到外地公网上去，ip地址已经设好了。dns也设置成功，保存退出。重启service network restart后发现不能解析了。用ｉｐ地址可以连，但是不能ping www.baidu.com 总是这样，设置一次可以，过一会或者重启一下服务器，重启一下network都不能解析了。发现/etc/resolv.conf又恢复到原来的状态，里面什么都没有了。手动加入nameserver也不行。 后来到网上查找，发现有人与我同样的问题。原来在CentOS下面直接修改/etc/resolv.conf不行。必须要在/etc/sysconfig/network-scripts/ifcfg-eth0里面最后加上dns的设置。要不然，重启后，肯定使用eth0设置中没有设dns的相关信息，使/etc/resolv.conf恢复到原来的状态。 打开/etc/sysconfig/network-scripts/ifcfg-eth0，为了保险起见，可以同样修改eth1的设置 这样设置后，/etc/resolv.conf里面根本就不需要设置。service network restart 后，可以发现/etc/resolv.conf里面就有两个dns的解析ip了。配置好以后重启网络，cat /etc/resolv.conf，可以看到如下参数：DEVICE=eth0BOOTPROTO=noneHWADDR=00:xx:19:xx:xx:xxONBOOT=yesTYPE=EthernetUSERCTL=noIPV6INIT=noPEERDNS=yesNETMASK=255.255.255.0IPADDR=xxx.xxx.xxx.xxxGATEWAY=xxx.xxx.xxx.xxxDNS1=8.8.8.8 nameserver 202.96.209.5nameserver 202.96.209.133search localdomain DNS解析设置成功。在此要强调一点的是，直接修改/etc/resolv.conf这个文件是没用的，网络服务重启以后会根据/etc/sysconfig/network-scripts/ifcfg-eth0来重载配置，如果ifcfg-eth0没有配置DNS，那么resolv.conf会被冲掉，重新变成空值。","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"centos","slug":"centos","permalink":"http://nbma.info/tags/centos/"}]},{"title":"练习 5.6.1:Packet Tracer 综合技能练习（访问控制列表）","slug":"packet-tracer-acl","date":"un55fin55","updated":"un55fin55","comments":true,"path":"packet-tracer-acl/","link":"","permalink":"http://nbma.info/packet-tracer-acl/","excerpt":"","text":"地址表 简介 在本练习中，您需要演练配置实施五项安全策略的 ACL 的技能。此外，您还要配置 PPP 和 OSPF 路由。设备已配置了 IP 地址。用户执行口令是 cisco，特权执行口令是 class。 任务 1：配置带有 CHAP 身份验证的 PPP步骤 1. 将 HQ 和 B1 之间的链路配置为使用带有 CHAP 身份验证的 PPP 封装。 CHAP 身份验证的口令是 cisco123。 B1: username HQ password cisco123 interface Serial0/0/0encapsulation pppppp authentication chap HQ: username B1 password 0 cisco123 interface Serial0/0/0encapsulation pppppp authentication chap 步骤 2. 将 HQ 和 B2 之间的链路配置为使用带有 CHAP 身份验证的 PPP 封装。 CHAP 身份验证的口令是 cisco123。 B2: username HQ password 0 cisco123 interface Serial0/0/0encapsulation pppppp authentication chap HQ: username B2 password 0 cisco123 interface Serial0/0/1encapsulation pppppp authentication chap 步骤 3. 检查路由器之间是否已恢复连通性。 HQ 应能 ping 通 B1 和 B2。接口恢复可能需要几分钟。在 Realtime（实时）模式和 Simulation（模拟）模式之间来回切换可加快此过程。要让 Packet Tracer 加快此过程，另一种可行的方法是对接口使用 shutdown 和 no shutdown 命令。 注：由于 Packet Tracer 程序缺陷，接口可能会在练习期间的任何时候随机关闭。请等待几秒钟，通常接口会自行重新打开。 步骤 4. 检查结果。 完成比例应为 29%。如果并非如此，请单击 Check Results（检查结果）查看尚未完成哪些必要部分。 任务 2：配置默认路由步骤 1. 配置从 HQ 到 ISP 的默认路由。 在 HQ 上使用_送出接口_参数配置默认路由，将所有默认流量发送到 ISP。 ip route 0.0.0.0 0.0.0.0 Serial0/1/0 步骤 2. 测试与 Web Server 的连通性。 从 HQ 的 Serial0/1/0 接口发出 ping。HQ 应该能成功 ping 通 Web Server (209.165.202.130)。 步骤 3. 检查结果。 完成比例应为 32%。如果并非如此，请单击 Check Results（检查结果）查看尚未完成哪些必要部分。 任务 3：配置 OSPF 路由步骤 1. 在 HQ 上配置 OSPF。 使用进程 ID 1 配置 OSPF。 通告除 209.165.201.0 网络外的所有子网。 向 OSPF 相邻设备传播默认路由。 在接入 ISP 和接入 HQ LAN 的接口上禁用 OSPF 更新。HQ: router ospf 1passive-interface FastEthernet0/0passive-interface FastEthernet0/1passive-interface Serial0/1/0network 10.1.50.0 0.0.0.255 area 0network 10.1.40.0 0.0.0.255 area 0network 10.1.1.0 0.0.0.3 area 0network 10.1.1.4 0.0.0.3 area 0default-information originate 步骤 2. 在 B1 和 B2 上配置 OSPF。 使用进程 ID 1 配置 OSPF。 在每台路由器上配置适当的子网。 在接入 LAN 的接口上禁用 OSPF 更新。B1: router ospf 1passive-interface FastEthernet0/0passive-interface FastEthernet0/1network 10.1.1.0 0.0.0.3 area 0network 10.1.10.0 0.0.0.255 area 0network 10.1.20.0 0.0.0.255 area 0 B2: router ospf 1passive-interface FastEthernet0/0passive-interface FastEthernet0/1network 10.1.1.4 0.0.0.3 area 0network 10.1.70.0 0.0.0.255 area 0network 10.1.80.0 0.0.0.255 area 0 步骤 3. 测试整个网络的连通性。 现在，网络应该实现了完全的端到端连通性。所有设备均应能够成功 ping 通所有其它设备，包括地址为 209.165.202.130 的 Web Server。 步骤 4. 检查结果。 完成比例应为 76%。如果并非如此，请单击 Check Results（检查结果）查看尚未完成哪些必要部分。 任务 4：实施多项 ACL 安全策略步骤 1. 实施第一项安全策略。 阻止 10.1.10.0 网络访问 10.1.40.0 网络。允许对 10.1.40.0 的所有其它访问。在 HQ 上使用 ACL 编号 10 配置 ACL。 HQ:access-list 10 deny 10.1.10.0 0.0.0.255access-list 10 permit any interface FastEthernet0/1ip access-group 10 out 步骤 2. 检查第一项安全策略是否已实现。 从 PC5 ping PC1 应该失败。 步骤 3. 检查结果。 完成比例应为 80%。如果并非如此，请单击 Check Results（检查结果）查看尚未完成哪些必要部分。 步骤 4. 实施第二项安全策略。 拒绝主机 10.1.10.5 访问主机 10.1.50.7。允许所有其它主机访问 10.1.50.7。在 B1 上使用 ACL 编号 115 配置 ACL。 B1: access-list 115 deny ip host 10.1.10.5 host 10.1.50.7access-list 115 permit ip any any interface FastEthernet0/0ip access-group 115 in 步骤 5. 检查第二项安全策略是否已实现。 从 PC5 ping PC3 应该失败。 步骤 6. 检查结果。 完成比例应为 85%。如果并非如此，请单击 Check Results（检查结果）查看尚未完成哪些必要部分。 步骤 7. 实施第三项安全策略。 拒绝从 10.1.50.1 到 10.1.50.63 的主机通过 Web 访问地址为 10.1.80.16 的内部网服务器。允许所有其它访问。在适当的路由器上使用 ACL 编号 101 配置 ACL。 HQ: access-list 101 deny tcp 10.1.50.0 0.0.0.63 host 10.1.80.16 eq wwwaccess-list 101 permit ip any any interface FastEthernet0/0ip access-group 101 in 步骤 8. 检查第三项安全策略是否已实现。 要测试此策略，请单击 PC3，然后单击 Desktop（桌面）选项卡，再单击Web Browser（Web 浏览器）。URL 应键入内部网服务器的 IP 地址 10.1.80.16，然后按 Enter。几秒后应收到 Request Timeout（请求超时）消息。PC2 和该网络中的所有其它 PC 都应该能够访问内部网服务器。 步骤 9. 检查结果。 完成比例应为 90%。如果并非如此，请单击 Check Results（检查结果）查看尚未完成哪些必要部分。 步骤 10. 实施第四项安全策略。 使用名称 NO_FTP 配置命名 ACL，阻止 10.1.70.0/24 网络访问文件服务器 (10.1.10.2) 上的 FTP 服务（端口 21）。所有其它访问都应允许。 注意：名称区分大小写。 B2: ip access-list extended NO_FTPdeny tcp 10.1.70.0 0.0.0.255 host 10.1.10.2 eq ftppermit ip any any interface FastEthernet0/1ip access-group NO_FTP in 步骤 11. 检查结果。 Packet Tracer 不支持测试 FTP 访问，因此您无法检验此策略。不过，完成比例应为 95%。如果并非如此，请单击 Check Results（检查结果）查看尚未完成哪些必要部分。 步骤 12. 实施第五项安全策略。 由于 ISP 代表与 Internet 之间的连通性，因此请按照下列顺序配置名为FIREWALL 的命名 ACL： 仅允许来自 ISP 和来自 ISP 之外任何源地址的入站 ping 应答。 仅允许来自 ISP 和来自 ISP 之外任何源地址的已建立 TCP 会话。 明确阻止来自 ISP 和来自 ISP 之外任何源地址的所有其它入站访问HQ:ip access-list extended FIREWALLpermit icmp any any echo-replypermit tcp any any establisheddeny ip any any interface Serial0/1/0description Link to ISPip access-group FIREWALL in步骤 13. 检查第五项安全策略是否已实现。此策略的测试结果应该是任何 PC 都能 ping 通 ISP 或 Web Server。但 ISP 和 Web Server 应该都无法 ping 通 HQ 或 FIREWALL ACL 后的任何其它设备。","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"cisco","slug":"cisco","permalink":"http://nbma.info/tags/cisco/"}]},{"title":"网关冗余（HSRP）","slug":"packet-tracer-hsrp","date":"un11fin11","updated":"un66fin66","comments":true,"path":"packet-tracer-hsrp/","link":"","permalink":"http://nbma.info/packet-tracer-hsrp/","excerpt":"最近学习cisco技术，看到一个网关冗余的实验挺不错了，自己做了一遍，成功完成实验，下面给大家分享一下","text":"最近学习cisco技术，看到一个网关冗余的实验挺不错了，自己做了一遍，成功完成实验，下面给大家分享一下 实验拓扑： 实验配置： 路由器配置**===========R1===========**Router&gt;enRouter#conf tRouter(config)#enable secret ciscoRouter(config)#int f0/0Router(config-if)#ip address 192.168.13.1 255.255.255.0Router(config-if)#no shutRouter(config-if)#exitRouter(config)#int s1/0Router(config-if)#ip address 192.168.12.1 255.255.255.0Router(config-if)#clock rate 64000Router(config-if)#no shutRouter(config-if)#exitRouter(config)#router ripRouter(config-router)#network 192.168.13.0Router(config-router)#network 192.168.12.0Router(config-router)#passive-interface f0/0 //设为被动接口Router(config-router)#exitRouter(config)#exitRouter#Router(config-if)#standby 1 ip 192.168.13.254 //启用 HSRP 功能，并设置虚拟IP ，组号为 1Router(config-if)#standby 1 preempt //设置该路由器在优先级最高时成为活动路由器。如果不设置，即使该路由器权值再高，也不会成为活动路由器Router(config-if)#standby 1 priority 120 //设置优先级，默认为100Router(config-if)#standby 1 timers 3 10 //设置Hello time 和 Hold time ，即每隔3秒发Hello包，超过10秒没收到Hello宣告该路由器故障Router(config-if)#standby 1 authentication cisco //配置认证密码，防止非法设备加入到HSRP中，同一组密码必须一致Router(config-if)#exitRouter(config)#exitRouter#Router#conf tRouter(config)#hostname R1R1(config)#exitR1#show ip routeCodes: C - connected, S - static, I - IGRP, R - RIP, M - mobile, B - BGPD - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter areaN1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2E1 - OSPF external type 1, E2 - OSPF external type 2, E - EGPi - IS-IS, su - IS-IS summary, L1 - IS-IS level-1, L2 - IS-IS level-2ia - IS-IS inter area, * - candidate default, U - per-user static routeo - ODR, P - periodic downloaded static routeGateway of last resort is not setC 192.168.12.0/24 is directly connected, Serial1/0C 192.168.13.0/24 is directly connected, FastEthernet0/0R 192.168.20.0/24 [120/1] via 192.168.12.2, 00:00:28, Serial1/0R 192.168.23.0/24 [120/1] via 192.168.12.2, 00:00:28, Serial1/0R1# =============R2=============Router&gt;enRouter#conf tRouter(config)#enable secret ciscoRouter(config)#int s1/0Router(config-if)#ip address 192.168.12.2 255.255.255.0Router(config-if)#clock rate 64000Router(config-if)#no shutRouter(config-if)#exitRouter(config)#Router(config)#router ripRouter(config-router)#network 192.168.12.0Router(config-router)#network 192.168.23.0Router(config-router)#network 192.168.20.0Router(config-router)#passive-interface f0/0Router(config-router)#exitRouter(config)#int s1/1Router(config-if)#ip address 192.168.23.2 255.255.255.0Router(config-if)#clock rate 64000Router(config-if)#no shutRouter(config-if)#exitRouter(config)#int f0/0Router(config-if)#ip address 192.168.20.2 255.255.255.0Router(config-if)#exitRouter(config)#exitRouter#Router#conf tRouter(config)#hostname R2R2(config)#exitR2# =============R3=============Router&gt;enRouter#conf tRouter(config)#enable secret ciscoRouter(config)#int f0/0Router(config-if)#ip address 192.168.13.3 255.255.255.0Router(config-if)#no shutRouter(config-if)#exitRouter(config)#int s1/1Router(config-if)#ip address 192.168.23.3 255.255.255.0Router(config-if)#clock rate 64000Router(config-if)#no shutRouter(config-if)#exitRouter(config)#router ripRouter(config-router)#network 192.168.13.0Router(config-router)#network 192.168.23.0Router(config-router)#passive-interface f0/0Router(config-router)#exitRouter(config)#exitRouter#Router#conf tRouter(config)#int f0/0Router(config-if)#standby 1 ?authentication Authenticationip Enable HSRP and set the virtual IP addressmac-address Virtual MAC addressname Redundancy name stringpreempt Overthrow lower priority Active routerspriority Priority leveltimers Hello and hold timerstrack Priority tracking Router(config-if)#standby 1 ip 192.168.13.254Router(config-if)#standby 1 preemptRouter(config-if)#standby 1 timers 3 10Router(config-if)#standby 1 authentication ciscoRouter(config-if)#exitRouter(config)#exitRouter#confRouter(config)#hostname R3R3(config)#exitR3# PC 配置 =============R12 和 R11 当PC使用R12&gt;enR12#conf tR12(config)#hostname PC12PC12(config)#no ip routingPC12(config)#int f0PC12(config-if)#ip address 192.168.13.100 255.255.255.0PC12(config-if)#no shutPC12(config-if)#exitPC12(config)#ip default-gateway 192.168.13.254 //.254是虚拟网关 R11&gt;enR11#conf tR11(config)#hostname PC11PC11(config)#no ip routingPC11(config)#int f0PC11(config-if)#ip address 192.168.20.100 255.255.255.0PC11(config-if)#no shutPC11(config-if)#exitPC11(config)#ip default-gateway 192.168.20.2 测试:ping (分别断开到R1和到R3的线路 下图可以看出自动就跳到另一条) PC12#ping 192.168.20.100 repeat 500Type escape sequence to abort.Sending 500, 100-byte ICMP Echos to 192.168.20.100, timeout is 2 seconds:!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!.!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!…..!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!………….…..!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!Success rate is 94 percent (473/500), round-trip min/avg/max = 16/80/424 msPC12# traceroute 测试PC12#traceroute 192.168.20.100 *//到R1和R3的线路都正常时**Type escape sequence to abort.Tracing the route to 192.168.20.1001 192.168.13.1 456 msec 312 msec 284 msec2 192.168.12.2 528 msec 888 msec *3 * *192.168.20.100 632 msecPC12#traceroute 192.168.20.100 *//断开R1后测试结果*Type escape sequence to abort.Tracing the route to 192.168.20.1001 192.168.13.3 368 msec 272 msec 228 msec2 192.168.23.2 488 msec 1084 msec 1048 msec3 192.168.20.100 928 msec * 556 msecPC12#traceroute 192.168.20.100 *//断开R3后测试结果**Type escape sequence to abort.Tracing the route to 192.168.20.1001 192.168.13.1 372 msec 928 msec 1552 msec2 *192.168.12.2 1604 msec 576 msec3 * * *4 *192.168.20.100 772 msec 668 msecPC12#","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"cisco","slug":"cisco","permalink":"http://nbma.info/tags/cisco/"}]},{"title":"配置静态路由的下一跳使用出站接口和下一跳IP的差别","slug":"compare-next-hop","date":"un33fin33","updated":"un66fin66","comments":true,"path":"compare-next-hop/","link":"","permalink":"http://nbma.info/compare-next-hop/","excerpt":"配置静态路由的下一跳使用出站接口和下一跳IP的差别 在配置静态路由时，下一跳可以使用下一路由器的IP地址，也可以使用本路由器的出站接口。在点对点的网络中，两者可能没有什么差别，但在以太网中，两者有很大差别。","text":"配置静态路由的下一跳使用出站接口和下一跳IP的差别 在配置静态路由时，下一跳可以使用下一路由器的IP地址，也可以使用本路由器的出站接口。在点对点的网络中，两者可能没有什么差别，但在以太网中，两者有很大差别。 在以太网中，两个相邻接口之间的通信是依靠MAC地址。相邻接口通信时，需要知道对方的MAC地址，根据MAC地址，将通信数据转换成数据帧后交付给网络，进而到对方。而对方MAC地址的获得，是通过第二层数据帧广播，由ARP协议完成的。 当静态路由中使用出站接口做为下一跳时，路由器会认为目标网络和接口处在“直连网络”中。看下图的拓扑： &nbsp; 在路由器R1中的静态路由为 ip route 192.168.2.0 255.255.255.0 fastethernet0/1 时，R1就认为192.168.2.0/24网络和自己直连。可以在R1中使用 show ip route 命令看出，如下图示： &nbsp; &nbsp; 在以太网中，直连网络中主机间的通信是通过ARP协议广播来获取到要交付的目标主机的MAC地址的。也就是说，当R1左侧网络中的PC1要和R2右侧网络的PC2和PC3通信时，数据传递到R1时，R1看到目标网络是自己的直连网络（由于静态路由中指定下一跳为自身接口所致），于是R1就要在F0/1所处网络发出ARP请求广播，来寻找192.168.2.11/12对应的MAC地址。 这时，如果R2启用了ARP代理，那么R2将代替PC2和PC3应答此ARP请求，也就是说返回给R1：192.168.2.11和12对应的MAC地址是R2的F0/1接口MAC。这样，R1中将产生两条ARP缓存记录，分别为： 192.168.2.11 R2的F0/1的MAC 192.168.2.12 R2的F0/1的MAC 在PC1上分别PING 192.168.11和12，然后在R1上使用show arp命令查看到的结果如下图示： &nbsp; c803.0f8c.0001正是R2的F0/1接口的MAC。 当R2中没有启用ARP代理时，PC1和PC2、PC3将不能正常通信。 从上述实验中我们知道，当R1中使用F0/1接口做为到达目标网络192.168.2.0/24的下一跳时，R1左侧网络中的PC，如果要和R2右侧的192.168.2.0/24网络中的所有PC通信，那么在R1上均会产生ARP缓存记录。可以想象：当双方通信的PC很多时，R1中势必会产生大量的ARP缓存，从而可能会导致R1的内存被耗尽。 如果R1中到192.168.2.0/24网络的静态路由设置为 ip route 192.168.2.0 255.255.255.0 10.0.0.2，这样的话，R1中到192.168.2.0/24网络的数据包，都只会交付给10.0.0.2。R1通过ARP协议来获取10.0.0.2对应的MAC地址，然后将数据包以第二层数据帧方式交付出去。也就是说，R1上只会保留一条ARP缓存信息，即：10.0.0.2 R2的F0/1的MAC。这样可以避免R1中产生大量ARP缓存而导致内存耗尽。 &nbsp;","categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"}],"tags":[{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"}]}],"categories":[{"name":"技术笔记","slug":"技术笔记","permalink":"http://nbma.info/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"},{"name":"收藏分享","slug":"收藏分享","permalink":"http://nbma.info/categories/%E6%94%B6%E8%97%8F%E5%88%86%E4%BA%AB/"}],"tags":[{"name":"ip","slug":"ip","permalink":"http://nbma.info/tags/ip/"},{"name":"network","slug":"network","permalink":"http://nbma.info/tags/network/"},{"name":"SSLVPN","slug":"SSLVPN","permalink":"http://nbma.info/tags/SSLVPN/"},{"name":"cisco","slug":"cisco","permalink":"http://nbma.info/tags/cisco/"},{"name":"centos","slug":"centos","permalink":"http://nbma.info/tags/centos/"},{"name":"monitor","slug":"monitor","permalink":"http://nbma.info/tags/monitor/"},{"name":"zabbix","slug":"zabbix","permalink":"http://nbma.info/tags/zabbix/"},{"name":"ansible","slug":"ansible","permalink":"http://nbma.info/tags/ansible/"},{"name":"nat","slug":"nat","permalink":"http://nbma.info/tags/nat/"},{"name":"SLA","slug":"SLA","permalink":"http://nbma.info/tags/SLA/"},{"name":"QoS","slug":"QoS","permalink":"http://nbma.info/tags/QoS/"},{"name":"ospf","slug":"ospf","permalink":"http://nbma.info/tags/ospf/"},{"name":"oxidized","slug":"oxidized","permalink":"http://nbma.info/tags/oxidized/"},{"name":"docker","slug":"docker","permalink":"http://nbma.info/tags/docker/"},{"name":"snmp","slug":"snmp","permalink":"http://nbma.info/tags/snmp/"},{"name":"asa","slug":"asa","permalink":"http://nbma.info/tags/asa/"},{"name":"elk","slug":"elk","permalink":"http://nbma.info/tags/elk/"},{"name":"mysql","slug":"mysql","permalink":"http://nbma.info/tags/mysql/"},{"name":"nfs","slug":"nfs","permalink":"http://nbma.info/tags/nfs/"},{"name":"ipsec","slug":"ipsec","permalink":"http://nbma.info/tags/ipsec/"},{"name":"EZVPN","slug":"EZVPN","permalink":"http://nbma.info/tags/EZVPN/"},{"name":"GETVPN","slug":"GETVPN","permalink":"http://nbma.info/tags/GETVPN/"},{"name":"https","slug":"https","permalink":"http://nbma.info/tags/https/"},{"name":"nginx","slug":"nginx","permalink":"http://nbma.info/tags/nginx/"},{"name":"802.1x","slug":"802-1x","permalink":"http://nbma.info/tags/802-1x/"},{"name":"bgp","slug":"bgp","permalink":"http://nbma.info/tags/bgp/"},{"name":"eigrp","slug":"eigrp","permalink":"http://nbma.info/tags/eigrp/"}]}